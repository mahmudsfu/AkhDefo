<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>akhdefo_functions.Akhdefo_Tools &#8212; AkhDefo Software 2.2.66 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../_static/flask.css?v=b87c8d14" />
    <script src="../../_static/documentation_options.js?v=e2ab9622"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Akhdefo</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">akhdefo_functions.Akhdefo_Tools</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for akhdefo_functions.Akhdefo_Tools</h1><div class="highlight"><pre>
<span></span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">rasterio</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">from</span> <span class="nn">rasterio.mask</span> <span class="kn">import</span> <span class="n">mask</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">rasterio.warp</span> <span class="kn">import</span> <span class="n">reproject</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<div class="viewcode-block" id="resample_raster">
<a class="viewcode-back" href="../../akhdefo_functions.html#akhdefo_functions.Akhdefo_Tools.resample_raster">[docs]</a>
<span class="k">def</span> <span class="nf">resample_raster</span><span class="p">(</span><span class="n">src_array</span><span class="p">,</span> <span class="n">src_transform</span><span class="p">,</span> <span class="n">src_crs</span><span class="p">,</span> <span class="n">dst_transform</span><span class="p">,</span> <span class="n">dst_crs</span><span class="p">,</span> <span class="n">dst_shape</span><span class="p">,</span> <span class="n">resampling_method</span><span class="o">=</span><span class="n">rasterio</span><span class="o">.</span><span class="n">enums</span><span class="o">.</span><span class="n">Resampling</span><span class="o">.</span><span class="n">nearest</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Resample the source raster array to match the destination raster&#39;s resolution and extent.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    - src_array: 2D numpy array of the source raster</span>
<span class="sd">    - src_transform: affine.Affine transform of the source raster</span>
<span class="sd">    - src_crs: CRS of the source raster</span>
<span class="sd">    - dst_transform: affine.Affine transform of the destination raster</span>
<span class="sd">    - dst_crs: CRS of the destination raster</span>
<span class="sd">    - dst_shape: Shape of the destination raster (height, width)</span>
<span class="sd">    - resampling_method: rasterio.enums.Resampling method to use for resampling</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    - resampled_array: 2D numpy array of the resampled source raster</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Create an empty array with the destination shape</span>
    <span class="n">resampled_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">dst_shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    
    <span class="c1"># Define the source and destination transformations and arrays for reproject</span>
    <span class="n">reproject</span><span class="p">(</span>
        <span class="n">source</span><span class="o">=</span><span class="n">src_array</span><span class="p">,</span>
        <span class="n">destination</span><span class="o">=</span><span class="n">resampled_array</span><span class="p">,</span>
        <span class="n">src_transform</span><span class="o">=</span><span class="n">src_transform</span><span class="p">,</span>
        <span class="n">src_crs</span><span class="o">=</span><span class="n">src_crs</span><span class="p">,</span>
        <span class="n">dst_transform</span><span class="o">=</span><span class="n">dst_transform</span><span class="p">,</span>
        <span class="n">dst_crs</span><span class="o">=</span><span class="n">dst_crs</span><span class="p">,</span>
        <span class="n">resampling</span><span class="o">=</span><span class="n">resampling_method</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">resampled_array</span></div>




<div class="viewcode-block" id="scatter_area_mask">
<a class="viewcode-back" href="../../akhdefo_functions.html#akhdefo_functions.Akhdefo_Tools.scatter_area_mask">[docs]</a>
<span class="k">def</span> <span class="nf">scatter_area_mask</span><span class="p">(</span><span class="n">input_folder</span><span class="p">,</span> <span class="n">output_folder</span><span class="p">,</span> <span class="n">plot_folder</span><span class="p">,</span> <span class="n">shapefile_path</span><span class="p">,</span> <span class="n">scatter_Area_threshold</span><span class="o">=</span><span class="mf">1.1</span><span class="p">,</span> <span class="n">vegetation_mask_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create an accumulated scatter area mask from a set of raster images based on a given threshold. the input dataset is taken from ASF RTC processing.</span>
<span class="sd">    The scattering area for each pixel in the RTC image in square meters. The values are calculated based on the effectively illuminated gamma-0 terrain surface using a digital elevation model, </span>
<span class="sd">    the local incidence angle map, and the layover-shadow map. see detailes at the following website https://hyp3-docs.asf.alaska.edu/guides/rtc_product_guide/#scattering-area-map</span>

<span class="sd">    The function processes each raster image in the input folder, crops it based on the provided AOI</span>
<span class="sd">    from the shapefile, normalizes the cropped raster, and then converts the normalized image to a binary</span>
<span class="sd">    mask based on the scatter_percentageArea_threshold. The binary masks from each raster are then accumulated</span>
<span class="sd">    to generate the final scatter area mask.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    input_folder : str</span>
<span class="sd">        Path to the folder containing raster files to be processed.</span>
<span class="sd">    </span>
<span class="sd">    output_folder : str</span>
<span class="sd">        Directory where the final accumulated mask raster file will be saved.</span>
<span class="sd">    </span>
<span class="sd">    plot_folder : str</span>
<span class="sd">        Directory where the visual representation (plot) of the accumulated mask will be saved.</span>
<span class="sd">    </span>
<span class="sd">    shapefile_path : str</span>
<span class="sd">        Path to the shapefile containing the Area of Interest (AOI) for cropping the raster images.</span>
<span class="sd">    </span>
<span class="sd">    scatter_Area_threshold : float, optional (default=10) unit is perentage  square </span>
<span class="sd">        Threshold for determining the binary mask from the normalized raster image. Pixels with values </span>
<span class="sd">        less than this threshold are set to 0 and those above are set to 1.</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    Shadow Mask for SAR image for sites less likey to have quality measurment points.</span>
<span class="sd">    The results are saved as files in the specified output and plot directories.</span>

<span class="sd">    Notes:</span>
<span class="sd">    ------</span>
<span class="sd">    - Assumes that there is only one geometry in the provided shapefile.</span>
<span class="sd">    - The accumulated mask is a result of multiplying binary masks from each raster. Therefore, a pixel in </span>
<span class="sd">      the accumulated mask will have a value of 1 only if all rasters have a value of 1 at that pixel location.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Ensure the output and plot folders exist</span>
    <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="p">[</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">plot_folder</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>

    <span class="c1"># Read the AOI from the shapefile</span>
    <span class="n">aoi_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">shapefile_path</span><span class="p">)</span>
    <span class="n">geometry</span> <span class="o">=</span> <span class="n">aoi_gdf</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Assuming only one geometry in the shapefile</span>

    <span class="n">accumulated_mask</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># This will store the final aggregated mask</span>

    <span class="c1"># Process each raster</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">input_folder</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.tif&quot;</span><span class="p">):</span>
            <span class="n">input_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            
            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
                <span class="c1"># Crop raster based on AOI</span>
                <span class="n">cropped_image</span><span class="p">,</span> <span class="n">cropped_transform</span> <span class="o">=</span> <span class="n">mask</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="p">[</span><span class="n">geometry</span><span class="p">],</span> <span class="n">crop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">cropped_image</span> <span class="o">=</span> <span class="n">cropped_image</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># As it returns in (bands, row, col) format</span>
                
                <span class="c1"># Normalize the image</span>
                <span class="n">min_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">cropped_image</span><span class="p">)</span>
                <span class="n">max_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">cropped_image</span><span class="p">)</span>
                
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;min_initial: &#39;</span><span class="p">,</span> <span class="n">min_val</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;max_initial: &#39;</span> <span class="p">,</span> <span class="n">max_val</span><span class="p">)</span>
                <span class="n">normalized_image</span> <span class="o">=</span> <span class="p">(</span><span class="n">cropped_image</span> <span class="o">-</span> <span class="n">min_val</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">max_val</span> <span class="o">-</span> <span class="n">min_val</span><span class="p">)</span> <span class="o">*</span><span class="mi">100</span>
                
                 <span class="c1"># Normalize the image</span>
                <span class="n">min_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">normalized_image</span><span class="p">)</span>
                <span class="n">max_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">normalized_image</span><span class="p">)</span>
                
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;min_normalized: &#39;</span><span class="p">,</span> <span class="n">min_val</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;max_normalized: &#39;</span> <span class="p">,</span> <span class="n">max_val</span><span class="p">)</span>
                
                <span class="c1"># Convert the normalized image to binary</span>
                
                <span class="n">binary_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">normalized_image</span> <span class="o">&lt;</span> <span class="n">scatter_Area_threshold</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">rasterio</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

                <span class="c1"># Accumulate the mask</span>
                <span class="k">if</span> <span class="n">accumulated_mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">accumulated_mask</span> <span class="o">=</span> <span class="n">binary_image</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">accumulated_mask</span> <span class="o">*=</span> <span class="n">binary_image</span>

    <span class="c1"># Save the final accumulated mask</span>
    <span class="n">meta</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
        <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span>
        <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">accumulated_mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="n">accumulated_mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="s1">&#39;transform&#39;</span><span class="p">:</span> <span class="n">cropped_transform</span>
    <span class="p">})</span>

    <span class="k">if</span> <span class="n">vegetation_mask_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vegetation_mask_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="n">vegi_mask</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">vegi_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">vegi_mask</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">rasterio</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
            <span class="n">vegi_transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span>
            <span class="n">vegi_crs</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span>

        <span class="c1"># Resample vegi_mask to match accumulated_mask</span>
        <span class="n">resampled_vegi_mask</span> <span class="o">=</span> <span class="n">resample_raster</span><span class="p">(</span>
            <span class="n">src_array</span><span class="o">=</span><span class="n">vegi_mask</span><span class="p">,</span>
            <span class="n">src_transform</span><span class="o">=</span><span class="n">vegi_transform</span><span class="p">,</span>
            <span class="n">src_crs</span><span class="o">=</span><span class="n">vegi_crs</span><span class="p">,</span>
            <span class="n">dst_transform</span><span class="o">=</span><span class="n">cropped_transform</span><span class="p">,</span>  <span class="c1"># This should be the transform of accumulated_mask</span>
            <span class="n">dst_crs</span><span class="o">=</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;crs&#39;</span><span class="p">],</span>  <span class="c1"># This should be the CRS of accumulated_mask</span>
            <span class="n">dst_shape</span><span class="o">=</span><span class="n">accumulated_mask</span><span class="o">.</span><span class="n">shape</span>
        <span class="p">)</span>

        <span class="n">combined_mask</span><span class="o">=</span><span class="n">resampled_vegi_mask</span><span class="o">+</span> <span class="n">accumulated_mask</span>
        <span class="n">combined_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">resampled_vegi_mask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">rasterio</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">accumulated_mask</span> <span class="o">=</span> <span class="n">combined_mask</span>
        
        <span class="c1"># Plot and save the final accumulated mask</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">accumulated_mask</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plot_folder</span><span class="p">,</span> <span class="s2">&quot;SAR_scatterArea_Vegetation_masks.png&quot;</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        
        
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">&quot;SAR_scatterArea_Vegetation_masks.tif&quot;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">meta</span><span class="p">)</span> <span class="k">as</span> <span class="n">dest</span><span class="p">:</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">accumulated_mask</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">&quot;SAR_scatterArea_mask.tif&quot;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">meta</span><span class="p">)</span> <span class="k">as</span> <span class="n">dest</span><span class="p">:</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">accumulated_mask</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Plot and save the final accumulated mask</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">accumulated_mask</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plot_folder</span><span class="p">,</span> <span class="s2">&quot;SAR_scatterArea_mask.png&quot;</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

        


<div class="viewcode-block" id="utm_to_latlon">
<a class="viewcode-back" href="../../akhdefo_functions.html#akhdefo_functions.Akhdefo_Tools.utm_to_latlon">[docs]</a>
<span class="k">def</span> <span class="nf">utm_to_latlon</span><span class="p">(</span><span class="n">easting</span><span class="p">,</span> <span class="n">northing</span><span class="p">,</span> <span class="n">zone_number</span><span class="p">,</span> <span class="n">zone_letter</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This program converts geographic projection of shapefiles from UTM to LATLONG</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    easting: Geopandas column with Easting </span>
<span class="sd">    </span>
<span class="sd">    northing: Geopandas column with Northing</span>
<span class="sd">    </span>
<span class="sd">    zone_number: int</span>
<span class="sd">    </span>
<span class="sd">    zone_letter: &quot;N&quot; or &quot;S&quot;</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    [lon , lat ]: List</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
    <span class="kn">import</span> <span class="nn">utm</span>
    <span class="n">easting</span> <span class="o">=</span> <span class="n">easting</span>
    <span class="n">northing</span> <span class="o">=</span> <span class="n">northing</span>
    <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">utm</span><span class="o">.</span><span class="n">to_latlon</span><span class="p">(</span><span class="n">easting</span><span class="p">,</span> <span class="n">northing</span><span class="p">,</span> <span class="n">zone_number</span><span class="p">,</span> <span class="n">zone_letter</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">[</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">]</span></div>


<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">rasterio</span>
<span class="kn">from</span> <span class="nn">osgeo</span> <span class="kn">import</span> <span class="n">gdal</span><span class="p">,</span> <span class="n">osr</span>
<span class="kn">from</span> <span class="nn">rasterio.transform</span> <span class="kn">import</span> <span class="n">Affine</span>


<div class="viewcode-block" id="flip_geotiff_180">
<a class="viewcode-back" href="../../akhdefo_functions.html#akhdefo_functions.Akhdefo_Tools.flip_geotiff_180">[docs]</a>
<span class="k">def</span> <span class="nf">flip_geotiff_180</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
    <span class="c1"># List all files in the directory</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
        <span class="c1"># Only process files with the .tif extension</span>
        <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.tif&quot;</span><span class="p">):</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

            <span class="c1"># Open the file</span>
            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
                <span class="c1"># Read the image data</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="c1"># Define the transform</span>
                <span class="n">transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span>

            <span class="c1"># Flip the data array upside down (180 degree rotation)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

            <span class="c1"># Update the transform</span>
            <span class="n">transform</span> <span class="o">=</span> <span class="n">Affine</span><span class="p">(</span><span class="n">transform</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">transform</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="n">transform</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="n">transform</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="o">-</span><span class="n">transform</span><span class="o">.</span><span class="n">e</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span> <span class="o">*</span> <span class="n">transform</span><span class="o">.</span><span class="n">e</span> <span class="o">+</span> <span class="n">transform</span><span class="o">.</span><span class="n">f</span><span class="p">)</span>

            <span class="c1"># Write the data to the same file, overwriting the original</span>
            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;GTiff&#39;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">count</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
                <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>



<div class="viewcode-block" id="assign_fake_projection">
<a class="viewcode-back" href="../../akhdefo_functions.html#akhdefo_functions.Akhdefo_Tools.assign_fake_projection">[docs]</a>
<span class="k">def</span> <span class="nf">assign_fake_projection</span><span class="p">(</span><span class="n">input_dir</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Note</span>
<span class="sd">    ====</span>

<span class="sd">    This program assigns fake latlon geographic coordinates to ground-based images </span>
<span class="sd">    so that it can be ingest using gdal and rasterio geospatial libraries for further processing</span>
<span class="sd">    </span>
<span class="sd">    input_dir: str</span>
<span class="sd">        path to image directories without projection info</span>
<span class="sd">    </span>
<span class="sd">    output_dir: str</span>
<span class="sd">        output path image directory for images included projection info</span>

<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># Check if the output directory exists, if not, create it</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>

    <span class="c1"># List of valid extensions</span>
    <span class="n">valid_extensions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;.png&#39;</span><span class="p">,</span> <span class="s1">&#39;.bmp&#39;</span><span class="p">]</span>

    <span class="c1"># # Create a &quot;fake&quot; Spatial Reference object for source</span>
    <span class="c1"># source_srs = osr.SpatialReference()</span>
    <span class="c1"># source_srs.SetWellKnownGeogCS(&#39;LOCAL_CS&#39;)  # &#39;LOCAL_CS&#39; is a placeholder coordinate system</span>
    <span class="c1"># Create a Spatial Reference object for source</span>
    <span class="c1"># source_srs = osr.SpatialReference()</span>
    <span class="c1"># source_srs.SetWellKnownGeogCS(&#39;LOCAL_CS&#39;)</span>
    <span class="c1">#source_srs.SetWellKnownGeogCS(&#39;WGS84&#39;)  # WGS84 is a commonly used geodetic coordinate system</span>

    <span class="c1">#######</span>

    <span class="c1"># Create a SpatialReference object</span>
    <span class="n">source_srs</span> <span class="o">=</span> <span class="n">osr</span><span class="o">.</span><span class="n">SpatialReference</span><span class="p">()</span>

    <span class="c1"># Set the UTM Zone 10N coordinate system</span>
    <span class="n">source_srs</span><span class="o">.</span><span class="n">SetUTM</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Zone 10, Northern Hemisphere</span>


    <span class="c1">########</span>
    <span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">ndimage</span>

    <span class="c1"># Iterate over all files in the directory</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">input_dir</span><span class="p">):</span>
        <span class="c1"># Check if the file has a valid extension</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">valid_extensions</span><span class="p">:</span>
            <span class="c1"># Define the full path to the input raster</span>
            <span class="n">input_raster_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

            <span class="c1"># Open the raster</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">input_raster_path</span><span class="p">,</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GA_ReadOnly</span><span class="p">)</span>

            <span class="c1"># Read the raster data</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">ReadAsArray</span><span class="p">()</span>

            <span class="c1"># Rotate array by 45 degrees</span>
            <span class="c1">#data = ndimage.rotate(data, 180)</span>

            <span class="c1"># Define the full path to the output raster</span>
            <span class="c1"># We keep the original filename but put it into the output_dir</span>
            <span class="n">output_raster_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;.tif&quot;</span><span class="p">)</span>

            <span class="c1"># Create a new raster dataset with the same dimensions</span>
            <span class="n">driver</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GetDriverByName</span><span class="p">(</span><span class="s1">&#39;GTiff&#39;</span><span class="p">)</span>
            <span class="n">out_ds</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">output_raster_path</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">RasterXSize</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">RasterYSize</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">RasterCount</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">DataType</span><span class="p">)</span>

            <span class="c1"># Assign the &quot;fake&quot; projection and the same geotransform</span>
            <span class="n">out_ds</span><span class="o">.</span><span class="n">SetProjection</span><span class="p">(</span><span class="n">source_srs</span><span class="o">.</span><span class="n">ExportToWkt</span><span class="p">())</span>
            <span class="n">out_ds</span><span class="o">.</span><span class="n">SetGeoTransform</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">GetGeoTransform</span><span class="p">())</span>

             <span class="c1"># Assign the WGS84 projection and the same geotransform</span>
            <span class="n">out_ds</span><span class="o">.</span><span class="n">SetProjection</span><span class="p">(</span><span class="n">source_srs</span><span class="o">.</span><span class="n">ExportToWkt</span><span class="p">())</span>
            <span class="n">out_ds</span><span class="o">.</span><span class="n">SetGeoTransform</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">GetGeoTransform</span><span class="p">())</span>

            <span class="c1"># Write the data to the new raster</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">RasterCount</span><span class="p">):</span>
                <span class="n">out_band</span> <span class="o">=</span> <span class="n">out_ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">out_band</span><span class="o">.</span><span class="n">WriteArray</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

            <span class="c1"># Close the datasets</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">out_ds</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">output_dir</span><span class="p">):</span>
        <span class="c1"># Only process files with the .tif extension</span>
        <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.tif&quot;</span><span class="p">):</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

            <span class="c1"># Open the file</span>
            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
                <span class="c1"># Read the image data</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="c1"># Define the transform</span>
                <span class="n">transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span>

            <span class="c1"># Flip the data array upside down (180 degree rotation)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

            <span class="c1"># Update the transform</span>
            <span class="n">transform</span> <span class="o">=</span> <span class="n">Affine</span><span class="p">(</span><span class="n">transform</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">transform</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="n">transform</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="n">transform</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="o">-</span><span class="n">transform</span><span class="o">.</span><span class="n">e</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span> <span class="o">*</span> <span class="n">transform</span><span class="o">.</span><span class="n">e</span> <span class="o">+</span> <span class="n">transform</span><span class="o">.</span><span class="n">f</span><span class="p">)</span>

            <span class="c1"># Write the data to the same file, overwriting the original</span>
            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;GTiff&#39;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">count</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
                <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  </div>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>


<div class="viewcode-block" id="move_files">
<a class="viewcode-back" href="../../akhdefo_functions.html#akhdefo_functions.Akhdefo_Tools.move_files">[docs]</a>
<span class="k">def</span> <span class="nf">move_files</span><span class="p">(</span><span class="n">base_directory</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function reorganizes files in the specified directory. </span>
<span class="sd">    It searches for timestamps in filenames, creates subdirectories based on the hour part of the timestamp,</span>
<span class="sd">    and moves files to the appropriate subdirectories. The files are renamed based on the year, month, and day of the timestamp.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        base_directory (str): Path of the directory containing the files to be reorganized.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># List of regex patterns for different timestamp formats</span>
    <span class="n">timestamp_patterns</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sa">r</span><span class="s1">&#39;(?P&lt;year&gt;\d</span><span class="si">{4}</span><span class="s1">)(?P&lt;month&gt;\d</span><span class="si">{2}</span><span class="s1">)(?P&lt;day&gt;\d</span><span class="si">{2}</span><span class="s1">)(?P&lt;hour&gt;\d</span><span class="si">{2}</span><span class="s1">)(?P&lt;minute&gt;\d</span><span class="si">{2}</span><span class="s1">)(?P&lt;second&gt;\d</span><span class="si">{2}</span><span class="s1">)\.&#39;</span><span class="p">,</span>  <span class="c1"># yyyymmddhhmmss</span>
        <span class="sa">r</span><span class="s1">&#39;(?P&lt;year&gt;\d</span><span class="si">{2}</span><span class="s1">)(?P&lt;month&gt;\d</span><span class="si">{2}</span><span class="s1">)(?P&lt;day&gt;\d</span><span class="si">{2}</span><span class="s1">)(?P&lt;hour&gt;\d</span><span class="si">{2}</span><span class="s1">)\.&#39;</span><span class="p">,</span>  <span class="c1"># yymmddhh</span>
        <span class="sa">r</span><span class="s1">&#39;(?P&lt;year&gt;\d</span><span class="si">{4}</span><span class="s1">)(?P&lt;month&gt;\d</span><span class="si">{2}</span><span class="s1">)(?P&lt;day&gt;\d</span><span class="si">{2}</span><span class="s1">)\.&#39;</span><span class="p">,</span>  <span class="c1"># yyyymmdd</span>
        <span class="sa">r</span><span class="s1">&#39;(?P&lt;hour&gt;\d</span><span class="si">{2}</span><span class="s1">)(?P&lt;minute&gt;\d</span><span class="si">{2}</span><span class="s1">)(?P&lt;second&gt;\d</span><span class="si">{2}</span><span class="s1">)\.&#39;</span><span class="p">,</span>  <span class="c1"># hhmmss</span>
        <span class="sa">r</span><span class="s1">&#39;(?P&lt;hour&gt;\d</span><span class="si">{2}</span><span class="s1">)\.&#39;</span>  <span class="c1"># hh</span>
        <span class="c1"># Add more patterns as necessary</span>
    <span class="p">]</span>

    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">base_directory</span><span class="p">):</span>
        <span class="c1"># If the file is not a file, skip</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_directory</span><span class="p">,</span> <span class="n">filename</span><span class="p">)):</span>
            <span class="k">continue</span>

        <span class="c1"># Extract the timestamp from the filename</span>
        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">timestamp_patterns</span><span class="p">:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                <span class="n">year</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;0000&#39;</span><span class="p">)</span>
                <span class="n">month</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="s1">&#39;00&#39;</span><span class="p">)</span>
                <span class="n">day</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;day&#39;</span><span class="p">,</span> <span class="s1">&#39;00&#39;</span><span class="p">)</span>
                <span class="n">hour</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;hour&#39;</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No timestamp found in file </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># Construct new filename based on date and existing extension</span>
        <span class="n">base</span><span class="p">,</span> <span class="n">extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">new_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">month</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">day</span><span class="si">}{</span><span class="n">extension</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># Make directory for this hour if it doesn&#39;t exist</span>
        <span class="n">hour_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_directory</span><span class="p">,</span> <span class="n">hour</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">hour_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">hour_dir</span><span class="p">)</span>

        <span class="c1"># Move and rename file to the corresponding hour folder</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_directory</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">hour_dir</span><span class="p">,</span> <span class="n">new_filename</span><span class="p">))</span></div>




<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">backend</span> <span class="k">as</span> <span class="n">K</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Activation</span><span class="p">,</span> <span class="n">Conv2D</span><span class="p">,</span> <span class="n">Dense</span><span class="p">,</span> <span class="n">Flatten</span><span class="p">,</span>
                                     <span class="n">MaxPooling2D</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.models</span> <span class="kn">import</span> <span class="n">Sequential</span>


<div class="viewcode-block" id="LeNet">
<a class="viewcode-back" href="../../akhdefo_functions.html#akhdefo_functions.Akhdefo_Tools.LeNet">[docs]</a>
<span class="k">class</span> <span class="nc">LeNet</span><span class="p">:</span>
<div class="viewcode-block" id="LeNet.build">
<a class="viewcode-back" href="../../akhdefo_functions.html#akhdefo_functions.Akhdefo_Tools.LeNet.build">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">classes</span><span class="p">):</span>
        <span class="c1"># initialize the model</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>
        <span class="n">inputShape</span> <span class="o">=</span> <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>

        <span class="c1"># if we are using &quot;channels first&quot;, update the input shape</span>
        <span class="k">if</span> <span class="n">K</span><span class="o">.</span><span class="n">image_data_format</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;channels_first&quot;</span><span class="p">:</span>
            <span class="n">inputShape</span> <span class="o">=</span> <span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>

        <span class="c1"># first set of CONV =&gt; RELU =&gt; POOL layers</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">,</span>
            <span class="n">input_shape</span><span class="o">=</span><span class="n">inputShape</span><span class="p">))</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Activation</span><span class="p">(</span><span class="s2">&quot;relu&quot;</span><span class="p">))</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>

        <span class="c1"># second set of CONV =&gt; RELU =&gt; POOL layers</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">))</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Activation</span><span class="p">(</span><span class="s2">&quot;relu&quot;</span><span class="p">))</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>

        <span class="c1"># first (and only) set of FC =&gt; RELU layers</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Flatten</span><span class="p">())</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">500</span><span class="p">))</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Activation</span><span class="p">(</span><span class="s2">&quot;relu&quot;</span><span class="p">))</span>

        <span class="c1"># softmax classifier</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="n">classes</span><span class="p">))</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Activation</span><span class="p">(</span><span class="s2">&quot;softmax&quot;</span><span class="p">))</span>

        <span class="c1"># return the constructed network architecture</span>
        <span class="k">return</span> <span class="n">model</span></div>
</div>


<div class="viewcode-block" id="Lenet_Model_training">
<a class="viewcode-back" href="../../akhdefo_functions.html#akhdefo_functions.Akhdefo_Tools.Lenet_Model_training">[docs]</a>
<span class="k">def</span> <span class="nf">Lenet_Model_training</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s2">&quot;DataForTraining&quot;</span><span class="p">,</span> <span class="n">model_out</span><span class="o">=</span><span class="s2">&quot;foggy_not_foggy.model&quot;</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="s2">&quot;Model_stat_plot.png&quot;</span><span class="p">,</span> <span class="n">EPOCHS</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
    <span class="n">INIT_LR</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span>  <span class="n">BS</span> <span class="o">=</span> <span class="mi">32</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>

<span class="sd">    This function, Lenet_Model_train(), is designed to train a convolutional neural network (CNN) using the LeNet architecture. The network is trained on a dataset of images to classify whether they are &quot;foggy&quot; or &quot;not foggy&quot;.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>

<span class="sd">    dataset: str</span>
<span class="sd">      (default=&quot;DataForTraining&quot;) Path to the directory containing the image data for training. The images are expected to be in separate directories named after their corresponding class (&quot;foggy&quot; or &quot;not foggy&quot;).</span>
<span class="sd">    model_out: str</span>
<span class="sd">      (default=&quot;foggy_not_foggy.model&quot;) The name or path for the output file where the trained model will be saved in the h5 format.</span>
<span class="sd">    plot: str</span>
<span class="sd">     (default=&quot;Model_stat_plot.png&quot;) The name or path for the output image file where a plot of the training loss and accuracy will be saved.</span>
<span class="sd">    EPOCHS: int</span>
<span class="sd">      (default=100)The number of epochs to use for training.</span>
<span class="sd">    INIT_LR: float</span>
<span class="sd">      (default=1e-3)The initial learning rate for the Adam optimizer.</span>
<span class="sd">    BS: int</span>
<span class="sd">      (default=32)The batch size for training.</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    - Trains a LeNet model on the given dataset.</span>
<span class="sd">    - Saves the trained model to disk in the h5 format.</span>
<span class="sd">    - Plots the training and validation loss and accuracy as a function of epoch number, and saves the plot to disk. The plot also includes the model summary.</span>
<span class="sd">    - Note: The function uses data augmentation techniques during training, including random rotations, width and height shifts, shearing, zooming, and horizontal flipping.</span>
<span class="sd">    - This function uses the TensorFlow, Keras, OpenCV, and matplotlib libraries.</span>

<span class="sd">    &#39;&#39;&#39;</span>
            
    <span class="kn">import</span> <span class="nn">argparse</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="kn">import</span> <span class="nn">random</span>

    <span class="kn">import</span> <span class="nn">cv2</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="kn">from</span> <span class="nn">imutils</span> <span class="kn">import</span> <span class="n">paths</span>
    <span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
    <span class="kn">from</span> <span class="nn">tensorflow.keras.optimizers</span> <span class="kn">import</span> <span class="n">Adam</span>
    <span class="kn">from</span> <span class="nn">tensorflow.keras.preprocessing.image</span> <span class="kn">import</span> <span class="p">(</span><span class="n">ImageDataGenerator</span><span class="p">,</span>
                                                      <span class="n">img_to_array</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">tensorflow.keras.utils</span> <span class="kn">import</span> <span class="n">to_categorical</span>

    <span class="c1">#from mahmud_ml.lenet import LeNet</span>

    

    <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model_out</span>
    <span class="n">plot</span><span class="o">=</span><span class="n">plot</span>
    

    <span class="c1"># initialize the number of epochs to train for, initial learning rate, and batch size</span>
    <span class="n">EPOCHS</span> <span class="o">=</span> <span class="n">EPOCHS</span>
    <span class="n">INIT_LR</span> <span class="o">=</span> <span class="n">INIT_LR</span>
    <span class="n">BS</span> <span class="o">=</span> <span class="n">BS</span>

    <span class="c1"># initialize the data and labels</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[INFO] loading images...&quot;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># grab the image paths and randomly shuffle</span>
    <span class="n">imagePaths</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">list_images</span><span class="p">(</span><span class="n">dataset</span><span class="p">)))</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
    <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">imagePaths</span><span class="p">)</span>

    <span class="c1"># loop over the input images</span>
    <span class="k">for</span> <span class="n">imagePath</span> <span class="ow">in</span> <span class="n">imagePaths</span><span class="p">:</span>
        <span class="c1"># load the image, pre-process it, and store it in the data list</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">imagePath</span><span class="p">)</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">))</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">img_to_array</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

        <span class="c1"># extract the class label from the image path and update the labels list</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">imagePath</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">label</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="s2">&quot;foggy&quot;</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

    <span class="c1"># scale the raw pixel intensities to the range [0, 1]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>

    <span class="c1"># partition the data into training and testing splits using 75% of the data for training and the remaining 25% for testing</span>
    <span class="p">(</span><span class="n">trainX</span><span class="p">,</span> <span class="n">testX</span><span class="p">,</span> <span class="n">trainY</span><span class="p">,</span> <span class="n">testY</span><span class="p">)</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

    <span class="c1"># convert the labels from integers to vectors</span>
    <span class="n">trainY</span> <span class="o">=</span> <span class="n">to_categorical</span><span class="p">(</span><span class="n">trainY</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">testY</span> <span class="o">=</span> <span class="n">to_categorical</span><span class="p">(</span><span class="n">testY</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># construct the image generator for data augmentation</span>
    <span class="n">aug</span> <span class="o">=</span> <span class="n">ImageDataGenerator</span><span class="p">(</span><span class="n">rotation_range</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">width_shift_range</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">height_shift_range</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">shear_range</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">zoom_range</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">horizontal_flip</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fill_mode</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">)</span>

    <span class="c1"># initialize the model</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[INFO] compiling model...&quot;</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">LeNet</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">28</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">28</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">classes</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="n">INIT_LR</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s2">&quot;binary_crossentropy&quot;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">])</span>

    <span class="c1"># train the network</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[INFO] training network...&quot;</span><span class="p">)</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">aug</span><span class="o">.</span><span class="n">flow</span><span class="p">(</span><span class="n">trainX</span><span class="p">,</span> <span class="n">trainY</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BS</span><span class="p">),</span> <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">testX</span><span class="p">,</span> <span class="n">testY</span><span class="p">),</span> <span class="n">steps_per_epoch</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">trainX</span><span class="p">)</span> <span class="o">//</span> <span class="n">BS</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">EPOCHS</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># save the model to disk</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[INFO] serializing network...&quot;</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model_out</span><span class="p">,</span> <span class="n">save_format</span><span class="o">=</span><span class="s2">&quot;h5&quot;</span><span class="p">)</span>

    <span class="c1">#############</span>

    <span class="kn">from</span> <span class="nn">tensorflow.keras.models</span> <span class="kn">import</span> <span class="n">load_model</span>

    <span class="c1"># Load the model</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="n">model_out</span><span class="p">)</span>

    <span class="c1"># # Print model summary</span>
    <span class="c1"># print(&quot;\nModel Summary:&quot;)</span>
    <span class="c1">#model.summary()</span>

    <span class="kn">import</span> <span class="nn">io</span>
    <span class="kn">import</span> <span class="nn">re</span>

    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

    <span class="c1"># Save the summary to a string</span>
    <span class="n">stream</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">print_fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
    <span class="n">summary_string</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
    <span class="n">stream</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Preprocess the string to remove unwanted characters</span>
    <span class="n">summary_string</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;_+&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">summary_string</span><span class="p">)</span>
    <span class="n">summary_string</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;=+&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">summary_string</span><span class="p">)</span>


    <span class="c1">###############</span>

    <span class="c1"># plot the training loss and accuracy</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;ggplot&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">EPOCHS</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="n">H</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;train_loss&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="n">H</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;val_loss&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;val_loss&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="n">H</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;train_acc&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="n">H</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;val_accuracy&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;val_acc&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Training Loss and Accuracy on fog/Not fog&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Epoch #&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Loss/Accuracy&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower left&quot;</span><span class="p">)</span>


    <span class="c1"># Add the summary string as a textbox</span>
    <span class="c1"># Add text to figure with a bounding box</span>
    <span class="n">bbox_props</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s2">&quot;round, pad=0.3&quot;</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figtext</span><span class="p">(</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">summary_string</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="n">bbox_props</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>



<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">listdir</span><span class="p">,</span> <span class="n">makedirs</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">isdir</span><span class="p">,</span> <span class="n">isfile</span><span class="p">,</span> <span class="n">join</span>

<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.models</span> <span class="kn">import</span> <span class="n">load_model</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.preprocessing.image</span> <span class="kn">import</span> <span class="n">img_to_array</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>


<div class="viewcode-block" id="classification">
<a class="viewcode-back" href="../../akhdefo_functions.html#akhdefo_functions.Akhdefo_Tools.classification">[docs]</a>
<span class="k">def</span> <span class="nf">classification</span><span class="p">(</span><span class="n">input_dir</span><span class="o">=</span><span class="s2">&quot;dataset_imagery&quot;</span><span class="p">,</span> <span class="n">trained_model</span><span class="o">=</span><span class="s2">&quot;foggy_not_foggy.model&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Classifies images in the specified directory using a trained model.</span>

<span class="sd">    Inputs:</span>
<span class="sd">    -------</span>
<span class="sd">        - input_dir (str, optional): Path to the directory containing the input images. Defaults to &quot;dataset_imagery&quot;.</span>
<span class="sd">        - trained_model (str, optional): Path to the trained model file. Defaults to &quot;foggy_not_foggy.model&quot;.</span>

<span class="sd">    </span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">        - The function assumes that the input directory contains image files in JPG format.</span>
<span class="sd">        - The function uses a trained convolutional neural network model to classify the images.</span>
<span class="sd">        - It saves the classified images into separate directories based on their classification.</span>

<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Setting required file directories</span>
    <span class="n">dir_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;filtered_images_noFog&#39;</span><span class="p">,</span> <span class="s1">&#39;filtered_images_Fog&#39;</span><span class="p">,</span> <span class="s1">&#39;ClearImages_daily&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">directory</span> <span class="ow">in</span> <span class="n">dir_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">isdir</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">makedirs</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating directory &#39;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">No_Fogg_path</span> <span class="o">=</span> <span class="s2">&quot;filtered_images_noFog&quot;</span>
    <span class="n">Foggy_Path</span> <span class="o">=</span> <span class="s2">&quot;filtered_images_Fog&quot;</span>
    <span class="n">dailyimages</span> <span class="o">=</span> <span class="s2">&quot;ClearImages_daily&quot;</span>
    <span class="n">mypath</span> <span class="o">=</span> <span class="n">input_dir</span>

    <span class="n">onlyfiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">listdir</span><span class="p">(</span><span class="n">mypath</span><span class="p">)</span> <span class="k">if</span> <span class="n">isfile</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">mypath</span><span class="p">,</span> <span class="n">f</span><span class="p">))]</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">onlyfiles</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>

    <span class="c1"># Load the trained convolutional neural network outside of loop</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="n">trained_model</span><span class="p">)</span>

    <span class="c1"># Loop through each image and use tqdm for progress bar</span>
    <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">onlyfiles</span><span class="p">)),</span> <span class="n">bar_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{l_bar}{bar}</span><span class="s1">| </span><span class="si">{n_fmt}</span><span class="s1">/</span><span class="si">{total_fmt}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">colour</span><span class="o">=</span><span class="s1">&#39;#00ff00&#39;</span><span class="p">,</span> <span class="n">dynamic_ncols</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">pbar</span><span class="p">:</span>
        <span class="n">pbar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing image </span><span class="si">{</span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">image_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">mypath</span><span class="p">,</span> <span class="n">onlyfiles</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>

        <span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span>
        <span class="n">orig</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Pre-process the image for classification</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">))</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">img_to_array</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span>

        <span class="c1"># Classify the input image</span>
        <span class="p">(</span><span class="n">not_foggy</span><span class="p">,</span> <span class="n">foggy</span><span class="p">)</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">image</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;NotFoggy&quot;</span> <span class="k">if</span> <span class="n">not_foggy</span> <span class="o">&gt;</span> <span class="n">foggy</span> <span class="k">else</span> <span class="s2">&quot;Foggy&quot;</span>
        <span class="n">proba</span> <span class="o">=</span> <span class="n">not_foggy</span> <span class="k">if</span> <span class="n">not_foggy</span> <span class="o">&gt;</span> <span class="n">foggy</span> <span class="k">else</span> <span class="n">foggy</span>
        <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">proba</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span>

        <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_SIMPLEX</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span>

        <span class="n">file</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">onlyfiles</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
        <span class="n">position</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;.jpg&quot;</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">file</span><span class="p">[:</span><span class="n">position</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">proba</span> <span class="o">&gt;</span> <span class="mf">0.95</span> <span class="ow">and</span> <span class="n">not_foggy</span> <span class="o">&gt;</span> <span class="n">foggy</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Not Foggy&quot;</span>
            <span class="n">im</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">No_Fogg_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">proba</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">.jpg&quot;</span><span class="p">))</span>
            <span class="n">im</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">dailyimages</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">.jpg&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Foggy&quot;</span>
            <span class="n">im</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">Foggy_Path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">proba</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">.jpg&quot;</span><span class="p">))</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">No more files left to process&quot;</span><span class="p">)</span>  <span class="c1"># Print final message on a new line</span></div>



<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">rasterio</span>
<span class="kn">from</span> <span class="nn">rasterio.transform</span> <span class="kn">import</span> <span class="n">Affine</span>


<div class="viewcode-block" id="calculate_volume">
<a class="viewcode-back" href="../../akhdefo_functions.html#akhdefo_functions.Akhdefo_Tools.calculate_volume">[docs]</a>
<span class="k">def</span> <span class="nf">calculate_volume</span><span class="p">(</span><span class="n">elevation_map</span><span class="p">,</span> <span class="n">slope_map</span><span class="p">,</span> <span class="n">cell_size</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">plot_map</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the volume based on an elevation map and a slope map,</span>
<span class="sd">    and save the volume map as a GeoTIFF file. Optionally, plot the volume map as a figure and save it.</span>

<span class="sd">    Args:</span>
<span class="sd">        elevation_map (str): File path to the elevation map raster.</span>
<span class="sd">        slope_map (ndarray): 2D array representing the slope values.</span>
<span class="sd">        cell_size (float): Size of each cell in the map (e.g., length of one side of a square cell).</span>
<span class="sd">        output_file (str): Output file path for saving the volume map as a GeoTIFF.</span>
<span class="sd">        plot_map (bool, optional): Whether to plot the volume map as a figure. Default is False.</span>
<span class="sd">        plot_file (str, optional): Output file path for saving the volume map plot. Required if plot_map is True.</span>

<span class="sd">    Returns:</span>
<span class="sd">        ndarray: The calculated volume map.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Read elevation map raster using rasterio</span>
    <span class="n">src</span><span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">elevation_map</span><span class="p">)</span>
    <span class="c1"># Get CRS from elevation_map</span>
    <span class="n">crs</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span>

    <span class="c1"># Get transform from elevation_map</span>
    <span class="n">transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span>

     <span class="c1"># Read elevation map data</span>
    <span class="n">elevation_data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

     <span class="c1"># Read elevation map raster using rasterio</span>
    <span class="n">src1</span><span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">slope_map</span><span class="p">)</span>
        
     <span class="c1"># Read slope_map data</span>
    <span class="n">slope_data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Calculate the dimensions of the maps</span>
    <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">elevation_data</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1"># Initialize the volume map</span>
    <span class="n">volume_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">elevation_data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="c1"># Iterate over each cell in the maps</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rows</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
            <span class="c1"># Calculate the cell area</span>
            <span class="n">area</span> <span class="o">=</span> <span class="n">cell_size</span> <span class="o">**</span> <span class="mi">2</span>

            <span class="c1"># Calculate the cell volume contribution</span>
            <span class="n">volume_map</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">elevation_data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">area</span>

            <span class="c1"># Calculate the slope gradient</span>
            <span class="n">slope_gradient</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">slope_data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]))</span>

            <span class="c1"># Calculate the additional volume due to the slope</span>
            <span class="n">volume_map</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">slope_gradient</span> <span class="o">*</span> <span class="n">area</span>

    <span class="c1"># Save volume map as GeoTIFF</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GTiff&quot;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">volume_map</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="n">volume_map</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">volume_map</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
        <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">volume_map</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Plot and save volume map if desired</span>
    <span class="k">if</span> <span class="n">plot_map</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">volume_map</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Volume&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Volume Map&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Column&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Row&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_file</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">volume_map</span></div>





<span class="c1"># def ts_plot(df, plot_number, save_plot=False , output_dir=&quot;&quot;, plot_filename=&quot;&quot; , VEL_Scale=&#39;year&#39;):</span>


<span class="c1">#     import plotly.graph_objects as go</span>
<span class="c1">#     import plotly.express as px</span>
<span class="c1">#     import plotly.express as px_temp</span>
<span class="c1">#     import pandas as pd</span>
<span class="c1">#     import numpy as np</span>
<span class="c1">#     import matplotlib.pyplot as plt</span>
<span class="c1">#     import geopandas as gpd </span>
<span class="c1">#     import pandas as pd  </span>
<span class="c1">#     import seaborn as sns  </span>
<span class="c1">#     import plotly.offline as py_offline</span>
<span class="c1">#     import os   </span>
<span class="c1">#     import statsmodels.api as sm</span>
<span class="c1">#     from sklearn.metrics import mean_squared_error, r2_score</span>
<span class="c1">#     import numpy as np</span>
<span class="c1">#     from sklearn.linear_model import LinearRegression</span>
<span class="c1">#     from datetime import datetime</span>
<span class="c1">#     import math</span>
    
<span class="c1">#     py_offline.init_notebook_mode()</span>
<span class="c1">#     #%matplotlib widget</span>
<span class="c1">#     #df=pd.read_csv(&quot;temp.csv&quot;)</span>
<span class="c1">#     df.rename(columns={ df.columns[0]: &quot;dd&quot; }, inplace = True)</span>
<span class="c1">#     df[&#39;dd_str&#39;]=df[&#39;dd&#39;].astype(str)</span>
<span class="c1">#     df[&#39;dd_str&#39;] = df[&#39;dd_str&#39;].astype(str)</span>
<span class="c1">#     df.rename(columns={ df.columns[1]: &quot;val&quot; }, inplace = True)</span>
<span class="c1">#     df[&#39;dd&#39;]= pd.to_datetime(df[&#39;dd&#39;].astype(str), format=&#39;%Y%m%d&#39;)</span>
    
<span class="c1">#     df=df.set_index(&#39;dd&#39;)</span>
    
<span class="c1">#     ########################</span>
<span class="c1">#     df=df.dropna()</span>
<span class="c1">#     # Make index pd.DatetimeIndex</span>
<span class="c1">#     df.index = pd.DatetimeIndex(df.index)</span>
<span class="c1">#     # Make new index</span>
<span class="c1">#     idx = pd.date_range(df.index.min(), df.index.max())</span>
<span class="c1">#     # Replace original index with idx</span>
<span class="c1">#     df = df.reindex(index = idx)</span>
<span class="c1">#     # Insert row count</span>
<span class="c1">#     df.insert(df.shape[1],</span>
<span class="c1">#             &#39;row_count&#39;,</span>
<span class="c1">#             df.index.value_counts().sort_index().cumsum())</span>

<span class="c1">#     df=df.dropna()</span>
    
<span class="c1">#     #df=df.set_index(df[&#39;row_count&#39;], inplace=True)</span>

<span class="c1">#     df.sort_index(ascending=True, inplace=True)</span>
    

<span class="c1">#     def best_fit_slope_and_intercept(xs,ys):</span>
<span class="c1">#         from statistics import mean</span>
<span class="c1">#         xs = np.array(xs, dtype=np.float64)</span>
<span class="c1">#         ys = np.array(ys, dtype=np.float64)</span>
<span class="c1">#         m = (((mean(xs)*mean(ys)) - mean(xs*ys)) /</span>
<span class="c1">#             ((mean(xs)*mean(xs)) - mean(xs*xs)))</span>
        
<span class="c1">#         b = mean(ys) - m*mean(xs)</span>
        
<span class="c1">#         return m, b</span>

    

<span class="c1">#     #convert dattime to number of days per year</span>
    
    
    

<span class="c1">#     dates_list=([datetime.strptime(x, &#39;%Y%m%d&#39;) for x in df.dd_str])</span>
<span class="c1">#     days_num=[( ((x) - (pd.Timestamp(year=x.year, month=1, day=1))).days + 1) for x in dates_list]</span>
<span class="c1">#     time2=days_num[len(days_num)-1]</span>
<span class="c1">#     time1=days_num[0]</span>
<span class="c1">#     delta=time2-time1</span>
<span class="c1">#     delta=float(delta)</span>
<span class="c1">#     print(days_num, delta)</span>
    
<span class="c1">#     m, b = best_fit_slope_and_intercept(df.row_count, df.val)</span>
<span class="c1">#     print(&quot;m:&quot;, math.ceil(m*100)/100, &quot;b:&quot;,math.ceil(b*100)/100)</span>
<span class="c1">#     regression_model = LinearRegression()</span>
<span class="c1">#     val_dates_res = regression_model.fit(np.array(days_num).reshape(-1,1), np.array(df.val))</span>
<span class="c1">#     y_predicted = regression_model.predict(np.array(days_num).reshape(-1,1))</span>
    
<span class="c1">#     if VEL_Scale==&#39;year&#39;:</span>
<span class="c1">#         rate_change=regression_model.coef_[0]/delta * 365.0</span>
<span class="c1">#     elif VEL_Scale==&#39;month&#39;:</span>
<span class="c1">#         rate_change=regression_model.coef_[0]/delta * 30</span>
        
<span class="c1">#     # model evaluation</span>
<span class="c1">#     mse=mean_squared_error(np.array(df.val),y_predicted)</span>
<span class="c1">#     rmse = np.sqrt(mean_squared_error(np.array(df.val), y_predicted))</span>
<span class="c1">#     r2 = r2_score(np.array(df.val), y_predicted)</span>
    
<span class="c1">#     # printing values</span>
<span class="c1">#     print(&#39;Slope(linear deformation rate):&#39; + str(math.ceil(regression_model.coef_[0]*100)/100/delta) + &quot; mm/day&quot;)</span>
<span class="c1">#     print(&#39;Intercept:&#39;, math.ceil(b*100)/100)</span>
<span class="c1">#     #print(&#39;MSE:&#39;,mse)</span>
<span class="c1">#     print(&#39;Root mean squared error: &#39;, math.ceil(rmse*100)/100)</span>
<span class="c1">#     print(&#39;R2 score: &#39;, r2)</span>
<span class="c1">#     print(&quot;STD: &quot;,math.ceil(np.std(y_predicted)*100)/100) </span>
<span class="c1">#     # Create figure</span>
<span class="c1">#     #fig = go.Figure()</span>
    
<span class="c1">#     fig = go.FigureWidget()</span>
    
<span class="c1">#     plot_number=&quot;Plot Number:&quot;+str(plot_number)</span>

<span class="c1">#     fig.add_trace(go.Scatter(x=list(df.index), y=list(df.val)))</span>
<span class="c1">#     fig = px.scatter(df, x=list(df.index), y=list(df.val),</span>
<span class="c1">#                 color=&quot;val&quot;, hover_name=&quot;val&quot;</span>
<span class="c1">#                     , labels=dict(x=&quot;Dates&quot;, y=&quot;mm/&quot;+VEL_Scale , color=&quot;mm/&quot;+VEL_Scale))</span>
    
<span class="c1">#     # fig.add_trace(</span>
<span class="c1">#     # go.Scatter(x=list(df.index), y=list(val_fit), mode = &quot;lines&quot;,name=&quot;trendline&quot;, marker_color = &quot;red&quot;))</span>
    
    
    
<span class="c1">#     fig.add_trace(go.Scatter(x=list(df.index), y=list(df.val),mode = &#39;lines&#39;,</span>
<span class="c1">#                             name = &#39;draw lines&#39;, line = dict(shape = &#39;linear&#39;, color = &#39;rgb(0, 0, 0)&#39;, dash = &#39;dash&#39;), connectgaps = True))</span>
    
<span class="c1">#     fig.add_trace(</span>
<span class="c1">#         go.Scatter(x=list(df.index), y=list(y_predicted), mode = &quot;lines&quot;,name=&quot;trendline&quot;, marker_color = &quot;black&quot;, line_color=&#39;red&#39;))</span>
    
    

<span class="c1">#     # Add range slider</span>
<span class="c1">#     fig.update_layout(</span>
<span class="c1">#         xaxis=dict(</span>
<span class="c1">#             rangeselector=dict(</span>
<span class="c1">#                 buttons=list([</span>
<span class="c1">#                     dict(count=1,</span>
<span class="c1">#                         label=&quot;1m&quot;,</span>
<span class="c1">#                         step=&quot;month&quot;,</span>
<span class="c1">#                         stepmode=&quot;backward&quot;),</span>
<span class="c1">#                     dict(count=6,</span>
<span class="c1">#                         label=&quot;6m&quot;,</span>
<span class="c1">#                         step=&quot;month&quot;,</span>
<span class="c1">#                         stepmode=&quot;backward&quot;),</span>
<span class="c1">#                     dict(count=1,</span>
<span class="c1">#                         label=&quot;YTD&quot;,</span>
<span class="c1">#                         step=&quot;year&quot;,</span>
<span class="c1">#                         stepmode=&quot;todate&quot;),</span>
<span class="c1">#                     dict(count=1,</span>
<span class="c1">#                         label=&quot;1y&quot;,</span>
<span class="c1">#                         step=&quot;year&quot;,</span>
<span class="c1">#                         stepmode=&quot;backward&quot;),</span>
<span class="c1">#                     dict(step=&quot;all&quot;)</span>
<span class="c1">#                 ])</span>
<span class="c1">#             ),</span>
<span class="c1">#             rangeslider=dict(</span>
<span class="c1">#                 visible=True</span>
<span class="c1">#             ),</span>
<span class="c1">#             type=&quot;date&quot;</span>
<span class="c1">#         ) </span>
<span class="c1">#     )</span>
<span class="c1">#     fig.update_xaxes(rangeslider_thickness = 0.05)</span>
<span class="c1">#     #fig.update_layout(showlegend=True)</span>

<span class="c1">#     #fig.data[0].update(line_color=&#39;black&#39;)</span>
<span class="c1">#     tt= &quot;Defo-Rate:&quot;+str(round(rate_change,2))+&quot;:&quot;+ &quot;Defo-Rate-STD:&quot;+str(round(np.std(y_predicted), 2))+ &quot;:&quot; +plot_number</span>
    
<span class="c1">#     # make space for explanation / annotation</span>
<span class="c1">#     fig.update_layout(margin=dict(l=20, r=20, t=20, b=60),paper_bgcolor=&quot;LightSteelBlue&quot;)</span>

    
<span class="c1">#     fig.update_layout(</span>
        
<span class="c1">#     title_text=tt, title_font_family=&quot;Sitka Small&quot;,</span>
<span class="c1">#     title_font_color=&quot;red&quot;, title_x=0.5 , legend_title=&quot;Legend&quot;,</span>
<span class="c1">#     font=dict(</span>
<span class="c1">#         family=&quot;Courier New, monospace&quot;,</span>
<span class="c1">#         size=15,</span>
<span class="c1">#         color=&quot;RebeccaPurple&quot; ))</span>
    
<span class="c1">#     fig.update_layout(legend=dict(</span>
<span class="c1">#     yanchor=&quot;top&quot;,</span>
<span class="c1">#     y=-0,</span>
<span class="c1">#     xanchor=&quot;left&quot;,</span>
<span class="c1">#     x=1.01</span>
<span class="c1"># ))</span>

<span class="c1">#     # fig.update_layout(</span>
<span class="c1">#     # updatemenus=[</span>
<span class="c1">#     #     dict(</span>
<span class="c1">#     #         type=&quot;buttons&quot;,</span>
<span class="c1">#     #         direction=&quot;right&quot;,</span>
<span class="c1">#     #         active=0,</span>
<span class="c1">#     #         x=0.57,</span>
<span class="c1">#     #         y=1.2,</span>
<span class="c1">#     #         buttons=list([</span>
<span class="c1">#     #             dict(</span>
<span class="c1">#     #                 args=[&quot;colorscale&quot;, &quot;Viridis&quot;],</span>
<span class="c1">#     #                 label=&quot;Viridis&quot;,</span>
<span class="c1">#     #                 method=&quot;restyle&quot;</span>
<span class="c1">#     #             ),</span>
<span class="c1">#     #             dict(</span>
<span class="c1">#     #                 args=[&quot;colorscale&quot;, &quot;turbo&quot;],</span>
<span class="c1">#     #                 label=&quot;turbo&quot;,</span>
<span class="c1">#     #                 method=&quot;restyle&quot;</span>
<span class="c1">#     #             )</span>
<span class="c1">#     #         ]),</span>
<span class="c1">#     #     )</span>
<span class="c1">#     # ])</span>

    
<span class="c1">#     fig.update_xaxes(showspikes=True, spikemode=&#39;toaxis&#39; , spikesnap=&#39;cursor&#39;, spikedash=&#39;dot&#39;, spikecolor=&#39;blue&#39;, scaleanchor=&#39;y&#39;, title_font_family=&quot;Arial&quot;, </span>
<span class="c1">#                     title_font=dict(size=15))</span>
<span class="c1">#     fig.update_yaxes(showspikes=True, spikemode=&#39;toaxis&#39; , spikesnap=&#39;cursor&#39;, spikedash=&#39;dot&#39;, spikecolor=&#39;blue&#39;, scaleanchor=&#39;x&#39;, title_font_family=&quot;Arial&quot;,</span>
<span class="c1">#                     title_font=dict(size=15))</span>

    
    
<span class="c1">#     if save_plot==True:</span>
    
<span class="c1">#         if not os.path.exists(output_dir):</span>
<span class="c1">#             os.mkdir(output_dir)</span>

<span class="c1">#         fig.write_html(output_dir + &quot;/&quot; + plot_filename + &quot;.html&quot; )</span>
<span class="c1">#         fig.write_image(output_dir + &quot;/&quot; + plot_filename + &quot;.jpeg&quot;, scale=1, width=1080, height=300 )</span>
        
    
<span class="c1">#     def zoom(layout, xrange):</span>
<span class="c1">#         in_view = df.loc[fig.layout.xaxis.range[0]:fig.layout.xaxis.range[1]]</span>
<span class="c1">#         fig.layout.yaxis.range = [in_view.High.min() - 10, in_view.High.max() + 10]</span>

<span class="c1">#     fig.layout.on_change(zoom, &#39;xaxis.range&#39;)</span>
    
<span class="c1">#     fig.show()</span>
    
    




    
<span class="c1">#     start=int(start.timestamp() * 1000)</span>
<span class="c1">#     end=int(end.timestamp() * 1000)</span>

<span class="c1">#     #df=pd.read_csv(&#39;temp2.csv&#39;)</span>
    
<span class="c1">#     df.rename(columns={ df.columns[0]: &quot;dd&quot; }, inplace = True)</span>
<span class="c1">#     df[&#39;dd_str&#39;]=df[&#39;dd&#39;].astype(str)</span>
<span class="c1">#     df[&#39;dd_str&#39;] = df[&#39;dd_str&#39;].astype(str)</span>
<span class="c1">#     df.rename(columns={ df.columns[1]: &quot;val&quot; }, inplace = True)</span>
<span class="c1">#     df[&#39;dd&#39;]= pd.to_datetime(df[&#39;dd&#39;].astype(str), format=&#39;%Y-%m-%d&#39;)</span>
<span class="c1">#     df.insert(df.shape[1],</span>
<span class="c1">#             &#39;row_count&#39;,</span>
<span class="c1">#             df.index.value_counts().sort_index().cumsum())</span>
<span class="c1">#     #df=df.set_index(&#39;dd&#39;)</span>
<span class="c1">#     #df.index = pd.DatetimeIndex(df.index)</span>
<span class="c1">#     df.dd_str = pd.DatetimeIndex(df.dd_str)</span>
<span class="c1">#     df[&#39;dd_int&#39;] = [int(i.timestamp()*1000) for i in df.dd_str]</span>
<span class="c1">#     import numpy as np </span>
<span class="c1">#     def find_nearest(array, value):</span>
<span class="c1">#         array = np.asarray(array)</span>
<span class="c1">#         idx = (np.abs(array - value)).argmin()</span>
<span class="c1">#         return array[idx]</span>
<span class="c1">#     s=find_nearest(np.array(df.dd_int), start)</span>
<span class="c1">#     e=find_nearest(np.array(df.dd_int), end)</span>

<span class="c1">#     s=(df[df[&#39;dd_int&#39;]==s].index)</span>
<span class="c1">#     e=(df[df[&#39;dd_int&#39;]==e].index)</span>

<span class="c1">#     df_filter=df[s[0]:e[0]]</span>
<span class="c1">#     print(df_filter)</span>

<span class="c1">#     df=df_filter  </span>
    
<span class="c1"># import pandas as pd</span>
<span class="c1"># import ipywidgets as widgets</span>
<span class="c1"># from IPython.display import display</span>

<span class="c1"># class DateRangePicker(object):</span>
<span class="c1">#     def __init__(self,start,end,freq=&#39;D&#39;,fmt=&#39;%Y-%m-%d&#39;):</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         Parameters</span>
<span class="c1">#         ----------</span>
<span class="c1">#         start : string or datetime-like</span>
<span class="c1">#             Left bound of the period</span>
<span class="c1">#         end : string or datetime-like</span>
<span class="c1">#             Left bound of the period</span>
<span class="c1">#         freq : string or pandas.DateOffset, default=&#39;D&#39;</span>
<span class="c1">#             Frequency strings can have multiples, e.g. &#39;5H&#39; </span>
<span class="c1">#         fmt : string, defauly = &#39;%Y-%m-%d&#39;</span>
<span class="c1">#             Format to use to display the selected period</span>

<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         self.date_range=pd.date_range(start=start,end=end,freq=freq)</span>
<span class="c1">#         options = [(item.strftime(fmt),item) for item in self.date_range]</span>
<span class="c1">#         self.slider_start = widgets.SelectionSlider(</span>
<span class="c1">#             description=&#39;start&#39;,</span>
<span class="c1">#             options=options,</span>
<span class="c1">#             continuous_update=False</span>
<span class="c1">#         )</span>
<span class="c1">#         self.slider_end = widgets.SelectionSlider(</span>
<span class="c1">#             description=&#39;end&#39;,</span>
<span class="c1">#             options=options,</span>
<span class="c1">#             continuous_update=False,</span>
<span class="c1">#             value=options[-1][1]</span>
<span class="c1">#         )</span>

<span class="c1">#         self.slider_start.on_trait_change(self.slider_start_changed, &#39;value&#39;)</span>
<span class="c1">#         self.slider_end.on_trait_change(self.slider_end_changed, &#39;value&#39;)</span>

<span class="c1">#         self.widget = widgets.Box(children=[self.slider_start,self.slider_end])</span>

<span class="c1">#     def slider_start_changed(self,key,value):</span>
<span class="c1">#         self.slider_end.value=max(self.slider_start.value,self.slider_end.value)</span>
<span class="c1">#         self._observe(start=self.slider_start.value,end=self.slider_end.value)</span>

<span class="c1">#     def slider_end_changed(self,key,value):</span>
<span class="c1">#         self.slider_start.value=min(self.slider_start.value,self.slider_end.value)</span>
<span class="c1">#         self._observe(start=self.slider_start.value,end=self.slider_end.value)</span>

<span class="c1">#     def display(self):</span>
<span class="c1">#         display(self.slider_start,self.slider_end)</span>

<span class="c1">#     def _observe(self,**kwargs):</span>
<span class="c1">#         if hasattr(self,&#39;observe&#39;):</span>
<span class="c1">#             self.observe(**kwargs)</span>

<span class="c1"># def fct(start,end):</span>
<span class="c1">#     print (start,end)</span>
    
<span class="c1">#     start=int(start.timestamp() * 1000)</span>
<span class="c1">#     end=int(end.timestamp() * 1000)</span>

<span class="c1">#     df=pd.read_csv(&#39;temp2.csv&#39;)</span>

<span class="c1">#     df.rename(columns={ df.columns[0]: &quot;dd&quot; }, inplace = True)</span>
<span class="c1">#     df[&#39;dd_str&#39;]=df[&#39;dd&#39;].astype(str)</span>
<span class="c1">#     df[&#39;dd_str&#39;] = df[&#39;dd_str&#39;].astype(str)</span>
<span class="c1">#     df.rename(columns={ df.columns[1]: &quot;val&quot; }, inplace = True)</span>
<span class="c1">#     df[&#39;dd&#39;]= pd.to_datetime(df[&#39;dd&#39;].astype(str), format=&#39;%Y-%m-%d&#39;)</span>
<span class="c1">#     df.insert(df.shape[1],</span>
<span class="c1">#             &#39;row_count&#39;,</span>
<span class="c1">#             df.index.value_counts().sort_index().cumsum())</span>
<span class="c1">#     #df=df.set_index(&#39;dd&#39;)</span>
<span class="c1">#     #df.index = pd.DatetimeIndex(df.index)</span>
<span class="c1">#     df.dd_str = pd.DatetimeIndex(df.dd_str)</span>
<span class="c1">#     df[&#39;dd_int&#39;] = [int(i.timestamp()*1000) for i in df.dd_str]</span>
<span class="c1">#     import numpy as np </span>
<span class="c1">#     def find_nearest(array, value):</span>
<span class="c1">#         array = np.asarray(array)</span>
<span class="c1">#         idx = (np.abs(array - value)).argmin()</span>
<span class="c1">#         return array[idx]</span>
<span class="c1">#     s=find_nearest(np.array(df.dd_int), start)</span>
<span class="c1">#     e=find_nearest(np.array(df.dd_int), end)</span>

<span class="c1">#     s=(df[df[&#39;dd_int&#39;]==s].index)</span>
<span class="c1">#     e=(df[df[&#39;dd_int&#39;]==e].index)</span>

<span class="c1">#     df_filter=df[s[0]:e[0]]</span>
<span class="c1">#     print(df_filter)</span>
<span class="c1">#     return (start, end)</span>
    
<span class="c1"># w=DateRangePicker(start=&#39;2022-08-02&#39;,end=&quot;2022-09-02&quot;,freq=&#39;D&#39;,fmt=&#39;%Y-%m-%d&#39;)</span>
<span class="c1"># w.observe=fct</span>
<span class="c1"># w.display()</span>

<span class="c1"># #a=fct[0]</span>
<span class="c1"># print(w.observe[0])</span>

<span class="c1">############################################################</span>


<div class="viewcode-block" id="akhdefo_fitPlane">
<a class="viewcode-back" href="../../akhdefo_functions.html#akhdefo_functions.Akhdefo_Tools.akhdefo_fitPlane">[docs]</a>
<span class="k">def</span> <span class="nf">akhdefo_fitPlane</span><span class="p">(</span><span class="n">dem_data</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">line_shapefile</span><span class="o">=</span><span class="kc">None</span> <span class="p">,</span> <span class="n">out_planeFolder</span><span class="o">=</span><span class="s1">&#39;Planes_out&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fit planes to points in a Digital Elevation Model (DEM) and visualize the results.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        - dem_data (str): Path to the DEM data file (GeoTIFF format).</span>
<span class="sd">        - line_shapefile (str): Path to the shapefile containing line features representing planes.</span>
<span class="sd">        - out_planeFolder (str): Path to the folder where the output plane data will be saved.</span>

<span class="sd">    How It Works:</span>
<span class="sd">        This function reads a DEM and shapefile, allows the user to interactively select points from the DEM,</span>
<span class="sd">        fits planes to the selected points, and visualizes the results in 2D and 3D plots. It also provides options</span>
<span class="sd">        to save the fitted planes as XYZ and DXF files. additionally plots poles to planes on polar grid and rose diagram for strike/trends of planes</span>

<span class="sd">    Note:</span>
<span class="sd">        - The function utilizes various libraries such as numpy, matplotlib, tkinter, osgeo (GDAL), and geopandas.</span>
<span class="sd">        - Ensure that the required libraries and dependencies are installed to use this function effectively.</span>

<span class="sd">    Example Usage:</span>
<span class="sd">        akhdefo_fitPlane(dem_data=&#39;path/to/dem.tif&#39;,line_shapefile=&#39;path/to/lines.shp&#39;,out_planeFolder=&#39;output/folder&#39;)</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">global</span> <span class="n">dip_angle_list</span><span class="p">,</span> <span class="n">dip_direction_list</span> <span class="p">,</span> <span class="n">fig1_cmap</span><span class="p">,</span> <span class="n">plane_colors</span>
    
    <span class="n">dip_angle_list</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">dip_direction_list</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">plane_colors</span><span class="o">=</span><span class="p">[]</span>
    
    <span class="c1"># def cmap_plot(plane_colors,  label=&#39;Color&#39;):</span>
        
    <span class="c1">#     from matplotlib.colors import ListedColormap</span>
    <span class="c1">#     import numpy as np</span>
    <span class="c1">#     try:</span>
    <span class="c1">#         cmap = ListedColormap(plane_colors)</span>
    <span class="c1">#         fig, ax = plt.subplots(figsize=(6, 1))</span>
    <span class="c1">#         fig.subplots_adjust(bottom=0.5)</span>
    <span class="c1">#         cbar = plt.colorbar(plt.cm.ScalarMappable(cmap=cmap), cax=ax, orientation=&#39;horizontal&#39;)</span>
    <span class="c1">#         cbar.set_label(label)</span>
    <span class="c1">#         plt.show()</span>
    <span class="c1">#     except Exception as ex:</span>
    <span class="c1">#         print(&quot;&quot;)</span>
        
    <span class="c1">#     return fig</span>
    
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
    <span class="kn">from</span> <span class="nn">osgeo</span> <span class="kn">import</span> <span class="n">gdal</span>
    <span class="kn">import</span> <span class="nn">tkinter</span> <span class="k">as</span> <span class="nn">tk</span>
    <span class="kn">from</span> <span class="nn">tkinter</span> <span class="kn">import</span> <span class="n">ttk</span>
    <span class="kn">from</span> <span class="nn">matplotlib.backends.backend_tkagg</span> <span class="kn">import</span> <span class="n">FigureCanvasTkAgg</span>
    <span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">LightSource</span>
    <span class="kn">import</span> <span class="nn">earthpy.spatial</span> <span class="k">as</span> <span class="nn">es</span>
    <span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
    <span class="kn">import</span> <span class="nn">random</span>
    <span class="kn">from</span> <span class="nn">matplotlib.backends.backend_tkagg</span> <span class="kn">import</span> <span class="n">NavigationToolbar2Tk</span>
    <span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">LineString</span>
    
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">out_planeFolder</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">out_planeFolder</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">color_from_dip_and_direction</span><span class="p">(</span><span class="n">dip</span><span class="p">,</span> <span class="n">direction</span><span class="p">):</span>
        <span class="n">cmap_dip</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;hsv&#39;</span><span class="p">)</span>
        <span class="n">cmap_direction</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;hsv&#39;</span><span class="p">)</span>

        <span class="n">col_dip</span> <span class="o">=</span> <span class="n">cmap_dip</span><span class="p">(</span><span class="n">dip</span> <span class="o">/</span> <span class="mf">90.0</span><span class="p">)</span>
        <span class="n">col_direction</span> <span class="o">=</span> <span class="n">cmap_direction</span><span class="p">(</span><span class="n">direction</span> <span class="o">/</span> <span class="mf">360.0</span><span class="p">)</span>

        <span class="n">color</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">col_dip</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">col_direction</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
    
        <span class="k">return</span> <span class="n">color</span>

    <span class="k">def</span> <span class="nf">random_color</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a random color.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">read_dem</span><span class="p">(</span><span class="n">dem_file</span><span class="p">):</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">dem_file</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">ReadAsArray</span><span class="p">()</span>
        <span class="n">transform</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetGeoTransform</span><span class="p">()</span>
        <span class="n">projection</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetProjection</span><span class="p">()</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Close the dataset</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">projection</span>
    
    <span class="n">data</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">projection</span> <span class="o">=</span> <span class="n">read_dem</span><span class="p">(</span><span class="n">dem_data</span><span class="p">)</span>
    
    <span class="kn">import</span> <span class="nn">math</span>

    <span class="k">def</span> <span class="nf">calculate_dip_angle_and_direction</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">):</span>
        <span class="c1"># Calculate the dip angle (inclination)</span>
        <span class="n">dip_angle</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">atan</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">A</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">B</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>
       
        
        <span class="c1"># Calculate the dip direction (azimuth)</span>
        <span class="n">dip_direction</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="o">-</span><span class="n">B</span><span class="p">,</span> <span class="o">-</span><span class="n">A</span><span class="p">))</span>
        
        <span class="c1"># Ensure dip_direction is in the range [0, 360)</span>
        <span class="n">dip_direction</span> <span class="o">=</span> <span class="p">(</span><span class="n">dip_direction</span> <span class="o">+</span> <span class="mi">90</span><span class="p">)</span> <span class="o">%</span> <span class="mi">360</span>
        
        <span class="k">return</span> <span class="n">dip_angle</span><span class="p">,</span> <span class="n">dip_direction</span>
    
    <span class="k">def</span> <span class="nf">fit_plane</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">):</span>
        <span class="n">min_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">max_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        
        <span class="c1"># xx = (xx - np.nanmin(xx)) / (np.nanmax(xx) - np.nanmin(xx))</span>
        <span class="c1"># xx = xx * (max_range - min_range) + min_range</span>
        
        <span class="c1"># yy = (yy - np.nanmin(yy)) / (np.nanmax(yy) - np.nanmin(yy))</span>
        <span class="c1"># yy = yy * (max_range - min_range) + min_range</span>
        
        <span class="n">x_vals</span><span class="p">,</span> <span class="n">y_vals</span><span class="p">,</span> <span class="n">z_vals</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">points</span><span class="p">)</span>
    
        <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">y_vals</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_vals</span><span class="p">))])</span><span class="o">.</span><span class="n">T</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">z_vals</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plane equation: z = </span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s2">x + </span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s2">y + </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># Debugging line</span>
        
        <span class="n">zz</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">xx</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">yy</span> <span class="o">+</span> <span class="n">c</span>
        <span class="c1">##################################</span>
        <span class="c1"># points = np.array(points) </span>
        <span class="c1"># # Compute the centroid of the points</span>
        <span class="c1"># centroid = np.mean(points, axis=0)</span>

        <span class="c1"># # Subtract the centroid from the points to center them</span>
        <span class="c1"># centered_points = points - centroid</span>

        <span class="c1"># # Perform SVD on the centered points</span>
        <span class="c1"># U, S, Vt = np.linalg.svd(centered_points)</span>

        <span class="c1"># # The normal vector of the plane is the last row of Vt</span>
        <span class="c1"># normal_vector = Vt[-1, :]</span>

        <span class="c1"># # Normalize the normal vector</span>
        <span class="c1"># normal_vector /= np.linalg.norm(normal_vector)</span>

        <span class="c1"># # The equation of the plane is: ax + by + cz + d = 0, where [a, b, c] is the normal vector</span>
        <span class="c1"># a, b, c = normal_vector</span>

        <span class="c1"># # Calculate d using the plane equation and the centroid</span>
        <span class="c1"># d = -np.dot(normal_vector, centroid)</span>
        <span class="c1"># zz = (-a * xx - b * yy - d) / c  # Solve for z</span>
        
       
        <span class="n">dip_angle</span><span class="p">,</span> <span class="n">dip_direction</span> <span class="o">=</span> <span class="n">calculate_dip_angle_and_direction</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dip Angle (Inclination): </span><span class="si">{</span><span class="n">dip_angle</span><span class="si">}</span><span class="s2"> degrees&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dip Direction (Azimuth): </span><span class="si">{</span><span class="n">dip_direction</span><span class="si">}</span><span class="s2"> degrees&quot;</span><span class="p">)</span>
        
        
        
       
        
        <span class="c1">#  # Clip the values to the desired range</span>
        <span class="c1">#zz = np.clip(zz, min_range, max_range)</span>
        
        <span class="n">zz</span><span class="p">[</span><span class="n">zz</span> <span class="o">&lt;</span> <span class="n">min_range</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">zz</span><span class="p">[</span><span class="n">zz</span> <span class="o">&gt;</span> <span class="n">max_range</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
       
       
        <span class="c1"># # Define the desired range based on your &#39;data&#39;</span>
        <span class="c1"># if limit_extend==False:</span>
           
        <span class="c1"># # # # Normalize &#39;zz&#39; to match the &#39;min_range&#39; and &#39;max_range&#39; of &#39;data&#39;</span>
        <span class="c1"># zz = (zz - np.nanmin(zz)) / (np.nanmax(zz) - np.nanmin(zz))</span>
        <span class="c1"># zz = zz * (max_range - min_range) + min_range</span>
        
               
        <span class="c1"># print(zz.shape)</span>
        <span class="c1"># print(zz)</span>
        <span class="k">return</span> <span class="n">zz</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">dip_angle</span><span class="p">,</span> <span class="n">dip_direction</span>
    
   
   
   

    <span class="k">def</span> <span class="nf">onclick</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">transform</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">xdata</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">ydata</span>
        <span class="n">col</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">transform</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">transform</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">row</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="n">transform</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">/</span> <span class="n">transform</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>

        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span>
            <span class="n">points</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">])</span>
            <span class="n">ax_2d</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
            <span class="n">canvas_2d</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>

            <span class="n">point_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;x=</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, y=</span><span class="si">{</span><span class="n">y</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, z=</span><span class="si">{</span><span class="n">z</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">points_listbox</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">tk</span><span class="o">.</span><span class="n">END</span><span class="p">,</span> <span class="n">point_str</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_point_double_click</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">points</span><span class="p">,</span> <span class="n">ax_2d</span><span class="p">,</span> <span class="n">points_listbox</span><span class="p">,</span> <span class="n">hs</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">points_listbox</span><span class="o">.</span><span class="n">curselection</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Index of selected point in the listbox</span>
        <span class="n">point</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        
        <span class="c1"># Remove the point from our data</span>
        <span class="n">points</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="n">points_listbox</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

        <span class="c1"># Identify and remove the corresponding point from the ax_2d plot</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">ax_2d</span><span class="o">.</span><span class="n">lines</span><span class="p">:</span>
            <span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">get_xdata</span><span class="p">(),</span> <span class="n">line</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">xdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">ydata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">line</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
                <span class="k">break</span>

        <span class="n">canvas_2d</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        
        
    
    
    <span class="k">def</span> <span class="nf">plot_planes</span><span class="p">(</span><span class="n">dip_list</span><span class="p">,</span> <span class="n">azimuth_list</span><span class="p">,</span> <span class="n">rgb_colors</span><span class="p">,</span> <span class="n">out_planeFolder</span><span class="o">=</span><span class="n">out_planeFolder</span><span class="p">):</span>
        <span class="c1">#from mplstereonet import StereonetAxes</span>
         <span class="c1"># Create a stereo net plot</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="c1">#ax = fig.add_subplot(121, projection=&#39;stereonet&#39;)</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">,</span> <span class="n">polar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">dip_angles</span><span class="p">,</span> <span class="n">dip_directions</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dip_list</span><span class="p">,</span> <span class="n">azimuth_list</span><span class="p">,</span> <span class="n">rgb_colors</span><span class="p">):</span>
            <span class="c1"># Convert dip directions and dip angles to radians</span>
            <span class="c1">#dip_directions = (dip_directions + 90) % 360 #converted dip direction to strike</span>
            <span class="n">dip_angles</span> <span class="o">=</span> <span class="p">(</span><span class="mi">90</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dip_angles</span><span class="p">))</span>  <span class="c1"># Convert dip angles to complementary angles</span>
             <span class="c1"># Convert dip azimuths to radians</span>
            <span class="n">dip_azimuths_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">dip_directions</span><span class="p">)</span>
            <span class="c1"># Plot the poles of planes as dots</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">dip_azimuths_rad</span><span class="p">,</span> <span class="n">dip_angles</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>   

        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_theta_zero_location</span><span class="p">(</span><span class="s1">&#39;N&#39;</span><span class="p">)</span>  <span class="c1"># Set 0 degrees at the top</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_theta_direction</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Reverse the direction of the angles</span>

        <span class="c1"># Set labels for cardinal directions</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">135</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">225</span><span class="p">,</span> <span class="mi">270</span><span class="p">,</span> <span class="mi">315</span><span class="p">]))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;NE&#39;</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;SE&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="s1">&#39;SW&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">,</span> <span class="s1">&#39;NW&#39;</span><span class="p">])</span>

        <span class="c1"># Set the radial grid and labels</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_rlabel_position</span><span class="p">(</span><span class="mi">90</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="mi">15</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">75</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_rmax</span><span class="p">(</span><span class="mi">90</span><span class="p">)</span>  <span class="c1"># Set the maximum radial distance</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Poles to Planes&quot;</span><span class="p">)</span>
        <span class="c1"># Customize tick marks - specify angles in radians</span>
        <span class="c1"># ax.set_xticks(np.radians(range(0, 360, 10)))  # 10-degree intervals</span>
        <span class="c1"># ax.set_yticks(np.radians(range(-90, 90, 10)))</span>

        <span class="n">strikes</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">all_colors</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">dip_angles</span><span class="p">,</span> <span class="n">dip_directions</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dip_list</span><span class="p">,</span> <span class="n">azimuth_list</span><span class="p">,</span> <span class="n">rgb_colors</span><span class="p">):</span>
            <span class="n">dip_azimuths_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">dip_directions</span><span class="p">)</span>
            <span class="c1">#dip_directions = (dip_directions + 90) % 360</span>
            <span class="n">dip_angles</span> <span class="o">=</span> <span class="p">(</span><span class="mi">90</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dip_angles</span><span class="p">))</span>  <span class="c1"># Convert dip angles to complementary angles</span>
            <span class="n">strikes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">dip_azimuths_rad</span> <span class="o">+</span> <span class="mi">90</span><span class="p">)</span> <span class="o">%</span> <span class="mi">360</span><span class="p">)</span>
            <span class="n">all_colors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
        

         <span class="c1"># Calculate the number of bins using Scott&#39;s Rule</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">strikes</span><span class="p">)</span>

        <span class="c1"># Calculate the standard deviation of the data</span>
        <span class="n">std_dev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">strikes</span><span class="p">)</span>

        <span class="c1"># Calculate the bin width using Scott&#39;s Rule formula, ensuring it&#39;s not zero</span>
        <span class="k">if</span> <span class="n">std_dev</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">bin_width</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">std_dev</span> <span class="o">/</span> <span class="p">(</span><span class="n">n</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">))</span>  <span class="c1"># Scott&#39;s Rule formula</span>
            <span class="n">num_bins</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">((</span><span class="nb">max</span><span class="p">(</span><span class="n">strikes</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">strikes</span><span class="p">))</span> <span class="o">/</span> <span class="n">bin_width</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Ensure num_bins is at least 1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num_bins</span> <span class="o">=</span> <span class="mi">12</span>  <span class="c1"># A default number of bins if std_dev is zero</span>
        <span class="c1"># Create a rose diagram (circular histogram)</span>
        <span class="n">ax_rose</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">,</span> <span class="n">polar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">dip</span><span class="p">,</span> <span class="n">strike</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">az</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dip_list</span><span class="p">,</span> <span class="n">strikes</span><span class="p">,</span> <span class="n">all_colors</span><span class="p">,</span> <span class="n">azimuth_list</span><span class="p">):</span>
            <span class="c1"># Convert dip azimuths to radians</span>
            <span class="n">dip_azimuths_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">az</span><span class="p">)</span>
            <span class="n">dip_angles</span> <span class="o">=</span> <span class="p">(</span><span class="mi">90</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dip_angles</span><span class="p">))</span>  <span class="c1"># Convert dip angles to complementary angles</span>
            
            <span class="c1"># Plot dip angles as radii and dip azimuths as angles</span>
            <span class="c1">#ax_rose.scatter(dip_azimuths_rad, dip_angles, c=color, alpha=0.5)</span>
            <span class="c1"># Plot the orientation data as a rose diagram</span>
            <span class="n">n</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">patches</span><span class="o">=</span><span class="n">ax_rose</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">strike</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">num_bins</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
             <span class="c1"># Annotate the number of data points and bin number</span>
            <span class="n">ax_rose</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Data Points: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">strikes</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax_rose</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
            <span class="n">ax_rose</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.15</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Bin Count: </span><span class="si">{</span><span class="n">num_bins</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax_rose</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>

        <span class="c1"># # Customize the rose diagram</span>
        <span class="c1"># ax_rose.set_theta_zero_location(&quot;N&quot;)</span>
        <span class="c1"># ax_rose.set_theta_direction(-1)</span>
        <span class="c1"># Customize the polar plot</span>
        <span class="n">ax_rose</span><span class="o">.</span><span class="n">set_theta_zero_location</span><span class="p">(</span><span class="s1">&#39;N&#39;</span><span class="p">)</span>  <span class="c1"># Set 0 degrees at the top</span>
        <span class="n">ax_rose</span><span class="o">.</span><span class="n">set_theta_direction</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Reverse the direction of the angles</span>

        <span class="c1"># Set labels for cardinal directions</span>
        <span class="n">ax_rose</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">135</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">225</span><span class="p">,</span> <span class="mi">270</span><span class="p">,</span> <span class="mi">315</span><span class="p">]))</span>
        <span class="n">ax_rose</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;NE&#39;</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;SE&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="s1">&#39;SW&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">,</span> <span class="s1">&#39;NW&#39;</span><span class="p">])</span>
       

        <span class="c1"># Set the radial grid and labels</span>
        <span class="c1"># ax_rose.set_rlabel_position(90)</span>
        <span class="c1"># ax_rose.set_yticks([15, 30, 45, 60, 75])</span>
        <span class="c1"># ax_rose.set_rmax(90)  # Set the maximum radial distance</span>
        <span class="n">ax_rose</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Rose Diagram Strike&quot;</span><span class="p">)</span>

        <span class="c1"># Adjust spacing between subplots</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">out_planeFolder</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="s2">&quot;stereoplot.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span>
        <span class="c1">#plt.close()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
    
    
        
    <span class="k">def</span> <span class="nf">draw_plane</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span><span class="n">yy</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">fitted_plane</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="p">,</span> <span class="n">dip_angle</span><span class="p">,</span> <span class="n">dip_direction</span> <span class="o">=</span> <span class="n">fit_plane</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">)</span>
            
            <span class="n">dip_angle_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dip_angle</span><span class="p">)</span>
            <span class="n">dip_direction_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dip_direction</span><span class="p">)</span>
            
            <span class="c1"># if limit_extend:</span>
            <span class="c1">#  #Get bounding box of the selected points</span>
            <span class="c1">#     xmin, xmax, ymin, ymax = bounding_box(points)</span>
                
            <span class="c1">#     mask = (xx &gt;= xmin) &amp; (xx &lt;= xmax) &amp; (yy &gt;= ymin) &amp; (yy &lt;= ymax)</span>
                
            <span class="c1">#     for i in range(xx.shape[0]):</span>
            <span class="c1">#         for j in range(xx.shape[1]):</span>
            <span class="c1">#             if not mask[i, j]:</span>
            <span class="c1">#                 fitted_plane[i, j] = np.nan  # Set out-of-bounds values to NaN</span>
        
            <span class="n">planes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fitted_plane</span><span class="p">)</span>
            
            <span class="c1">#plane_color = random_color()</span>
            <span class="n">plane_color</span><span class="o">=</span><span class="n">color_from_dip_and_direction</span><span class="p">(</span><span class="n">dip_angle</span><span class="p">,</span> <span class="n">dip_direction</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;plane color: &#39;</span><span class="p">,</span> <span class="n">plane_color</span><span class="p">)</span>
            <span class="n">plane_colors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plane_color</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">point</span>  <span class="ow">in</span> <span class="n">points</span><span class="p">:</span>
                <span class="n">ax_2d</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">plane_color</span> <span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
          
            
        
            <span class="n">canvas_2d</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
            

            <span class="c1">#ax_3d.clear()</span>
            <span class="n">ax_3d</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;3D DEM with Fitted Planes&#39;</span><span class="p">)</span>
            <span class="n">ax_3d</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;terrain&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">antialiased</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="c1">#for plane in planes:</span>
            <span class="n">surf</span><span class="o">=</span><span class="n">ax_3d</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">fitted_plane</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">antialiased</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">plane_color</span><span class="p">)</span>
            
                <span class="c1">#plot points in 3D</span>
            <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">points</span><span class="p">:</span>
                <span class="n">ax_3d</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">plane_color</span><span class="p">)</span>
                
            <span class="n">canvas_3d</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
            
            
            

            <span class="n">points_listbox</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tk</span><span class="o">.</span><span class="n">END</span><span class="p">)</span>
            <span class="n">points</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            
            <span class="n">plot_planes</span><span class="p">(</span><span class="n">dip_angle_list</span><span class="p">,</span> <span class="n">dip_direction_list</span><span class="p">,</span> <span class="n">plane_colors</span><span class="p">)</span>
            
            <span class="c1"># Assuming you have a &#39;planes&#39; list, you can check its format</span>
            <span class="c1"># for plane in planes:</span>
            <span class="c1">#     print(type(plane))</span>
            <span class="c1">#     print(len(plane))  # This will give you the length or number of elements in the plane</span>

            <span class="c1">#     # If it&#39;s a NumPy array, you can print its shape to see the dimensions</span>
            <span class="c1">#     if isinstance(plane, np.ndarray):</span>
            <span class="c1">#         print(plane.shape)</span>
                
            <span class="c1">#     # Print the first element (assuming it&#39;s a list or NumPy array)</span>
            <span class="c1">#     print(plane[0])</span>

            <span class="c1"># # Print the length of the &#39;planes&#39; list</span>
            <span class="c1"># print(len(planes))</span>
            
            
            
        

    <span class="k">def</span> <span class="nf">bounding_box</span><span class="p">(</span><span class="n">points</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find the bounding box for a set of points.&quot;&quot;&quot;</span>
        <span class="n">x_vals</span><span class="p">,</span> <span class="n">y_vals</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">points</span><span class="p">)</span>
        
        
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">x_vals</span><span class="p">)</span> <span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">x_vals</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">y_vals</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">y_vals</span><span class="p">)</span>

    <span class="c1">########</span>

   
    
    <span class="kn">import</span> <span class="nn">ezdxf</span>
    <span class="kn">from</span> <span class="nn">scipy.spatial</span> <span class="kn">import</span> <span class="n">Delaunay</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">os</span>

    <span class="k">def</span> <span class="nf">list_xyz_files_in_folder</span><span class="p">(</span><span class="n">folder_path</span><span class="p">):</span>
        <span class="n">xyz_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.xyz&quot;</span><span class="p">):</span>
                <span class="n">xyz_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">xyz_files</span>

    <span class="k">def</span> <span class="nf">create_dxf_from_xyz_files</span><span class="p">(</span><span class="n">xyz_files</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">single</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="n">single</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
             <span class="c1"># Create a new DXF document</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="n">ezdxf</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>

            <span class="c1"># Create a new DXF model space</span>
            <span class="n">msp</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">modelspace</span><span class="p">()</span>
            
           

        <span class="k">for</span> <span class="n">xyz_file</span> <span class="ow">in</span> <span class="n">xyz_files</span><span class="p">:</span>
            
            <span class="k">if</span> <span class="n">single</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Create a new DXF document</span>
                <span class="n">doc</span> <span class="o">=</span> <span class="n">ezdxf</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>

                <span class="c1"># Create a new DXF model space</span>
                <span class="n">msp</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">modelspace</span><span class="p">()</span>
            <span class="c1"># Load XYZ data from a file</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">xyz_file</span><span class="p">)</span>
            

            <span class="c1"># Separate the XYZ data into individual arrays</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>

            <span class="c1"># Create a Delaunay triangulation of the points</span>
            <span class="n">tri</span> <span class="o">=</span> <span class="n">Delaunay</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)))</span>

            <span class="c1"># Add the triangles to the model space</span>
            <span class="k">for</span> <span class="n">simplex</span> <span class="ow">in</span> <span class="n">tri</span><span class="o">.</span><span class="n">simplices</span><span class="p">:</span>
                <span class="n">vertices</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">simplex</span><span class="p">]</span>
                <span class="n">msp</span><span class="o">.</span><span class="n">add_3dface</span><span class="p">(</span><span class="n">points</span><span class="o">=</span><span class="n">vertices</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">single</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Save the DXF file</span>
                <span class="n">doc</span><span class="o">.</span><span class="n">saveas</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">single</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 

            <span class="c1"># Save the DXF file</span>
            <span class="n">doc</span><span class="o">.</span><span class="n">saveas</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
        
    
    <span class="k">def</span> <span class="nf">save_planes_to_obj</span><span class="p">():</span>
        <span class="n">x_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">y_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_coords</span><span class="p">,</span> <span class="n">y_coords</span><span class="p">)</span>
       
        <span class="k">if</span> <span class="ow">not</span> <span class="n">planes</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No planes to save.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        
        <span class="n">output_filename_dxf</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">out_planeFolder</span><span class="si">}</span><span class="s2">/planes.dxf&quot;</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">plane</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">planes</span><span class="p">):</span>
            <span class="n">output_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">out_planeFolder</span><span class="si">}</span><span class="s2">/planes_</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">.xyz&quot;</span>
            <span class="n">output_filename_idx</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">out_planeFolder</span><span class="si">}</span><span class="s2">/planes_</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">.dxf&quot;</span>
            
            <span class="c1"># Initialize lists to store vertices and faces</span>
            <span class="n">vertices</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="c1"># Sampled point interval</span>
            <span class="n">sample_interval</span> <span class="o">=</span> <span class="mi">200</span>
            
            <span class="c1"># Open the XYZ file for writing</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">xyz_file</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">plane</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sample_interval</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">plane</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sample_interval</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="n">x</span> <span class="o">=</span> <span class="n">xx</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                            <span class="n">y</span> <span class="o">=</span> <span class="n">yy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                            <span class="n">z</span> <span class="o">=</span> <span class="n">plane</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>

                            <span class="c1"># Check for NaN values</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
                                <span class="c1"># Add the vertex to the list</span>
                                <span class="n">vertices</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span>
                               
                                <span class="c1"># Write vertex data to the XYZ file</span>
                                <span class="n">xyz_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">z</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            
            <span class="n">create_dxf_from_xyz_files</span><span class="p">(</span><span class="n">list_xyz_files_in_folder</span><span class="p">(</span><span class="n">out_planeFolder</span><span class="p">),</span> <span class="n">output_filename_idx</span><span class="p">,</span> <span class="n">single</span><span class="o">=</span><span class="n">idx</span><span class="p">)</span>
            
                  
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;zz values saved to </span><span class="si">{</span><span class="n">output_filename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            
        
   
        
        
    <span class="k">def</span> <span class="nf">collect_points_from_line</span><span class="p">(</span><span class="n">gdf</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Collect start, middle, and end points from each line feature.&quot;&quot;&quot;</span>
        <span class="n">collected_points</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">geometry</span> <span class="ow">in</span> <span class="n">gdf</span><span class="o">.</span><span class="n">geometry</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">geometry</span><span class="o">.</span><span class="n">geom_type</span> <span class="o">==</span> <span class="s2">&quot;LineString&quot;</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">xy</span>
                <span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                
                <span class="c1">#print(&#39;start: &#39; ,start)</span>
                
                <span class="c1"># # Create a LineString from coordinates to easily get a point at 50% distance</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">LineString</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
                <span class="c1"># if len(line.coords) &gt;= 3:</span>
                <span class="c1">#     # If the line has more than 2 vertices, collect points at vertices</span>
                <span class="c1">#     vertices = list(line.coords)</span>
                <span class="c1">#     #print(&#39;vertics: &#39;, vertices)</span>
                <span class="c1">#     vertex_list=[i for i in vertices]</span>
                <span class="c1">#     for kj in vertex_list:</span>
                <span class="c1">#         collected_points.append(kj)</span>
                <span class="c1">#     #collected_points.extend(vertices)</span>
                <span class="c1"># else:</span>
                    
                <span class="n">middle</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">normalized</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">p2</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">normalized</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">p1</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">normalized</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">collected_points</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">start</span><span class="p">,</span> <span class="n">middle</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">collected_points</span>

    <span class="c1"># def collect_points_from_line(gdf):</span>
    <span class="c1">#     # Initialize an empty list to store the coordinates</span>
    <span class="c1">#     collected_points = []</span>

    <span class="c1">#     # Iterate through the GeoDataFrame</span>
    <span class="c1">#     for geometry in gdf[&#39;geometry&#39;]:</span>
    <span class="c1">#         if isinstance(geometry, LineString):</span>
    <span class="c1">#             # Count the number of vertices in the LineString</span>
    <span class="c1">#             num_vertices = len(geometry.coords)</span>
                
    <span class="c1">#             # Check if the LineString is straight (3 or fewer vertices)</span>
    <span class="c1">#             if num_vertices &lt;= 3:</span>
    <span class="c1">#                 # For straight lines, take coordinates of start, end, and middle</span>
    <span class="c1">#                 start_point = geometry.coords[0]</span>
    <span class="c1">#                 end_point = geometry.coords[-1]</span>
    <span class="c1">#                 middle_point = geometry.interpolate(0.5, normalized=True).coords[0]</span>
                    
    <span class="c1">#                 collected_points.extend([start_point, middle_point, end_point])</span>
    <span class="c1">#             else:</span>
    <span class="c1">#                 # For curved lines, take coordinates of all vertices</span>
    <span class="c1">#                 for point in geometry.coords:</span>
    <span class="c1">#                     x, y = point</span>
    <span class="c1">#                     collected_points.append((x, y))</span>
        
    <span class="c1">#     return collected_points</span>

<span class="c1"># Now, coordinates_list contains the coordinates of start, end, middle, and all vertices</span>
<span class="c1"># based on whether the line is straight (3 or fewer vertices) or curved</span>
        
    

    <span class="k">def</span> <span class="nf">draw_planes_from_lines</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span><span class="n">yy</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">ax_2d</span><span class="p">,</span> <span class="n">ax_3d</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">planes</span> 
        
        <span class="n">data</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">projection</span> <span class="o">=</span> <span class="n">read_dem</span><span class="p">(</span><span class="n">dem_data</span><span class="p">)</span>

        <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">line_shapefile</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">gdf</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span> <span class="o">!=</span> <span class="n">projection</span><span class="p">:</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">projection</span><span class="p">)</span>

        <span class="n">point_sets</span> <span class="o">=</span> <span class="n">collect_points_from_line</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span>
        <span class="c1"># x_coords = np.linspace(left, right, data.shape[1])</span>
        <span class="c1"># y_coords = np.linspace(top, bottom, data.shape[0])</span>
        <span class="c1"># xx, yy = np.meshgrid(x_coords, y_coords)</span>
        
        <span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
        <span class="n">planes</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">points</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">point_sets</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Processing fitted planes&quot;</span><span class="p">):</span>
            <span class="c1">#print(&#39;points: &#39;, points)</span>
            <span class="c1">#z_values = [data[int((point[1] - top) / abs(transform[5])), int((point[0] - left) / transform[1])] for point in points]</span>
            
            <span class="n">z_values</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">points</span><span class="p">:</span>
                <span class="n">y_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">top</span><span class="p">)</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">transform</span><span class="p">[</span><span class="mi">5</span><span class="p">]))</span>
                <span class="c1"># y_index = int((point[1] - top) / abs(transform[5])) if isinstance(point[1], (int, float)) and isinstance(transform[5], (int, float)) else None</span>
                <span class="c1"># x_index = int((point[0] - top) / abs(transform[1])) if isinstance(point[0], (int, float)) and isinstance(transform[1], (int, float)) else None</span>

                <span class="n">x_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">left</span><span class="p">)</span> <span class="o">/</span> <span class="n">transform</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                
                <span class="n">z_value</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">y_index</span><span class="p">][</span><span class="n">x_index</span><span class="p">]</span>
                
                <span class="n">z_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z_value</span><span class="p">)</span>

            <span class="n">xyz_points</span> <span class="o">=</span> <span class="p">[</span><span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">z_values</span><span class="p">[</span><span class="n">i</span><span class="p">],)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">z_values</span><span class="p">))]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xyz_points</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">fitted_plane</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">dip_angle</span><span class="p">,</span> <span class="n">dip_direction</span> <span class="o">=</span> <span class="n">fit_plane</span><span class="p">(</span><span class="n">xyz_points</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">)</span>
                
                <span class="n">dip_angle_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dip_angle</span><span class="p">)</span>
                <span class="n">dip_direction_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dip_direction</span><span class="p">)</span>
            
                <span class="c1"># if limit_extend:</span>
                <span class="c1">#     # Get bounding box of the selected points</span>
                <span class="c1">#     xmin, xmax, ymin, ymax = bounding_box(xyz_points)</span>
                    
                <span class="c1">#     mask = (xx &gt;= xmin) &amp; (xx &lt;= xmax) &amp; (yy &gt;= ymin) &amp; (yy &lt;= ymax)</span>
                    
                <span class="c1">#     for i in range(xx.shape[0]):</span>
                <span class="c1">#         for j in range(xx.shape[1]):</span>
                <span class="c1">#             if not mask[i, j]:</span>
                <span class="c1">#                 fitted_plane[i, j] = np.nan  # Set out-of-bounds values to NaN</span>
                <span class="c1">###########</span>
                
                <span class="c1">#########</span>
            
                <span class="n">planes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fitted_plane</span><span class="p">)</span>
                <span class="c1">#plane_color = random_color()</span>
                <span class="n">plane_color</span><span class="o">=</span><span class="n">color_from_dip_and_direction</span><span class="p">(</span><span class="n">dip_angle</span><span class="p">,</span> <span class="n">dip_direction</span><span class="p">)</span>
                <span class="n">plane_colors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plane_color</span><span class="p">)</span>
                
                
        
            <span class="c1">####</span>
                <span class="k">for</span> <span class="n">pointn</span> <span class="ow">in</span> <span class="n">xyz_points</span><span class="p">:</span>
                    <span class="n">ax_2d</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pointn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pointn</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">plane_color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
                <span class="n">canvas_2d</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>

                <span class="c1">#ax_3d.clear()</span>
                <span class="n">ax_3d</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;3D DEM with Fitted Planes&#39;</span><span class="p">)</span>
                <span class="n">ax_3d</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;terrain&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">antialiased</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="c1">#for plane in planes:</span>
                <span class="n">ax_3d</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">fitted_plane</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">antialiased</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">plane_color</span><span class="p">)</span>
                <span class="n">canvas_3d</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
                
                <span class="n">plot_planes</span><span class="p">(</span><span class="n">dip_angle_list</span><span class="p">,</span> <span class="n">dip_direction_list</span><span class="p">,</span> <span class="n">plane_colors</span><span class="p">)</span>
            
        
    

    <span class="k">def</span> <span class="nf">plot_dem</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">projection</span><span class="p">,</span> <span class="n">path_to_shapefile</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">ax_2d</span><span class="p">,</span> <span class="n">ax_3d</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">canvas_2d</span><span class="p">,</span> <span class="n">canvas_3d</span><span class="p">,</span> <span class="n">points_listbox</span><span class="p">,</span> <span class="n">planes</span><span class="p">,</span> <span class="n">plane_colors</span><span class="p">,</span> <span class="n">hs</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">top</span>
        <span class="n">points</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">planes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">plane_colors</span> <span class="o">=</span> <span class="p">[]</span>
        
        

        <span class="n">hs</span> <span class="o">=</span> <span class="n">es</span><span class="o">.</span><span class="n">hillshade</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="n">root</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Tk</span><span class="p">()</span>
        <span class="n">root</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Akhdefo_FitPlanes&quot;</span><span class="p">)</span>

        <span class="n">left</span><span class="p">,</span> <span class="n">cell_size_x</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">cell_size_y</span> <span class="o">=</span> <span class="n">transform</span>
        
       
        <span class="n">right</span> <span class="o">=</span> <span class="n">left</span> <span class="o">+</span> <span class="n">cell_size_x</span> <span class="o">*</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">bottom</span> <span class="o">=</span> <span class="n">top</span> <span class="o">+</span> <span class="n">cell_size_y</span> <span class="o">*</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">fig1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
        <span class="n">ax_2d</span> <span class="o">=</span> <span class="n">fig1</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
        <span class="n">ax_2d</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">hs</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">top</span><span class="p">])</span>
        <span class="n">ax_2d</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Hillshade&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">ax_2d</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Longitude&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax_2d</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Latitude&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax_2d</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">ax_2d</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
        
        
        
        <span class="k">if</span> <span class="n">path_to_shapefile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">path_to_shapefile</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">gdf</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span> <span class="o">!=</span> <span class="n">projection</span><span class="p">:</span>
                <span class="n">gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">projection</span><span class="p">)</span>
            <span class="n">gdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax_2d</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Linear Features&quot;</span><span class="p">)</span>
            <span class="n">ax_2d</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>
        
        <span class="n">fig2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
        <span class="c1"># Create a figure and axis</span>
        <span class="n">ax_3d</span> <span class="o">=</span> <span class="n">fig2</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
        <span class="n">ax_3d</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;3D DEM with Fitted Planes&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">ax_3d</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Longitude&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax_3d</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Latitude&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax_3d</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s2">&quot;Elevation&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">x_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">y_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_coords</span><span class="p">,</span> <span class="n">y_coords</span><span class="p">)</span>
        
        
        

        

        <span class="c1"># ax_3d.set_xlim([left, right])</span>
        <span class="c1"># ax_3d.set_ylim([bottom, top])</span>
        <span class="c1"># ax_3d.set_zlim([zmin, zmax])</span>

        <span class="n">frame_2d</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
        <span class="n">frame_2d</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="s1">&#39;nsew&#39;</span><span class="p">)</span>
        <span class="c1"># canvas_2d = FigureCanvasTkAgg(fig1, master=frame_2d)</span>
        <span class="c1"># canvas_2d.get_tk_widget().pack(fill=tk.BOTH, expand=False)</span>
        <span class="c1"># toolbar_2d = NavigationToolbar2Tk(canvas_2d, frame_2d)</span>
        <span class="c1"># toolbar_2d.update()</span>
        <span class="c1"># Create the canvas for the plot</span>
        <span class="n">canvas_2d</span> <span class="o">=</span> <span class="n">FigureCanvasTkAgg</span><span class="p">(</span><span class="n">fig1</span><span class="p">,</span> <span class="n">master</span><span class="o">=</span><span class="n">frame_2d</span><span class="p">)</span>
        <span class="n">canvas_2d</span><span class="o">.</span><span class="n">get_tk_widget</span><span class="p">()</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">BOTH</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Fill the frame</span>
        <span class="c1"># Create the toolbar and place it at the top of the canvas</span>
        <span class="n">toolbar_2d</span> <span class="o">=</span> <span class="n">NavigationToolbar2Tk</span><span class="p">(</span><span class="n">canvas_2d</span><span class="p">,</span> <span class="n">frame_2d</span><span class="p">)</span>
        <span class="n">toolbar_2d</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="n">toolbar_2d</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">TOP</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>  <span class="c1"># Pack the toolbar at the top</span>
        
        <span class="c1">#######add colorbar figure to Canvas</span>
        



        <span class="n">frame_3d</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
        <span class="n">frame_3d</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="s1">&#39;nsew&#39;</span><span class="p">)</span>
        <span class="c1"># canvas_3d = FigureCanvasTkAgg(fig2, master=frame_3d)</span>
        <span class="c1"># canvas_3d.get_tk_widget().pack(fill=tk.BOTH, expand=False)</span>
        <span class="c1"># toolbar_3d = NavigationToolbar2Tk(canvas_3d, frame_3d)</span>
        <span class="c1"># toolbar_3d.update()</span>
        <span class="n">canvas_3d</span> <span class="o">=</span> <span class="n">FigureCanvasTkAgg</span><span class="p">(</span><span class="n">fig2</span><span class="p">,</span> <span class="n">master</span><span class="o">=</span><span class="n">frame_3d</span><span class="p">)</span>
        <span class="n">canvas_3d</span><span class="o">.</span><span class="n">get_tk_widget</span><span class="p">()</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">BOTH</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Fill the frame</span>
        <span class="c1"># Create the toolbar and place it at the top of the canvas</span>
        <span class="n">toolbar_3d</span> <span class="o">=</span> <span class="n">NavigationToolbar2Tk</span><span class="p">(</span><span class="n">canvas_3d</span><span class="p">,</span> <span class="n">frame_3d</span><span class="p">)</span>
        <span class="n">toolbar_3d</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="n">toolbar_3d</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">TOP</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>  <span class="c1"># Pack the toolbar at the top</span>

        <span class="c1"># Create a frame on the right to hold controls</span>
        <span class="n">controls_frame</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
        <span class="n">controls_frame</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="s1">&#39;nsew&#39;</span><span class="p">)</span>
        

        <span class="c1"># Now put all buttons and Listbox inside this controls_frame</span>
        <span class="n">draw_button</span> <span class="o">=</span> <span class="n">ttk</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">controls_frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Draw Plane&quot;</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">draw_plane</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span><span class="n">yy</span><span class="p">))</span>
        <span class="n">draw_button</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">pady</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">line_plane_button</span> <span class="o">=</span> <span class="n">ttk</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">controls_frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Create Planes from Lines&quot;</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">draw_planes_from_lines</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span><span class="n">yy</span><span class="p">))</span>
        <span class="n">line_plane_button</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">pady</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">save_plane_button</span> <span class="o">=</span> <span class="n">ttk</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">controls_frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Save Planes to OBJ&quot;</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="n">save_planes_to_obj</span><span class="p">)</span> <span class="c1">#save_fitted_planes_as_dxf</span>
        <span class="n">save_plane_button</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">pady</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># save_plane_button_dxf = ttk.Button(controls_frame, text=&quot;Save Planes to DXF&quot;, command=save_fitted_planes_as_dxf)</span>
        <span class="c1"># save_plane_button_dxf.pack(pady=10, padx=10)</span>

        <span class="n">points_listbox</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Listbox</span><span class="p">(</span><span class="n">controls_frame</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">exportselection</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">points_listbox</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">pady</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="n">scrollbar</span> <span class="o">=</span> <span class="n">ttk</span><span class="o">.</span><span class="n">Scrollbar</span><span class="p">(</span><span class="n">controls_frame</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;vertical&quot;</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="n">points_listbox</span><span class="o">.</span><span class="n">yview</span><span class="p">)</span>
        <span class="n">scrollbar</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span>
        
        <span class="n">points_listbox</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">yscrollcommand</span><span class="o">=</span><span class="n">scrollbar</span><span class="o">.</span><span class="n">set</span><span class="p">)</span>
        <span class="n">points_listbox</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Double-Button-1&gt;&quot;</span><span class="p">,</span> <span class="n">on_point_double_click</span><span class="p">)</span>
        <span class="c1">####</span>
    
        
        <span class="c1">####</span>

        <span class="n">fig1</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;button_press_event&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">event</span><span class="p">:</span> <span class="n">onclick</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">transform</span><span class="p">))</span>
        
        
        <span class="c1"># Adding the size grip for window resizing</span>
        <span class="n">sizegrip</span> <span class="o">=</span> <span class="n">ttk</span><span class="o">.</span><span class="n">Sizegrip</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
        <span class="n">sizegrip</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="s1">&#39;nsew&#39;</span><span class="p">)</span>

        <span class="c1"># Making the design responsive</span>
        <span class="n">root</span><span class="o">.</span><span class="n">grid_rowconfigure</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Canvas row</span>
        <span class="n">root</span><span class="o">.</span><span class="n">grid_rowconfigure</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Toolbar row</span>
        <span class="n">root</span><span class="o">.</span><span class="n">grid_rowconfigure</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Button row</span>
        <span class="n">root</span><span class="o">.</span><span class="n">grid_columnconfigure</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># 2D plot column</span>
        <span class="n">root</span><span class="o">.</span><span class="n">grid_columnconfigure</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># 3D plot column</span>
        
        
                
        <span class="n">root</span><span class="o">.</span><span class="n">mainloop</span><span class="p">()</span>


    
    <span class="n">plot_dem</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">projection</span><span class="p">,</span> <span class="n">line_shapefile</span><span class="p">)</span></div>

   
    
<span class="c1">#akhdefo_fitPlane(dem_data=&#39;currie/dem_1m.tif&#39;, line_shapefile=&#39;currie/lines.shp&#39;, out_planeFolder=&#39;Planes_out/new&#39;, limit_extend=False)</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>

<div class="viewcode-block" id="move_files_with_string">
<a class="viewcode-back" href="../../akhdefo_functions.html#akhdefo_functions.Akhdefo_Tools.move_files_with_string">[docs]</a>
<span class="k">def</span> <span class="nf">move_files_with_string</span><span class="p">(</span><span class="n">source_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">dest_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">search_string</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span><span class="s2">&quot;.tif&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Move files from a source directory to a destination directory based on a search string present in their paths.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - source_dir (str): The directory from which files are to be moved.</span>
<span class="sd">    - dest_dir (str): The destination directory where files will be moved.</span>
<span class="sd">    - search_string (str): The string to search for in the file paths.</span>

<span class="sd">    This function traverses the source directory, including its subdirectories. </span>
<span class="sd">    Files whose paths contain the search string are moved to the destination directory. </span>
<span class="sd">    If a file with the same name exists in the destination, it&#39;s renamed to avoid overwriting.</span>

<span class="sd">    Errors during file movement (e.g., permission issues, non-existent directories) are logged but do not stop the process.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">source_dir</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Source directory &#39;</span><span class="si">{</span><span class="n">source_dir</span><span class="si">}</span><span class="s2">&#39; does not exist.&quot;</span><span class="p">)</span>

    <span class="c1"># Create the destination directory if it doesn&#39;t exist</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">source_dir</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">search_string</span> <span class="ow">in</span> <span class="n">file_path</span><span class="p">:</span>
                <span class="n">dest_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>

                <span class="c1"># Check if the file already exists in destination</span>
                <span class="n">counter</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dest_file_path</span><span class="p">):</span>
                    <span class="c1"># Split filename and extension</span>
                    <span class="n">file_base</span><span class="p">,</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
                    <span class="c1"># Create a new filename with a counter to avoid overwriting</span>
                    <span class="n">dest_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_base</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">counter</span><span class="si">}{</span><span class="n">file_extension</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># Move the file to the destination directory</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">dest_file_path</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error moving file </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">dest_file_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<span class="c1">#############################################</span>
<span class="c1">#This part is still under construction</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<div class="viewcode-block" id="partial_derivative">
<a class="viewcode-back" href="../../akhdefo_functions.html#akhdefo_functions.Akhdefo_Tools.partial_derivative">[docs]</a>
<span class="k">def</span> <span class="nf">partial_derivative</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the central difference approximation for the partial derivatives</span>
<span class="sd">    of a 2D function with respect to x and y.</span>

<span class="sd">    :param f: 2D numpy array of function values, representing the raster</span>
<span class="sd">    :param dx: Spacing in the x-direction (assumed to be constant)</span>
<span class="sd">    :param dy: Spacing in the y-direction (assumed to be constant)</span>
<span class="sd">    :return: Two 2D numpy arrays, one for the partial derivative with respect to x (df_dx)</span>
<span class="sd">             and one for the partial derivative with respect to y (df_dy)</span>
<span class="sd">    &quot;&quot;&quot;</span>
     <span class="c1"># Initialize arrays to store the partial derivatives</span>
    <span class="n">df_dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">df_dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="c1"># Compute the partial derivatives for the internal points</span>
    <span class="k">for</span> <span class="n">xi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">yj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">df_dx</span><span class="p">[</span><span class="n">xi</span><span class="p">,</span> <span class="n">yj</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">xi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">yj</span><span class="p">]</span> <span class="o">-</span> <span class="n">f</span><span class="p">[</span><span class="n">xi</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">yj</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">dx</span><span class="p">)</span>
            <span class="n">df_dy</span><span class="p">[</span><span class="n">xi</span><span class="p">,</span> <span class="n">yj</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">xi</span><span class="p">,</span> <span class="n">yj</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">f</span><span class="p">[</span><span class="n">xi</span><span class="p">,</span> <span class="n">yj</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">dy</span><span class="p">)</span>

    <span class="c1"># Handle the boundaries by setting the derivative to zero or using one-sided differences</span>
    <span class="c1"># Here we choose to set the boundary derivative to zero</span>
    <span class="c1"># Alternatively, use forward/backward difference at the boundaries if needed</span>

    <span class="k">return</span> <span class="n">df_dx</span><span class="p">,</span> <span class="n">df_dy</span></div>



<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">rasterio</span>

<div class="viewcode-block" id="calculate_slope">
<a class="viewcode-back" href="../../akhdefo_functions.html#akhdefo_functions.Akhdefo_Tools.calculate_slope">[docs]</a>
<span class="k">def</span> <span class="nf">calculate_slope</span><span class="p">(</span><span class="n">dem</span><span class="p">,</span> <span class="n">aspect</span><span class="p">,</span> <span class="n">dx</span> <span class="p">,</span> <span class="n">dy</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the slope at each pixel using the aspect to determine direction.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    dem (numpy.ndarray): Digital Elevation Model (DEM) array.</span>
<span class="sd">    aspect (numpy.ndarray): Aspect array.</span>
<span class="sd">    dx (float):  x Spatial resolution of the raster (distance between pixels).</span>
<span class="sd">    dy (float):  y Spatial resolution of the raster (distance between pixels).</span>

<span class="sd">    Returns:</span>
<span class="sd">    numpy.ndarray: Array of slope values in degrees.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># grad_y, grad_x = np.gradient(dem, dx, dy)</span>
    
    
    <span class="c1"># Assuming &#39;dem&#39; and &#39;aspect&#39; are your existing numpy arrays</span>
    <span class="c1"># Check if the shapes are different</span>
    <span class="c1"># if dem.shape != aspect.shape:</span>
    <span class="c1">#     # Resize &#39;dem&#39; to match the shape of &#39;aspect&#39;</span>
    <span class="c1">#     aspect = np.resize(aspect, dem.shape)</span>
    <span class="c1"># else:</span>
    <span class="c1">#     aspect = aspect</span>



    <span class="n">grad_y</span><span class="p">,</span> <span class="n">grad_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">dem</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span>
    <span class="c1">#grad_y, grad_x=partial_derivative(dem, dx, dy)</span>

    <span class="k">if</span> <span class="n">grad_x</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">grad_y</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Gradient arrays have mismatched shapes.&quot;</span><span class="p">)</span>
    
    <span class="n">aspect_radians</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">aspect</span><span class="p">)</span>
    <span class="n">directional_grad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">aspect_radians</span><span class="p">)</span> <span class="o">*</span> <span class="n">grad_x</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">aspect_radians</span><span class="p">)</span> <span class="o">*</span> <span class="n">grad_y</span>
    <span class="c1">#slope_degrees = np.rad2deg(np.arctan(directional_grad))</span>
   
    <span class="c1"># Calculate slope in radians</span>
    <span class="n">slope_radians</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">directional_grad</span><span class="p">)</span>

    <span class="c1"># Ensure slope is within 0 to π/2 radians (0 to 90 degrees) range</span>
    <span class="c1">#slope_radians = slope_radians % (np.pi / 2)</span>

    <span class="c1"># Convert slope to degrees</span>
    <span class="n">slope_degrees</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">slope_radians</span><span class="p">))</span> <span class="o">%</span> <span class="mi">90</span> 
    <span class="c1">#slope_degrees= (135-slope_degrees)% 90 </span>
    
   
    
    <span class="k">return</span> <span class="n">slope_degrees</span><span class="p">,</span> <span class="n">directional_grad</span></div>


<div class="viewcode-block" id="calculate_height_change">
<a class="viewcode-back" href="../../akhdefo_functions.html#akhdefo_functions.Akhdefo_Tools.calculate_height_change">[docs]</a>
<span class="k">def</span> <span class="nf">calculate_height_change</span><span class="p">(</span><span class="n">slope</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">dem</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the height change using the slope and distance for each pixel.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    slope (numpy.ndarray): Array of slope values in degrees.</span>
<span class="sd">    distance (numpy.ndarray): Array of distance values.</span>

<span class="sd">    Returns:</span>
<span class="sd">    numpy.ndarray: Array of height changes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">slope_radians</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">slope</span><span class="p">)</span>
    <span class="n">height_change</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">slope_radians</span><span class="p">)</span> <span class="o">*</span> <span class="n">distance</span>
    
    
    
    <span class="k">return</span> <span class="n">height_change</span> </div>


<div class="viewcode-block" id="calculate_volume_change">
<a class="viewcode-back" href="../../akhdefo_functions.html#akhdefo_functions.Akhdefo_Tools.calculate_volume_change">[docs]</a>
<span class="k">def</span> <span class="nf">calculate_volume_change</span><span class="p">(</span><span class="n">height_change</span><span class="p">,</span> <span class="n">pixel_area</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the volume change for each pixel.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    height_change (numpy.ndarray): Array of height changes.</span>
<span class="sd">    pixel_area (float): Area of a single pixel.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    numpy.ndarray: Array of volume changes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">volume_change</span> <span class="o">=</span> <span class="n">height_change</span> <span class="o">*</span> <span class="n">pixel_area</span>
    <span class="nb">print</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Total Volume: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">volume_change</span><span class="p">)</span><span class="si">}</span><span class="s1"> cubic meter&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">volume_change</span></div>


<span class="kn">from</span> <span class="nn">skimage.filters</span> <span class="kn">import</span> <span class="n">gaussian</span>

<div class="viewcode-block" id="displacement_to_volume">
<a class="viewcode-back" href="../../akhdefo_functions.html#akhdefo_functions.Akhdefo_Tools.displacement_to_volume">[docs]</a>
<span class="k">def</span> <span class="nf">displacement_to_volume</span><span class="p">(</span><span class="n">dem_path</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">aspect_path</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">displacement_path</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">slope_output_path</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">height_output_path</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">volume_output_path</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="kc">None</span> <span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="kc">None</span> <span class="p">,</span> <span class="n">pixel_area</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process the DEM, aspect, and displacement rasters to calculate and export the slope, height change, and volume change.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    dem_path (str): Path to the DEM raster file.</span>
<span class="sd">    aspect_path (str): Path to the aspect raster file.</span>
<span class="sd">    displacement_path (str): Path to the displacement raster file.</span>
<span class="sd">    slope_output_path (str): Path for the slope output GeoTIFF file.</span>
<span class="sd">    height_output_path (str): Path for the height change output GeoTIFF file.</span>
<span class="sd">    volume_output_path (str): Path for the volume change output GeoTIFF file.</span>
<span class="sd">    dx (float):  x Spatial resolution of the raster (distance between pixels).</span>
<span class="sd">    dy (float):  y Spatial resolution of the raster (distance between pixels).</span>
<span class="sd">    pixel_area (float): Area of a single pixel.</span>

<span class="sd">    Returns:</span>
<span class="sd">    None: Outputs GeoTIFF files at the specified output paths.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dem_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">dem_raster</span><span class="p">,</span> \
         <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">aspect_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">aspect_raster</span><span class="p">,</span> \
         <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">displacement_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">displacement_raster</span><span class="p">:</span>

        <span class="n">dem</span> <span class="o">=</span> <span class="n">dem_raster</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>  <span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">aspect</span> <span class="o">=</span> <span class="n">aspect_raster</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>  <span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">displacement</span> <span class="o">=</span> <span class="n">displacement_raster</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>  <span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="n">x_resolution</span><span class="p">,</span> <span class="n">y_resolution</span> <span class="o">=</span> <span class="n">displacement_raster</span><span class="o">.</span><span class="n">res</span>
        
        <span class="k">if</span> <span class="n">dx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dx</span><span class="o">=</span><span class="n">x_resolution</span>
        <span class="k">if</span> <span class="n">dy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dy</span><span class="o">=</span><span class="n">y_resolution</span>
        <span class="k">if</span> <span class="n">pixel_area</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pixel_area</span><span class="o">=</span><span class="n">dx</span> <span class="o">*</span> <span class="n">dy</span>
        <span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">zoom</span>

        <span class="c1"># Example dimensions - replace these with actual dimensions</span>
        <span class="n">dem_shape</span> <span class="o">=</span> <span class="n">dem</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">aspect_shape</span> <span class="o">=</span> <span class="n">aspect</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">displacement_shape</span> <span class="o">=</span> <span class="n">displacement</span><span class="o">.</span><span class="n">shape</span>

        <span class="c1"># Calculating zoom factors</span>
        <span class="n">zoom_factor_aspect</span> <span class="o">=</span> <span class="p">[</span><span class="n">dem_dim</span> <span class="o">/</span> <span class="n">aspect_dim</span> <span class="k">for</span> <span class="n">dem_dim</span><span class="p">,</span> <span class="n">aspect_dim</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dem_shape</span><span class="p">,</span> <span class="n">aspect_shape</span><span class="p">)]</span>
        <span class="n">zoom_factor_displacement</span> <span class="o">=</span> <span class="p">[</span><span class="n">dem_dim</span> <span class="o">/</span> <span class="n">displacement_dim</span> <span class="k">for</span> <span class="n">dem_dim</span><span class="p">,</span> <span class="n">displacement_dim</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dem_shape</span><span class="p">,</span> <span class="n">displacement_shape</span><span class="p">)]</span>

        <span class="c1"># Resizing aspect and displacement arrays</span>
        <span class="n">aspect</span> <span class="o">=</span> <span class="n">zoom</span><span class="p">(</span><span class="n">aspect</span><span class="p">,</span> <span class="n">zoom_factor_aspect</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># cubic interpolation</span>
        <span class="n">displacement</span> <span class="o">=</span> <span class="n">zoom</span><span class="p">(</span><span class="n">displacement</span><span class="p">,</span> <span class="n">zoom_factor_displacement</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># cubic interpolation</span>
        
        <span class="c1"># aspect = np.resize(aspect, dem.shape)</span>
        <span class="c1"># displacement = np.resize(displacement, dem.shape)</span>
        
        <span class="n">slope</span><span class="p">,</span> <span class="n">directional_grad</span> <span class="o">=</span> <span class="n">calculate_slope</span><span class="p">(</span><span class="n">dem</span><span class="p">,</span> <span class="n">aspect</span><span class="p">,</span> <span class="n">dx</span> <span class="p">,</span> <span class="n">dy</span> <span class="p">)</span>
        <span class="n">height_change</span>  <span class="o">=</span> <span class="n">calculate_height_change</span><span class="p">(</span><span class="n">slope</span><span class="p">,</span> <span class="n">directional_grad</span><span class="p">,</span> <span class="n">dem</span><span class="p">)</span>
        <span class="c1">#height_change=gaussian(height_change, sigma=3)</span>
        <span class="n">volume_change</span> <span class="o">=</span> <span class="n">calculate_volume_change</span><span class="p">(</span><span class="n">height_change</span><span class="p">,</span> <span class="n">pixel_area</span><span class="p">)</span>
       
       

        <span class="c1"># Define a function to export data to a GeoTIFF</span>
        <span class="k">def</span> <span class="nf">export_to_geotiff</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">reference_raster</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
                <span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span>
                <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;GTiff&#39;</span><span class="p">,</span>
                <span class="n">height</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">width</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
                <span class="n">crs</span><span class="o">=</span><span class="n">reference_raster</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
                <span class="n">transform</span><span class="o">=</span><span class="n">reference_raster</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span> <span class="n">nodata</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">output_raster</span><span class="p">:</span>
                <span class="n">output_raster</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Exporting slope, height change, and volume change to GeoTIFFs</span>
        <span class="n">export_to_geotiff</span><span class="p">(</span><span class="n">slope</span><span class="p">,</span> <span class="n">slope_output_path</span><span class="p">,</span> <span class="n">dem_raster</span><span class="p">)</span>
        <span class="n">export_to_geotiff</span><span class="p">(</span><span class="n">height_change</span><span class="p">,</span> <span class="n">height_output_path</span><span class="p">,</span> <span class="n">dem_raster</span><span class="p">)</span>
        <span class="n">export_to_geotiff</span><span class="p">(</span><span class="n">volume_change</span><span class="p">,</span> <span class="n">volume_output_path</span><span class="p">,</span> <span class="n">dem_raster</span><span class="p">)</span></div>

       



<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">osgeo</span> <span class="kn">import</span> <span class="n">gdal</span>

<div class="viewcode-block" id="calculate_and_save_aspect_raster">
<a class="viewcode-back" href="../../akhdefo_functions.html#akhdefo_functions.Akhdefo_Tools.calculate_and_save_aspect_raster">[docs]</a>
<span class="k">def</span> <span class="nf">calculate_and_save_aspect_raster</span><span class="p">(</span><span class="n">ew_raster_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">ns_raster_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">output_raster_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the aspect raster from east-west and north-south displacement rasters and save it.</span>

<span class="sd">    This function reads two raster files representing east-west (EW) and north-south (NS) </span>
<span class="sd">    displacements, calculates the aspect of each pixel, and saves the result as a new raster file.</span>
<span class="sd">    Aspect is calculated in degrees from north (0 degrees), east (90 degrees), south (180 degrees),</span>
<span class="sd">    and west (270 degrees).</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - ew_raster_path (str): File path for the east-west displacement raster.</span>
<span class="sd">    - ns_raster_path (str): File path for the north-south displacement raster.</span>
<span class="sd">    - output_raster_path (str): File path for the output aspect raster.</span>

<span class="sd">    Returns:</span>
<span class="sd">    None. The result is saved as a new raster file at the specified output path.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">read_raster</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read a raster file and return the data array and geotransform.&quot;&quot;&quot;</span>

        <span class="c1"># Open the dataset</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dataset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Could not open file at </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>

        <span class="c1"># Get the first raster band</span>
        <span class="n">band</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Read the data as a numpy array</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">band</span><span class="o">.</span><span class="n">ReadAsArray</span><span class="p">()</span>

        <span class="c1"># Get no-data value from the band</span>
        <span class="n">nodata_value</span> <span class="o">=</span> <span class="n">band</span><span class="o">.</span><span class="n">GetNoDataValue</span><span class="p">()</span>

        <span class="c1"># Check if there is a no-data value defined</span>
        <span class="k">if</span> <span class="n">nodata_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Create a mask that is True for valid pixels</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">data</span> <span class="o">!=</span> <span class="n">nodata_value</span>

            <span class="c1"># Apply the mask to filter out no-data pixels</span>
            <span class="n">valid_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>  <span class="c1"># Replace no-data with NaN</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">valid_data</span> <span class="o">=</span> <span class="n">data</span>  <span class="c1"># All data is valid if there is no no-data value</span>

        <span class="c1"># Retrieve geotransformation</span>
        <span class="n">geotransform</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">GetGeoTransform</span><span class="p">()</span>

        <span class="c1"># Close the dataset</span>
        <span class="c1">#dataset = None</span>

        <span class="k">return</span> <span class="n">valid_data</span><span class="p">,</span> <span class="n">geotransform</span><span class="p">,</span> <span class="n">dataset</span>

    <span class="k">def</span> <span class="nf">calculate_aspect</span><span class="p">(</span><span class="n">ew_data</span><span class="p">,</span> <span class="n">ns_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the aspect from EW and NS displacement data.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
            <span class="n">aspect</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">ew_data</span><span class="p">,</span> <span class="n">ns_data</span><span class="p">)</span>
            <span class="n">aspect_deg</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">aspect</span><span class="p">)</span>
            <span class="n">aspect_deg</span> <span class="o">=</span> <span class="p">(</span><span class="mi">450</span> <span class="o">-</span><span class="n">aspect_deg</span> <span class="p">)</span> <span class="o">%</span> <span class="mi">360</span>
        <span class="k">return</span> <span class="n">aspect_deg</span>

    <span class="k">def</span> <span class="nf">save_raster</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">geo_transform</span><span class="p">,</span> <span class="n">reference_dataset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save the data as a raster file.&quot;&quot;&quot;</span>
        <span class="n">driver</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GetDriverByName</span><span class="p">(</span><span class="s1">&#39;GTiff&#39;</span><span class="p">)</span>
        <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">out_raster</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GDT_Float32</span><span class="p">)</span>
        <span class="n">out_raster</span><span class="o">.</span><span class="n">SetGeoTransform</span><span class="p">(</span><span class="n">geo_transform</span><span class="p">)</span>
        <span class="n">out_band</span> <span class="o">=</span> <span class="n">out_raster</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">out_band</span><span class="o">.</span><span class="n">WriteArray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">out_raster</span><span class="o">.</span><span class="n">SetProjection</span><span class="p">(</span><span class="n">reference_dataset</span><span class="o">.</span><span class="n">GetProjection</span><span class="p">())</span>
        <span class="n">out_band</span><span class="o">.</span><span class="n">FlushCache</span><span class="p">()</span>

    <span class="c1"># Read the EW and NS raster data</span>
    <span class="n">ew_data</span><span class="p">,</span> <span class="n">geo_transform</span><span class="p">,</span> <span class="n">dataset</span> <span class="o">=</span> <span class="n">read_raster</span><span class="p">(</span><span class="n">ew_raster_path</span><span class="p">)</span>
    <span class="n">ns_data</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">read_raster</span><span class="p">(</span><span class="n">ns_raster_path</span><span class="p">)</span>

    <span class="c1"># Calculate the aspect and save the result</span>
    <span class="n">aspect_data</span> <span class="o">=</span> <span class="n">calculate_aspect</span><span class="p">(</span><span class="n">ew_data</span><span class="p">,</span> <span class="n">ns_data</span><span class="p">)</span>
    <span class="n">save_raster</span><span class="p">(</span><span class="n">output_raster_path</span><span class="p">,</span> <span class="n">aspect_data</span><span class="p">,</span> <span class="n">geo_transform</span><span class="p">,</span> <span class="n">dataset</span><span class="p">)</span></div>


<span class="c1"># Example usage:</span>
<span class="c1"># calculate_and_save_aspect_raster(&#39;path_to_ew_raster.tif&#39;, &#39;path_to_ns_raster.tif&#39;, &#39;path_to_output_aspect_raster.tif&#39;)</span>



<span class="c1">##############################################</span>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
  <span id="sidebar-top"></span>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  
    
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/akhdefo_logo.svg" alt="Logo"/>
            </a></p>
  
<h3>Navigation</h3>
<ul>
  <li><a href="../../index.html">Overview</a>
    <ul>
      <li><a href="../index.html">Module code</a>
        
          
          </ul>
      </li>
    </ul>
  </li>
</ul>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script><div id="ethical-ad-placement"></div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  
    <div class="footer" role="contentinfo">
    &#169; Copyright 2024, Mahmud Mustafa Muhammad.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    </div>
  <script src="../../_static/version_warning_offset.js"></script>

  </body>
</html>