<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>akhdefo_functions.Akhdefo_utils &#8212; AkhDefo Software 2.2.62 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../_static/flask.css?v=b87c8d14" />
    <script src="../../_static/documentation_options.js?v=1eda8c85"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Akhdefo</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">akhdefo_functions.Akhdefo_utils</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for akhdefo_functions.Akhdefo_utils</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">akhdefo_functions</span> <span class="kn">import</span> <span class="n">utm_to_latlon</span>
<span class="kn">from</span> <span class="nn">akhdefo_functions</span> <span class="kn">import</span> <span class="n">akhdefo_viewer</span>
<span class="kn">from</span> <span class="nn">osgeo</span> <span class="kn">import</span> <span class="n">gdal</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">rasterio</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">rasterio</span> <span class="k">as</span> <span class="nn">rio</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">planet</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">planet</span> <span class="kn">import</span> <span class="n">Session</span><span class="p">,</span> <span class="n">data_filter</span>
<span class="kn">from</span> <span class="nn">planet</span> <span class="kn">import</span> <span class="n">Session</span><span class="p">,</span> <span class="n">OrdersClient</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">from</span> <span class="nn">osgeo</span> <span class="kn">import</span> <span class="n">osr</span>
<span class="kn">import</span> <span class="nn">cmocean</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">import</span> <span class="nn">gstools</span> <span class="k">as</span> <span class="nn">gs</span>

<div class="viewcode-block" id="Akhdefo_resample">
<a class="viewcode-back" href="../../akhdefo_functions.html#akhdefo_functions.Akhdefo_utils.Akhdefo_resample">[docs]</a>
<span class="k">def</span> <span class="nf">Akhdefo_resample</span><span class="p">(</span><span class="n">input_raster</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">output_raster</span><span class="o">=</span><span class="s2">&quot;&quot;</span> <span class="p">,</span> <span class="n">xres</span><span class="o">=</span><span class="mf">3.125</span> <span class="p">,</span> <span class="n">yres</span><span class="o">=</span><span class="mf">3.125</span><span class="p">,</span> <span class="n">SavFig</span><span class="o">=</span><span class="kc">False</span> <span class="p">,</span> <span class="n">convert_units</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This program performs raster resampling for  rasters</span>
<span class="sd">   </span>
<span class="sd">    Parameters:</span>
<span class="sd">    ------------</span>

<span class="sd">    input_raster: str</span>
<span class="sd">        path to input raster</span>

<span class="sd">    output_raster: str</span>
<span class="sd">        path to output raster</span>


<span class="sd">    xres: float</span>
<span class="sd">        horizontal resolution</span>

<span class="sd">    yres: float </span>
<span class="sd">        vertical resolution</span>

<span class="sd">    SavFig: bool</span>
<span class="sd">        True to save output plot False to ignore exporting plot</span>

<span class="sd">    convert_units: float </span>
<span class="sd">        if not None converts raster value units from meter to mm: depends on your raster unit adjust this value</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">        geotif raster</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
   
    <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">input_raster</span><span class="p">)</span>

    <span class="c1"># resample</span>
    <span class="n">dsRes</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Warp</span><span class="p">(</span><span class="n">output_raster</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">xRes</span> <span class="o">=</span> <span class="n">xres</span><span class="p">,</span> <span class="n">yRes</span> <span class="o">=</span> <span class="n">yres</span><span class="p">,</span> 
                    <span class="n">resampleAlg</span> <span class="o">=</span> <span class="s2">&quot;bilinear&quot;</span><span class="p">)</span>
    
    <span class="n">dsRes</span> <span class="o">=</span><span class="kc">None</span> 
    <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>
  
    <span class="c1"># # visualize</span>
    <span class="n">src</span><span class="o">=</span><span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_raster</span><span class="p">)</span>
    <span class="n">meta</span><span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">meta</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;nodata&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">})</span>
    <span class="n">array</span><span class="o">=</span><span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># #array = dsRes.GetRasterBand(1).ReadAsArray()</span>
    <span class="k">if</span> <span class="n">convert_units</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">array</span><span class="p">[</span><span class="n">array</span><span class="o">==-</span><span class="mf">32767.0</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">array</span><span class="o">=</span><span class="n">array</span><span class="o">*</span><span class="n">convert_units</span>

    <span class="n">basename</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">input_raster</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">create_fancy_figure</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">basename</span><span class="p">,</span> <span class="n">SavFig</span><span class="o">=</span><span class="n">SavFig</span><span class="p">,</span> <span class="n">convert_units</span><span class="o">=</span><span class="n">convert_units</span><span class="p">):</span>
       
        <span class="c1"># Creating the figure</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="c1"># Making sure &#39;north&#39; is up, in case Y was flipped</span>
        <span class="c1">#ax.invert_yaxis()</span>
        <span class="c1"># Creating a colormap</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
        <span class="c1"># Creating the image</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
        <span class="c1"># Creating the colorbar</span>
        <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
        
        <span class="c1"># Adding labels to the axes</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Easting&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Northing&#39;</span><span class="p">)</span>

        <span class="c1"># Adding a title to the plot</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">basename</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">SavFig</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
        <span class="c1"># Saving the figure</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">basename</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">fig</span>
    <span class="k">if</span> <span class="n">SavFig</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
        <span class="n">a</span><span class="o">=</span><span class="n">create_fancy_figure</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">basename</span><span class="p">,</span> <span class="n">SavFig</span><span class="o">=</span><span class="n">SavFig</span><span class="p">,</span> <span class="n">convert_units</span><span class="o">=</span><span class="n">convert_units</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">convert_units</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        
        <span class="n">src</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c1"># close the rasterio dataset</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">output_raster</span><span class="p">)</span> <span class="c1"># delete the file </span>
        
        <span class="n">rs</span><span class="o">=</span><span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_raster</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">meta</span><span class="p">)</span>
        <span class="n">rs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">indexes</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="Akhdefo_inversion">
<a class="viewcode-back" href="../../akhdefo_functions.html#akhdefo_functions.Akhdefo_utils.Akhdefo_inversion">[docs]</a>
<span class="k">def</span> <span class="nf">Akhdefo_inversion</span><span class="p">(</span><span class="n">horizontal_InSAR</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">Vertical_InSAR</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">EW_Akhdefo</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">NS_Akhdefo</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">output_folder</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;&quot;</span> <span class="p">,</span> <span class="n">dem_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This program calculates 3D displacement velocity (East-West,North-South and vertical) using combined optical and InSAR products</span>
<span class="sd">   </span>
<span class="sd">    Parameters:</span>
<span class="sd">    ------------</span>

<span class="sd">    horizontal_InSAR: str</span>
<span class="sd">        path to East Velocity InSAR product in geotif format</span>

<span class="sd">    Vertical_InSAR: str</span>
<span class="sd">        path to Vertical Velocity InSAR product in geotif format</span>

<span class="sd">    EW_Akhdefo: str </span>
<span class="sd">        path to east-west velocity  akhdefo(optical) product in geotif format</span>

<span class="sd">    NS_Akhdefo: str</span>
<span class="sd">        path to north-south velocity  akhdefo(optical) product in geotif format</span>

<span class="sd">    dem_path: str</span>
<span class="sd">        path to DEM raster in geotif format</span>

<span class="sd">    output_folder : str</span>
<span class="sd">        path to save raster products </span>

<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    ---------</span>
<span class="sd">    Three geotif rasters</span>
<span class="sd">        3D-Velocity (D3D in mm/year) raster</span>
<span class="sd">        Plunge raster in degrees</span>
<span class="sd">        Trend raster in degress</span>


<span class="sd">    &quot;&quot;&quot;</span>
    
    
    <span class="c1">##################</span>
        <span class="c1"># Open and read the raster files</span>
   <span class="c1"># Open the raster files and read the data</span>
    <span class="k">with</span> <span class="n">rio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">EW_Akhdefo</span><span class="p">)</span> <span class="k">as</span> <span class="n">src_east</span><span class="p">:</span>
        <span class="n">east_data</span> <span class="o">=</span> <span class="n">src_east</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">east_meta</span> <span class="o">=</span> <span class="n">src_east</span><span class="o">.</span><span class="n">meta</span>

    <span class="k">with</span> <span class="n">rio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">horizontal_InSAR</span><span class="p">)</span> <span class="k">as</span> <span class="n">src_horizontal</span><span class="p">:</span>
        <span class="n">horizontal_data</span> <span class="o">=</span> <span class="n">src_horizontal</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">horizontal_meta</span> <span class="o">=</span> <span class="n">src_horizontal</span><span class="o">.</span><span class="n">meta</span>

    <span class="k">with</span> <span class="n">rio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">NS_Akhdefo</span><span class="p">)</span> <span class="k">as</span> <span class="n">src_north</span><span class="p">:</span>
        <span class="n">north_data</span> <span class="o">=</span> <span class="n">src_north</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">north_meta</span> <span class="o">=</span> <span class="n">src_north</span><span class="o">.</span><span class="n">meta</span>

    <span class="k">with</span> <span class="n">rio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">Vertical_InSAR</span><span class="p">)</span> <span class="k">as</span> <span class="n">src_vertical</span><span class="p">:</span>
        <span class="n">vertical_data</span> <span class="o">=</span> <span class="n">src_vertical</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">vertical_meta</span> <span class="o">=</span> <span class="n">src_vertical</span><span class="o">.</span><span class="n">meta</span>
       
    <span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">zoom</span>
    <span class="k">if</span> <span class="n">dem_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">rio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">Vertical_InSAR</span><span class="p">)</span> <span class="k">as</span> <span class="n">dem_src</span><span class="p">:</span>
            <span class="n">dem</span> <span class="o">=</span> <span class="n">dem_src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">dem_meta</span> <span class="o">=</span> <span class="n">src_vertical</span><span class="o">.</span><span class="n">meta</span>
            <span class="n">xres</span><span class="p">,</span> <span class="n">yres</span><span class="o">=</span><span class="n">dem_src</span><span class="o">.</span><span class="n">res</span>
        <span class="n">zoom_factor_dem</span> <span class="o">=</span> <span class="p">(</span><span class="n">north_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">dem</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">north_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">dem</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">resized_dem_data</span> <span class="o">=</span> <span class="n">zoom</span><span class="p">(</span><span class="n">dem</span><span class="p">,</span> <span class="n">zoom_factor_dem</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    

    <span class="c1"># Calculate the zoom factors for each dataset</span>
    <span class="n">zoom_factor_east</span> <span class="o">=</span> <span class="p">(</span><span class="n">north_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">east_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">north_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">east_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">zoom_factor_horizontal</span> <span class="o">=</span> <span class="p">(</span><span class="n">north_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">horizontal_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">north_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">horizontal_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">zoom_factor_vertical</span> <span class="o">=</span> <span class="p">(</span><span class="n">north_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">vertical_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">north_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">vertical_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
   

    <span class="c1"># Resize each dataset</span>
    <span class="n">resized_east_data</span> <span class="o">=</span> <span class="n">zoom</span><span class="p">(</span><span class="n">east_data</span><span class="p">,</span> <span class="n">zoom_factor_east</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Using order=1 (bilinear) for continuous data</span>
    <span class="n">resized_horizontal_data</span> <span class="o">=</span> <span class="n">zoom</span><span class="p">(</span><span class="n">horizontal_data</span><span class="p">,</span> <span class="n">zoom_factor_horizontal</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">resized_vertical_data</span> <span class="o">=</span> <span class="n">zoom</span><span class="p">(</span><span class="n">vertical_data</span><span class="p">,</span> <span class="n">zoom_factor_vertical</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">D3D</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">resized_east_data</span><span class="p">,</span> <span class="n">resized_vertical_data</span> <span class="p">)</span>

    <span class="n">plung_radians</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">resized_vertical_data</span><span class="o">/</span><span class="n">D3D</span><span class="p">)</span>
    <span class="n">plung_degree</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">plung_radians</span><span class="p">)</span>
    
    <span class="n">DH</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">resized_east_data</span><span class="p">,</span> <span class="n">north_data</span><span class="p">)</span>

    <span class="n">trend_radians</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">north_data</span><span class="o">/</span><span class="n">DH</span><span class="p">)</span>
    <span class="n">trend_degrees</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">trend_radians</span><span class="p">)</span>
    <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Trend in degree raw data: &quot;</span><span class="p">,</span> <span class="n">trend_degrees</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">trend_degrees</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="n">trend_degrees</span><span class="o">=</span><span class="p">(</span><span class="mi">450</span> <span class="o">-</span> <span class="n">trend_degrees</span> <span class="p">)</span> <span class="o">%</span> <span class="mi">360</span>
    
    
    <span class="c1"># if dem_path is not None:</span>
    <span class="c1">#     zoom_factor_D3D = (north_data.shape[0] / D3D.shape[0], north_data.shape[1] / D3D.shape[1])</span>
    <span class="c1">#     resized_D3D_data = zoom(D3D, zoom_factor_D3D, order=1)</span>
        
    <span class="c1">#     #elevation_change = np.tan(plung_radians) * resized_D3D_data</span>
    <span class="c1">#     # Example of combining with DEM (this part depends on what exactly you want to achieve)</span>
    <span class="c1">#     # Create masks for NaNs</span>
    <span class="c1">#     mask1 = np.isnan(resized_dem_data)</span>
    <span class="c1">#     mask2 = np.isnan(resized_vertical_data)</span>

<span class="c1"># Perform subtraction, treating NaNs as zeros</span>
        <span class="c1"># modified_dem = np.where(mask1, 0, resized_dem_data) - np.where(mask2, 0, resized_vertical_data)</span>
   
    <span class="n">meta</span><span class="o">=</span><span class="n">north_meta</span>
    
    <span class="c1">####################</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_folder</span> <span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_folder</span><span class="p">)</span>
    <span class="c1"># #Load images with rasterio</span>
    <span class="c1"># D_EW_InSAR=rio.open(horizontal_InSAR)</span>
    <span class="c1"># D_vertical_insar=rio.open(Vertical_InSAR)</span>
    <span class="c1"># D_EW_akhdefo=rio.open(EW_Akhdefo)</span>
    <span class="c1"># D_NS_akhdefo=rio.open(NS_Akhdefo)</span>
    <span class="c1"># #read images with rasterio</span>
    <span class="c1"># DEW_insar=D_EW_InSAR.read(1, masked=True)</span>
    <span class="c1"># #DEW_insar[DEW_insar==-32767.0]=np.nan</span>
    <span class="c1"># #DEW_insar=DEW_insar*1000</span>

    <span class="c1"># DEW_akhdefo=D_EW_akhdefo.read(1, masked=True)</span>
    <span class="c1"># D_vertical=D_vertical_insar.read(1, masked=True)</span>
    <span class="c1"># # D_vertical[D_vertical==-32767.0]=np.nan</span>
    <span class="c1"># # D_vertical=D_vertical*1000</span>

    <span class="c1"># DNS_akhdefo=D_NS_akhdefo.read(1, masked=True)</span>

    <span class="c1"># print (DEW_akhdefo.shape)</span>
    <span class="c1"># print(D_vertical.shape)</span>
    <span class="c1"># print (DEW_akhdefo.shape)</span>
    <span class="c1"># print(DEW_insar.shape)</span>
    <span class="c1"># DH=np.hypot(DEW_akhdefo, DNS_akhdefo)</span>
    <span class="c1"># D3D=np.hypot(DH, D_vertical )</span>

    <span class="c1"># meta=D_EW_InSAR.meta</span>

    <span class="c1"># trend_radians=np.arcsin(DNS_akhdefo/DH)</span>
    <span class="c1"># trend_degrees=np.degrees(trend_radians)</span>
    <span class="c1"># print (&quot;Trend in degree raw data: &quot;, trend_degrees.min(), trend_degrees.max())</span>
    <span class="c1"># trend_degrees=(450 - trend_degrees ) % 360</span>

    <span class="c1"># plung_radians=np.arcsin(D_vertical/D3D)</span>
    <span class="c1"># plung_degree=np.degrees(plung_radians)</span>
    <span class="c1"># #plung_degree=(90-plung_degree)% 90</span>

    <span class="c1"># print (&quot;DH: &quot;, DH.max(), DH.min())</span>
    <span class="c1"># print(&quot;D3D: &quot;, D3D.max(), D3D.min())</span>

    <span class="c1">#Save products</span>
    <span class="n">_3D_vel</span><span class="o">=</span><span class="n">output_folder</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="s2">&quot;D3D.tif&quot;</span>
    <span class="n">plung</span><span class="o">=</span><span class="n">output_folder</span><span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="s2">&quot;plung_degree.tif&quot;</span>
    <span class="n">trend</span><span class="o">=</span><span class="n">output_folder</span><span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="s2">&quot;trend_degrees.tif&quot;</span>
    <span class="c1"># with rio.open(&quot;DH.tif&quot;, &#39;w&#39;, **meta) as dst:</span>
    <span class="c1">#         dst.write(DH, indexes=1)</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">nodata</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">rio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">_3D_vel</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">meta</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
            <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">D3D</span><span class="p">,</span> <span class="n">indexes</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">rio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">trend</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">meta</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
            <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">trend_degrees</span><span class="p">,</span> <span class="n">indexes</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">rio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">plung</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">meta</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
            <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">plung_degree</span><span class="p">,</span> <span class="n">indexes</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            
    <span class="c1"># if dem_path is not None:</span>
    <span class="c1">#     dempath=output_folder+ &quot;/&quot; + &quot;modified_dem.tif&quot;</span>
    <span class="c1">#     with rio.open(dempath, &#39;w&#39;, **meta) as dst:</span>
    <span class="c1">#         dst.write(modified_dem, indexes=1)</span>
        


    
    <span class="c1"># p1=akhdefo_viewer(Path_to_DEMFile=demFile, rasterfile=_3D_vel , colorbar_label=&quot;mm/year&quot;, title=&quot;3D Velocity&quot;, pixel_resolution_meter=3.125, outputfolder=output_folder,</span>
    <span class="c1"># outputfileName=&quot;3D_Disp.jpg&quot;,  cmap=cmocean.cm.speed, alpha=0.8, noDATA_Mask=True, normalize=True)</span>
    
    <span class="c1"># p2=akhdefo_viewer(Path_to_DEMFile=demFile, rasterfile=plung , colorbar_label=&quot;degrees&quot;, title=&quot;Plunge of Dispalcement Velocity&quot;, pixel_resolution_meter=3.125, outputfolder=output_folder,</span>
    <span class="c1"># outputfileName=&quot;plunge.jpg&quot;, cmap=cmocean.cm.delta, alpha=0.8, noDATA_Mask=True, normalize=True)</span>
    <span class="c1"># p3=akhdefo_viewer(Path_to_DEMFile=demFile, rasterfile=trend , colorbar_label=&quot;degress&quot;, title=&quot;Trend of Dispalcement Velocity&quot;, pixel_resolution_meter=3.125, outputfolder=output_folder,</span>
    <span class="c1"># outputfileName=&quot;trend.jpg&quot;, cmap=cmocean.cm.phase, alpha=0.8, noDATA_Mask=True, normalize=True)</span>
    
    <span class="n">akhdefo_viewer</span><span class="p">(</span><span class="n">path_to_dem_file</span><span class="o">=</span><span class="n">dem_path</span><span class="p">,</span> <span class="n">raster_file</span><span class="o">=</span><span class="n">_3D_vel</span><span class="p">,</span> <span class="n">output_folder</span><span class="o">=</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;3D Velocity&#39;</span><span class="p">,</span> 
                   <span class="n">pixel_resolution_meters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_file_name</span><span class="o">=</span><span class="s2">&quot;3D_Disp.jpg&quot;</span><span class="p">,</span> 
                   <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">unit_conversion</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">no_data_mask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                   <span class="n">colormap</span><span class="o">=</span><span class="n">cmocean</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">speed</span><span class="p">,</span> <span class="n">min_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                   <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">colorbar_label</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">show_figure</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="n">akhdefo_viewer</span><span class="p">(</span><span class="n">path_to_dem_file</span><span class="o">=</span><span class="n">dem_path</span><span class="p">,</span> <span class="n">raster_file</span><span class="o">=</span><span class="n">plung</span><span class="p">,</span> <span class="n">output_folder</span><span class="o">=</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Plunge of Dispalcement Velocity&#39;</span><span class="p">,</span> 
                   <span class="n">pixel_resolution_meters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_file_name</span><span class="o">=</span><span class="s2">&quot;plunge.jpg&quot;</span><span class="p">,</span> 
                   <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">unit_conversion</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">no_data_mask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                   <span class="n">colormap</span><span class="o">=</span><span class="s1">&#39;hsv&#39;</span><span class="p">,</span> <span class="n">min_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                   <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">colorbar_label</span><span class="o">=</span><span class="s1">&#39;degrees&#39;</span><span class="p">,</span> <span class="n">show_figure</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="n">akhdefo_viewer</span><span class="p">(</span><span class="n">path_to_dem_file</span><span class="o">=</span><span class="n">dem_path</span><span class="p">,</span> <span class="n">raster_file</span><span class="o">=</span><span class="n">trend</span><span class="p">,</span> <span class="n">output_folder</span><span class="o">=</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Trend of Dispalcement Velocity&#39;</span><span class="p">,</span> 
                   <span class="n">pixel_resolution_meters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_file_name</span><span class="o">=</span><span class="s2">&quot;trend.jpg&quot;</span><span class="p">,</span> 
                   <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">unit_conversion</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">no_data_mask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                   <span class="n">colormap</span><span class="o">=</span><span class="n">cmocean</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">phase</span><span class="p">,</span> <span class="n">min_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                   <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">colorbar_label</span><span class="o">=</span><span class="s1">&#39;degrees&#39;</span><span class="p">,</span> <span class="n">show_figure</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>



        
        
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">import</span> <span class="nn">gstools</span> <span class="k">as</span> <span class="nn">gs</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pykrige.kriging_tools</span> <span class="k">as</span> <span class="nn">kt</span>
<span class="kn">from</span> <span class="nn">pykrige.ok</span> <span class="kn">import</span> <span class="n">OrdinaryKriging</span>
<span class="kn">from</span> <span class="nn">pykrige.uk</span> <span class="kn">import</span> <span class="n">UniversalKriging</span>
<span class="kn">import</span> <span class="nn">rasterio</span>
<span class="kn">from</span> <span class="nn">rasterio.features</span> <span class="kn">import</span> <span class="n">geometry_mask</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">median_filter</span>
<span class="kn">from</span> <span class="nn">skimage.filters</span> <span class="kn">import</span> <span class="n">gaussian</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">akhdefo_functions</span> <span class="kn">import</span> <span class="n">mask_raster</span>


<div class="viewcode-block" id="Auto_Variogram">
<a class="viewcode-back" href="../../akhdefo_functions.html#akhdefo_functions.Akhdefo_utils.Auto_Variogram">[docs]</a>
<span class="k">def</span> <span class="nf">Auto_Variogram</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">column_attribute</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">latlon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">aoi_shapefile</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">pixel_size</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">num_chunks</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">overlap_percentage</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out_fileName</span><span class="o">=</span><span class="s1">&#39;interpolated_kriging&#39;</span><span class="p">,</span> 
                   <span class="n">plot_folder</span><span class="o">=</span><span class="s1">&#39;kriging_plots&#39;</span><span class="p">,</span> <span class="n">geo_folder</span><span class="o">=</span><span class="s1">&#39;geo_rasterFolder&#39;</span><span class="p">,</span> <span class="n">smoothing_kernel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mask</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span> <span class="p">,</span> <span class="n">UTM_Zone</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">krig_method</span><span class="o">=</span><span class="s1">&#39;ordinary&#39;</span> <span class="p">,</span> <span class="n">drift_functions</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">detrend_data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span>
<span class="w">     </span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function performs automatic selection of the optimal variogram model for spatial data interpolation. </span>
<span class="sd">    It also supports clipping of the interpolation results to a specified Area of Interest (AOI). The function </span>
<span class="sd">    accepts both GeoDataFrame objects and file paths (specifically, shapefile paths) as input data sources.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    ------------</span>
<span class="sd">    data : str or gpd.GeoDataFrame, optional</span>
<span class="sd">        The path to a shapefile containing point data, or a GeoDataFrame. For shapefiles, they must include </span>
<span class="sd">        &#39;x&#39;, &#39;y&#39; coordinates (or &#39;lat&#39;, &#39;lon&#39; if latlon is set to True). Defaults to an empty string.</span>

<span class="sd">    column_attribute : str, optional</span>
<span class="sd">        The name of the attribute within the shapefile or GeoDataFrame to be interpolated. </span>

<span class="sd">    latlon : bool, optional</span>
<span class="sd">        Indicates whether the input data uses latitude and longitude (True) or Cartesian coordinates (False). </span>
<span class="sd">        Defaults to False.</span>

<span class="sd">    aoi_shapefile : str, optional</span>
<span class="sd">        The path to a shapefile that defines the Area of Interest (AOI) for clipping the interpolation results. </span>
<span class="sd">        Defaults to an empty string.</span>

<span class="sd">    pixel_size : int, optional</span>
<span class="sd">        The resolution size for the interpolated grid. Defaults to 20.</span>

<span class="sd">    num_chunks : int, optional</span>
<span class="sd">        The number of chunks for processing to mitigate memory issues. Adjust as needed. Defaults to 10.</span>

<span class="sd">    overlap_percentage : float, optional</span>
<span class="sd">        The percentage of overlap between chunks, ranging from 0 to 1.0. Defaults to 0.</span>

<span class="sd">    out_fileName : str, optional</span>
<span class="sd">        The name for the output GeoTIFF file storing the interpolation results. Defaults to &#39;interpolated_kriging&#39;.</span>

<span class="sd">    plot_folder : str, optional</span>
<span class="sd">        Directory path to save plots. Defaults to &#39;kriging_plots&#39;.</span>

<span class="sd">    geo_folder : str, optional</span>
<span class="sd">        Directory path for saving geospatial raster files. Defaults to &#39;geo_rasterFolder&#39;.</span>

<span class="sd">    smoothing_kernel : int, optional</span>
<span class="sd">        The size of the smoothing kernel to be used. Defaults to 2.</span>

<span class="sd">    mask : [np.ndarray], optional</span>
<span class="sd">        A numpy array to be used as a mask for the interpolation.</span>

<span class="sd">    UTM_Zone : str, optional</span>
<span class="sd">        The UTM Zone designation (&#39;N&#39; for Northern Hemisphere or &#39;S&#39; for Southern Hemisphere).</span>

<span class="sd">    krig_method : str, optional</span>
<span class="sd">        The method of kriging to be used, either &#39;ordinary&#39; or &#39;universal&#39;. Defaults to &#39;ordinary&#39;.</span>

<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    drift_functions: str, optional </span>
<span class="sd">        only works if krig_method=&#39;universal&#39; available options &quot;linear&quot;, &quot;quadratic&quot;, &quot;x&quot;  , &quot;y&quot;</span>
<span class="sd">    </span>
<span class="sd">    detrend_data : bool , optional</span>
<span class="sd">        if True removes the linear trend from the interpolated data and save the detrended data as geotif</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    numpy.ndarray</span>
<span class="sd">        A 2D grid of interpolated values, clipped to the specified AOI if an AOI shapefile is provided.</span>

<span class="sd">    Raises:</span>
<span class="sd">    -------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If the input data is not a valid shapefile path or GeoDataFrame.</span>
<span class="sd">        If essential columns (x, y or lat, lon) are missing in the input data.</span>

<span class="sd">    Notes:</span>
<span class="sd">    ------</span>
<span class="sd">    The function generates two types of plots:</span>
<span class="sd">    1. Fitted variogram models against the experimental variogram.</span>
<span class="sd">    2. The interpolation result using the selected variogram model.</span>

<span class="sd">    Dependencies:</span>
<span class="sd">    -------------</span>
<span class="sd">    Requires geopandas, gstools, pykrige, matplotlib, and rasterio libraries.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;.shp&#39;</span><span class="p">:</span>
            <span class="n">geodata</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            
            <span class="n">geom</span><span class="o">=</span><span class="n">geodata</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span>
            <span class="n">crs_ini</span><span class="o">=</span><span class="n">geodata</span><span class="o">.</span><span class="n">crs</span>
           
            
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unsupported file format.&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">):</span>
        <span class="n">geodata</span> <span class="o">=</span> <span class="n">data</span>
        
        
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unsupported data type.&quot;</span><span class="p">)</span>
    
    <span class="c1"># Check for necessary columns in the shapefile</span>
    <span class="c1">#check_shapefile_columns(geodata, latlon)</span>
    
    <span class="c1"># Change the dtype of a specific column to float32</span>
    <span class="n">geodata</span><span class="p">[</span><span class="n">column_attribute</span><span class="p">]</span> <span class="o">=</span> <span class="n">geodata</span><span class="p">[</span><span class="n">column_attribute</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
    <span class="c1"># Now interpolate NaN values in the column</span>
    
    
    <span class="k">if</span> <span class="n">latlon</span><span class="p">:</span>
        <span class="c1"># Convert CRS to EPSG:4326 (Wgs84)</span>
        <span class="n">geodata</span> <span class="o">=</span> <span class="n">geodata</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">epsg</span><span class="o">=</span><span class="mi">4326</span><span class="p">)</span>
        <span class="c1"># if geodata.crs is not None and geodata.crs.to_epsg() == 4326: </span>
        <span class="n">x</span><span class="o">=</span><span class="n">geodata</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">x</span>
        <span class="n">y</span><span class="o">=</span><span class="n">geodata</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">y</span>
        
        <span class="c1"># else:</span>
        <span class="c1">#     x=geodata.geometry.x</span>
        <span class="c1">#     y=geodata.geometry.y</span>
            <span class="c1"># x, y = utm_to_latlon(easting=geodata.geometry.x, northing=geodata.geometry.y, zone_number=10, zone_letter=UTM_Zone)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">geodata</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">geodata</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">y</span>

    <span class="n">z</span> <span class="o">=</span> <span class="n">geodata</span><span class="p">[</span><span class="n">column_attribute</span><span class="p">]</span>
    
    <span class="c1"># Ensure x, y, and z are float32</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">geodata</span><span class="p">[</span><span class="n">column_attribute</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    
    <span class="c1"># if geodata.crs is not None and geodata.crs.to_epsg() == 4326:</span>
    <span class="c1">#     latlon=True</span>
    
    <span class="k">if</span> <span class="n">latlon</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1">#bins = gs.standard_bins(pos=(y, x), max_dist=10)</span>
            <span class="c1">#bins, sampling_size=2000, sampling_seed=19920516 ,</span>
            <span class="n">bin_center</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">=</span> <span class="n">gs</span><span class="o">.</span><span class="n">vario_estimate</span><span class="p">((</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">z</span><span class="p">,</span>  <span class="n">latlon</span><span class="o">=</span><span class="n">latlon</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Catching any exception and handling it</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Operation failed with error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">bins</span> <span class="o">=</span> <span class="n">gs</span><span class="o">.</span><span class="n">standard_bins</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">max_dist</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">bin_center</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">=</span> <span class="n">gs</span><span class="o">.</span><span class="n">vario_estimate</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">z</span><span class="p">,</span>  <span class="n">latlon</span><span class="o">=</span><span class="n">latlon</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Catching any exception and handling it</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Operation failed with error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Load AOI shapefile if provided</span>
    <span class="k">if</span> <span class="n">aoi_shapefile</span><span class="p">:</span>
        <span class="n">aoi</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">aoi_shapefile</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">aoi</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">geodata</span><span class="o">.</span><span class="n">crs</span><span class="p">):</span>
            <span class="n">aoi</span> <span class="o">=</span> <span class="n">aoi</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">geodata</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
    
    <span class="c1"># Models to test</span>
    <span class="n">models</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Gaussian&quot;</span><span class="p">:</span> <span class="n">gs</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">,</span>
        <span class="s2">&quot;Exponential&quot;</span><span class="p">:</span> <span class="n">gs</span><span class="o">.</span><span class="n">Exponential</span><span class="p">,</span>
        <span class="s2">&quot;Matern&quot;</span><span class="p">:</span> <span class="n">gs</span><span class="o">.</span><span class="n">Matern</span><span class="p">,</span>
        <span class="s2">&quot;Integral&quot;</span><span class="p">:</span> <span class="n">gs</span><span class="o">.</span><span class="n">Integral</span><span class="p">,</span>
        <span class="s2">&quot;Cubic&quot;</span><span class="p">:</span> <span class="n">gs</span><span class="o">.</span><span class="n">Cubic</span><span class="p">,</span>
        <span class="s2">&quot;Stable&quot;</span><span class="p">:</span> <span class="n">gs</span><span class="o">.</span><span class="n">Stable</span><span class="p">,</span>
        <span class="s2">&quot;Rational&quot;</span><span class="p">:</span> <span class="n">gs</span><span class="o">.</span><span class="n">Rational</span><span class="p">,</span>
        <span class="s2">&quot;Spherical&quot;</span><span class="p">:</span> <span class="n">gs</span><span class="o">.</span><span class="n">Spherical</span><span class="p">,</span>
        <span class="s2">&quot;SuperSpherical&quot;</span><span class="p">:</span> <span class="n">gs</span><span class="o">.</span><span class="n">SuperSpherical</span><span class="p">,</span>
        <span class="s2">&quot;JBessel&quot;</span><span class="p">:</span> <span class="n">gs</span><span class="o">.</span><span class="n">JBessel</span><span class="p">,</span>
        <span class="s2">&quot;HyperSpherical&quot;</span><span class="p">:</span> <span class="n">gs</span><span class="o">.</span><span class="n">HyperSpherical</span><span class="p">,</span>
        <span class="s2">&quot;TPLSimple&quot;</span><span class="p">:</span> <span class="n">gs</span><span class="o">.</span><span class="n">TPLSimple</span>
    
        
    <span class="p">}</span>

    <span class="n">scores</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1">#fig, (ax1, ax2, ax3) = plt.subplots(ncols=1, nrows=3, figsize=(15, 10))</span>
    

    <span class="kn">import</span> <span class="nn">matplotlib.gridspec</span> <span class="k">as</span> <span class="nn">gridspec</span>
    <span class="c1"># Setting up a professional style</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn-white&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">})</span>
    
    <span class="c1"># Create a grid for the subplots</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
    <span class="n">grid_fig</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>

    <span class="n">ax1</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">grid_fig</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">bin_center</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>

    <span class="n">best_model</span><span class="p">,</span> <span class="n">best_score</span><span class="p">,</span> <span class="n">best_fit</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="kc">None</span>
    
    <span class="n">successful_model</span> <span class="o">=</span> <span class="kc">None</span>

    
    <span class="k">for</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">Model</span> <span class="ow">in</span> <span class="n">models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
          
            <span class="k">if</span> <span class="n">latlon</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
                <span class="n">bin_center</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">=</span> <span class="n">gs</span><span class="o">.</span><span class="n">vario_estimate</span><span class="p">((</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">),</span> <span class="n">z</span><span class="p">,</span> <span class="n">latlon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">fit_model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">latlon</span><span class="o">=</span><span class="n">latlon</span><span class="p">)</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">r2</span> <span class="o">=</span> <span class="n">fit_model</span><span class="o">.</span><span class="n">fit_variogram</span><span class="p">(</span> <span class="n">bin_center</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">sill</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">z</span><span class="p">),</span> <span class="n">nugget</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_r2</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">scores</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">fit_model</span><span class="p">,</span> <span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="n">r2</span><span class="p">}</span>
                
                <span class="k">if</span> <span class="n">r2</span> <span class="o">&gt;</span> <span class="n">best_score</span><span class="p">:</span>
                    <span class="n">best_score</span> <span class="o">=</span> <span class="n">r2</span>
                    <span class="n">best_model</span> <span class="o">=</span> <span class="n">model_name</span>
                    <span class="n">best_fit</span> <span class="o">=</span> <span class="n">fit_model</span>
                
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fit_model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">latlon</span><span class="o">=</span><span class="n">latlon</span><span class="p">)</span>
                <span class="c1">#Model(dim=2, len_scale=4, anis=0.2, angles=-0.5, var=0.5, nugget=0.1)</span>
                
                <span class="c1">#if fit_model is not None:</span>
            
                <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">r2</span> <span class="o">=</span> <span class="n">fit_model</span><span class="o">.</span><span class="n">fit_variogram</span><span class="p">(</span><span class="n">bin_center</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">return_r2</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="n">nugget</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">scores</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">fit_model</span><span class="p">,</span> <span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="n">r2</span><span class="p">}</span>
            
            <span class="c1"># scores[model_name] = model_name</span>
            <span class="c1"># scores[&#39;score&#39;] = r2</span>
            <span class="c1"># scores[&#39;best_fit&#39;]=fit_model</span>
            
                <span class="k">if</span> <span class="n">r2</span> <span class="o">&gt;</span> <span class="n">best_score</span><span class="p">:</span>
                    <span class="n">best_score</span> <span class="o">=</span> <span class="n">r2</span>
                    <span class="n">best_model</span> <span class="o">=</span> <span class="n">model_name</span>
                    <span class="n">best_fit</span> <span class="o">=</span> <span class="n">fit_model</span>
            
            <span class="c1"># Plot the model</span>
            <span class="c1">#if fit_model is not None:</span>
            <span class="n">fit_model</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_max</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">bin_center</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2"> (R2: </span><span class="si">{</span><span class="n">r2</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># If there&#39;s any error</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error with model </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Variogram Models with Fitted Data&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">best_fit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">best_fit</span><span class="o">=</span><span class="s2">&quot;spherical&quot;</span>
    
    <span class="c1"># Sort scores based on score</span>
    <span class="n">sorted_scores</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;score&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_zgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">best_fit</span> <span class="p">,</span> <span class="n">gridy</span><span class="p">,</span> <span class="n">krig_method</span><span class="p">,</span> <span class="n">drift_functions</span><span class="o">=</span><span class="n">drift_functions</span><span class="p">):</span>
        
        <span class="n">z</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">z</span><span class="p">)]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">z</span><span class="p">)]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">z</span><span class="p">)]</span>
        
        <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">z</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        
       
        <span class="c1"># Calculate the mean and standard deviation of the Z column</span>
        <span class="n">mean_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="n">std_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>

        <span class="c1"># Define the threshold for Z-score (e.g., ±2.5)</span>
        <span class="n">z_score_threshold</span> <span class="o">=</span> <span class="mf">3.5</span>

        <span class="c1"># Identify indices where Z is below or above the threshold</span>
        <span class="n">below_threshold_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">z</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">mean_z</span> <span class="o">-</span> <span class="n">z_score_threshold</span> <span class="o">*</span> <span class="n">std_z</span><span class="p">))</span>
        <span class="n">above_threshold_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">z</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">mean_z</span> <span class="o">+</span> <span class="n">z_score_threshold</span> <span class="o">*</span> <span class="n">std_z</span><span class="p">))</span>

        <span class="c1"># Replace values below or above the threshold with the mean of Z</span>
        <span class="n">z</span><span class="p">[</span><span class="n">below_threshold_indices</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_z</span>
        <span class="n">z</span><span class="p">[</span><span class="n">above_threshold_indices</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_z</span>

        
        
        <span class="n">range_x</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">num_points_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">range_x</span> <span class="o">/</span> <span class="n">pixel_size</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">gridx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">num_points_x</span><span class="p">)</span>
        <span class="n">gridx</span> <span class="o">=</span> <span class="n">gridx</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        
        
        
        
        <span class="k">if</span> <span class="n">krig_method</span><span class="o">==</span><span class="s1">&#39;ordinary&#39;</span><span class="p">:</span>
            
            <span class="c1"># OK = OrdinaryKriging(x, y, z, best_fit, weight=False, verbose=False, enable_plotting=False , exact_values=True, pseudo_inv=True)</span>
            <span class="c1"># z_grid, _ = OK.execute(&quot;grid&quot;, gridx, gridy)</span>
            
            <span class="n">OK</span> <span class="o">=</span> <span class="n">gs</span><span class="o">.</span><span class="n">krige</span><span class="o">.</span><span class="n">Ordinary</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">best_fit</span><span class="p">,</span> <span class="n">cond_pos</span><span class="o">=</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">cond_val</span><span class="o">=</span><span class="n">z</span> <span class="p">,</span> <span class="n">normalizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">trend</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cond_err</span><span class="o">=</span><span class="s1">&#39;nugget&#39;</span><span class="p">,</span> 
                                 <span class="n">pseudo_inv</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pseudo_inv_type</span><span class="o">=</span><span class="s1">&#39;pinvh&#39;</span><span class="p">,</span> <span class="n">fit_normalizer</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fit_variogram</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">OK</span><span class="o">.</span><span class="n">set_pos</span><span class="p">((</span><span class="n">gridy</span><span class="p">,</span> <span class="n">gridx</span><span class="p">),</span> <span class="n">mesh_type</span><span class="o">=</span><span class="s2">&quot;structured&quot;</span><span class="p">)</span>
            <span class="n">OK</span><span class="p">(</span><span class="n">return_var</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="s2">&quot;vel&quot;</span><span class="p">)</span>
            <span class="n">OK</span><span class="p">(</span><span class="n">only_mean</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="s2">&quot;mean_vel&quot;</span><span class="p">)</span>
            <span class="n">z_grid</span><span class="o">=</span><span class="n">OK</span><span class="p">[</span><span class="s2">&quot;vel&quot;</span><span class="p">]</span>
            
    
        <span class="k">elif</span> <span class="n">krig_method</span><span class="o">==</span><span class="s1">&#39;simple&#39;</span><span class="p">:</span>
            <span class="n">SK</span> <span class="o">=</span> <span class="n">gs</span><span class="o">.</span><span class="n">krige</span><span class="o">.</span><span class="n">Simple</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">best_fit</span><span class="p">,</span> <span class="n">cond_pos</span><span class="o">=</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">cond_val</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">z</span><span class="p">),</span> <span class="n">normalizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">trend</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cond_err</span><span class="o">=</span><span class="s1">&#39;nugget&#39;</span><span class="p">,</span> 
                                 <span class="n">pseudo_inv</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pseudo_inv_type</span><span class="o">=</span><span class="s1">&#39;pinvh&#39;</span><span class="p">,</span> <span class="n">fit_normalizer</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fit_variogram</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">SK</span><span class="o">.</span><span class="n">set_pos</span><span class="p">((</span><span class="n">gridy</span><span class="p">,</span> <span class="n">gridx</span><span class="p">),</span> <span class="n">mesh_type</span><span class="o">=</span><span class="s2">&quot;structured&quot;</span><span class="p">)</span>
            <span class="n">SK</span><span class="p">(</span><span class="n">return_var</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="s2">&quot;vel&quot;</span><span class="p">)</span>
            <span class="n">SK</span><span class="p">(</span><span class="n">only_mean</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="s2">&quot;mean_vel&quot;</span><span class="p">)</span>
            <span class="n">z_grid</span><span class="o">=</span><span class="n">SK</span><span class="p">[</span><span class="s2">&quot;vel&quot;</span><span class="p">]</span>
            
          
        
        <span class="k">elif</span> <span class="n">krig_method</span><span class="o">==</span><span class="s1">&#39;universal&#39;</span><span class="p">:</span>   
            <span class="c1"># UK = UniversalKriging(x, y, z, variogram_model=best_fit, exact_values=True, pseudo_inv=True, drift_terms=[&quot;regional_linear&quot;])</span>
            <span class="c1"># z_grid, _ = UK.execute(&quot;grid&quot;, gridx, gridy) </span>
            <span class="c1"># drift_terms=[&quot;regional_linear&quot;]</span>
            <span class="k">if</span> <span class="n">drift_functions</span><span class="o">==</span><span class="s1">&#39;x&#39;</span><span class="p">:</span>
                <span class="k">def</span> <span class="nf">drift</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">x</span>
            <span class="k">elif</span> <span class="n">drift_functions</span><span class="o">==</span><span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="k">def</span> <span class="nf">drift</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">y</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">drift</span><span class="o">=</span><span class="n">drift_functions</span>
            
            <span class="n">uk</span> <span class="o">=</span> <span class="n">gs</span><span class="o">.</span><span class="n">krige</span><span class="o">.</span><span class="n">Universal</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">best_fit</span><span class="p">,</span> <span class="n">cond_pos</span><span class="o">=</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">cond_val</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">normalizer</span><span class="o">=</span><span class="kc">None</span> <span class="p">,</span> <span class="n">trend</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cond_err</span><span class="o">=</span><span class="s1">&#39;nugget&#39;</span><span class="p">,</span> 
                                 <span class="n">pseudo_inv</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pseudo_inv_type</span><span class="o">=</span><span class="s1">&#39;pinvh&#39;</span><span class="p">,</span> <span class="n">fit_normalizer</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fit_variogram</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drift_functions</span><span class="o">=</span><span class="n">drift</span><span class="p">)</span>
            
            <span class="n">uk</span><span class="o">.</span><span class="n">set_pos</span><span class="p">((</span><span class="n">gridy</span><span class="p">,</span> <span class="n">gridx</span><span class="p">),</span> <span class="n">mesh_type</span><span class="o">=</span><span class="s2">&quot;structured&quot;</span><span class="p">)</span>
            <span class="n">uk</span><span class="p">(</span><span class="n">return_var</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="s2">&quot;vel&quot;</span><span class="p">)</span>
            <span class="n">uk</span><span class="p">(</span><span class="n">only_mean</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="s2">&quot;mean_vel&quot;</span><span class="p">)</span>
            <span class="n">z_grid</span><span class="o">=</span><span class="n">uk</span><span class="p">[</span><span class="s2">&quot;vel&quot;</span><span class="p">]</span>
            <span class="c1">#uk1.structured((gridx, gridy))</span>
            <span class="c1"># z_grid=z_grid[0]</span>
            
            
           
        
        
        <span class="c1"># from skimage import exposure</span>
        <span class="c1"># z_min = np.nanmin(z)</span>
        <span class="c1"># z_max = np.nanmax(z)</span>
        
        <span class="c1"># # Ensure interpolated values do not exceed original z data range</span>
        
        <span class="c1">#if np.nanmax(z_grid) &gt; z_max or np.nanmin(z_grid) &lt; z_min:</span>
            <span class="c1"># z_mean = np.nanmean(z_grid)</span>
            <span class="c1"># z_grid[np.where(z_grid &gt; z_max)] = z_mean</span>
            <span class="c1"># z_grid[np.where(z_grid &lt; z_min)] = z_mean</span>
        <span class="c1">#z_grid = exposure.rescale_intensity(z_grid, in_range=(np.nanmin(z_grid), np.nanmax(z_grid)), out_range=(z_min, z_max))</span>
            
        
        <span class="c1">#z_grid=gs.normalizer.remove_trend_norm_mean((gridy, gridx), z_grid, mean=np.nanmean(z_grid), normalizer=None, trend=None, mesh_type=&#39;unstructured&#39;, value_type=&#39;scalar&#39;, check_shape=True, stacked=False, fit_normalizer=True)</span>

            
        <span class="c1"># z_grid[np.where(z_grid &lt; z_min)] = z_mean</span>
        <span class="c1"># z_grid[np.where(z_grid &gt; z_max)] = z_mean</span>

        
       
        <span class="c1"># normalizers = [</span>
        <span class="c1">#     gs.normalizer.BoxCox,</span>
        <span class="c1">#     gs.normalizer.YeoJohnson,</span>
        <span class="c1">#     gs.normalizer.Modulus,</span>
        <span class="c1">#     gs.normalizer.Manly,</span>
        <span class="c1"># ]</span>
        
                <span class="c1"># external drift at conditioning points</span>
        <span class="c1"># (given as a sinusodial drift in x direciton)</span>
        <span class="c1"># ext_drift_cond = np.sin(y)</span>

        <span class="c1"># # external drift at the output grid</span>
        <span class="c1"># ext_drift_grid = np.repeat(np.sin(gridx), len(gridy))</span>


        <span class="c1"># # perform the kriging and plot results</span>
        <span class="c1"># EDK = gs.krige.ExtDrift(</span>
        <span class="c1">#     model=best_fit, </span>
        <span class="c1">#     cond_pos=(x, y), </span>
        <span class="c1">#     cond_val=z,</span>
        <span class="c1">#     ext_drift=ext_drift_cond,</span>
        <span class="c1"># )</span>
        <span class="c1"># EDK.structured([gridy, gridx], ext_drift=ext_drift_grid)</span>
        <span class="c1"># EDK.plot()</span>
    
        
        <span class="k">return</span> <span class="n">z_grid</span><span class="p">,</span> <span class="n">gridx</span>
    
    
    <span class="c1"># Function to detrend a 2D array with NaN handling</span>
    <span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">linregress</span>
    <span class="k">def</span> <span class="nf">detrend_2d</span><span class="p">(</span><span class="n">array</span><span class="p">):</span>
        <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nrows</span><span class="p">)</span>
        
        <span class="c1"># Initialize the detrended data array</span>
        <span class="n">detrended</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>

        <span class="c1"># Detrend each column</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncols</span><span class="p">):</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">array</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">)):</span>
                <span class="n">detrended</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">linregress</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">)],</span> <span class="n">y</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">)])</span>
                <span class="n">detrended</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="p">(</span><span class="n">slope</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="n">intercept</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">detrended</span> 

    <span class="c1"># Get global y grid before splitting</span>
    <span class="n">range_y_global</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">y</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">num_points_y_global</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">range_y_global</span> <span class="o">/</span> <span class="n">pixel_size</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">gridy_global</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">num_points_y_global</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    
    <span class="c1"># Get global x grid before splitting</span>
    <span class="n">range_x_global</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">num_points_x_global</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">range_x_global</span> <span class="o">/</span> <span class="n">pixel_size</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">gridx_global</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">num_points_x_global</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    

    <span class="k">def</span> <span class="nf">get_transform_from_gdf</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">pixel_size</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate an affine transform for a raster-like GeoDataFrame.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        - gdf: The GeoDataFrame.</span>
<span class="sd">        - pixel_size: The resolution (spacing) of your points/data.</span>

<span class="sd">        Returns:</span>
<span class="sd">        ---------</span>
<span class="sd">        - A rasterio Affine object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">west</span><span class="p">,</span> <span class="n">south</span><span class="p">,</span> <span class="n">east</span><span class="p">,</span> <span class="n">north</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">total_bounds</span>
        <span class="n">transform</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">from_origin</span><span class="p">(</span><span class="n">west</span><span class="p">,</span> <span class="n">north</span><span class="p">,</span> <span class="n">pixel_size</span><span class="p">,</span> <span class="n">pixel_size</span><span class="p">)</span>
        <span class="n">extent</span><span class="o">=</span><span class="n">gdf</span><span class="o">.</span><span class="n">total_bounds</span>
        <span class="k">return</span> <span class="n">transform</span><span class="p">,</span> <span class="n">extent</span>

    <span class="c1"># Break x, y, z into chunks</span>
    <span class="n">sorted_idxs</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
    <span class="n">chunks_x</span><span class="p">,</span> <span class="n">chunks_y</span><span class="p">,</span> <span class="n">chunks_z</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_chunks</span><span class="p">):</span>
        <span class="n">start_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">num_chunks</span><span class="p">)</span>
        <span class="n">end_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">num_chunks</span><span class="p">)</span>
        <span class="n">chunks_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">sorted_idxs</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]])</span>
        <span class="n">chunks_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">sorted_idxs</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]])</span>
        <span class="n">chunks_z</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">sorted_idxs</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]])</span>
    
    <span class="c1">############</span>
    
    <span class="c1"># Calculate overlap based on percentage of data (5% overlap in this example)</span>
    <span class="n">overlap</span> <span class="o">=</span> <span class="n">overlap_percentage</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="n">num_chunks</span>

    <span class="c1"># This list will store all z_grids and their corresponding gridx to be merged later</span>
    <span class="n">z_grids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">gridxs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Split and process data in chunks</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_chunks</span><span class="p">):</span>
        <span class="c1"># Define start and end for each chunk considering overlap</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="n">num_chunks</span> <span class="o">-</span> <span class="n">overlap</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="n">num_chunks</span> <span class="o">+</span> <span class="n">overlap</span>

        <span class="n">x_chunk</span> <span class="o">=</span> <span class="n">x</span><span class="p">[(</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="n">start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">)]</span>
        <span class="n">y_chunk</span> <span class="o">=</span> <span class="n">y</span><span class="p">[(</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="n">start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">)]</span>
        <span class="n">z_chunk</span> <span class="o">=</span> <span class="n">z</span><span class="p">[(</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="n">start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">)]</span>

        <span class="c1">#z_grid_chunk, gridx_chunk = get_zgrid(x_chunk, y_chunk, z_chunk, best_fit, gridy_global)</span>
        
        <span class="c1"># Try using the best model, then next best if it fails, and so on</span>
        <span class="k">for</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">model_info</span> <span class="ow">in</span> <span class="n">sorted_scores</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">z_grid_chunk</span><span class="p">,</span> <span class="n">gridx_chunk</span> <span class="o">=</span> <span class="n">get_zgrid</span><span class="p">(</span><span class="n">x_chunk</span><span class="p">,</span> <span class="n">y_chunk</span><span class="p">,</span> <span class="n">z_chunk</span><span class="p">,</span> <span class="n">model_info</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span> <span class="n">gridy_global</span><span class="p">,</span> <span class="n">krig_method</span><span class="o">=</span><span class="n">krig_method</span><span class="p">,</span> <span class="n">drift_functions</span><span class="o">=</span><span class="n">drift_functions</span><span class="p">)</span>
                <span class="n">z_grids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z_grid_chunk</span><span class="p">)</span>
                <span class="n">gridxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gridx_chunk</span><span class="p">)</span>
                <span class="n">successful_model</span> <span class="o">=</span> <span class="n">model_name</span>
                <span class="c1"># Use z_grid and gridx as needed</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error with model </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;kriging succeed with Model: </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2"> and score: </span><span class="si">{</span><span class="n">model_info</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        
        <span class="c1"># z_grids.append(z_grid_chunk)</span>
        <span class="c1"># gridxs.append(gridx_chunk)</span>
        
        <span class="c1"># Update the label of the successful model</span>
    <span class="k">if</span> <span class="n">successful_model</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">ax1</span><span class="o">.</span><span class="n">get_lines</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">get_label</span><span class="p">()</span> <span class="o">==</span> <span class="n">successful_model</span><span class="p">:</span>
                <span class="n">line</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">successful_model</span><span class="si">}</span><span class="s2"> (Success)&quot;</span><span class="p">)</span>
                <span class="k">break</span>

    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Variogram Models with successful model:</span><span class="si">{</span><span class="n">successful_model</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">overlap</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Blend the chunks together.</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">z_grids</span><span class="p">)):</span>
            <span class="c1"># Get overlapping columns</span>
            <span class="n">overlap_cols</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">overlap</span> <span class="o">/</span> <span class="n">pixel_size</span><span class="p">)))</span>

            <span class="c1"># Create a combined section of the overlapping regions from both chunks</span>
            <span class="n">combined_overlap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">z_grids</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">][:,</span> <span class="o">-</span><span class="n">overlap_cols</span><span class="p">:],</span> <span class="n">z_grids</span><span class="p">[</span><span class="n">i</span><span class="p">][:,</span> <span class="p">:</span><span class="n">overlap_cols</span><span class="p">]))</span>

            <span class="c1"># if smoothing_kernel is not None:</span>
                
            <span class="c1"># # Apply gaussian filter to the combined overlap</span>
            <span class="c1">#     filtered_overlap = gaussian(combined_overlap, sigma=smoothing_kernel)</span>
            <span class="c1"># else:</span>
            <span class="c1">#     filtered_overlap=combined_overlap</span>
            <span class="n">filtered_overlap</span><span class="o">=</span><span class="n">combined_overlap</span>
            <span class="c1"># Assign the filtered overlap back to the respective chunks</span>
            <span class="n">z_grids</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">][:,</span> <span class="o">-</span><span class="n">overlap_cols</span><span class="p">:]</span> <span class="o">=</span> <span class="n">filtered_overlap</span><span class="p">[:,</span> <span class="p">:</span><span class="n">overlap_cols</span><span class="p">]</span>
            <span class="n">z_grids</span><span class="p">[</span><span class="n">i</span><span class="p">][:,</span> <span class="p">:</span><span class="n">overlap_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtered_overlap</span><span class="p">[:,</span> <span class="n">overlap_cols</span><span class="p">:]</span>
    
       

    <span class="c1"># Merge all chunks together</span>
    <span class="n">z_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">z_grids</span><span class="p">)</span>
    <span class="c1"># Apply gaussian filter to the smooth edge artifcats</span>
    <span class="k">if</span> <span class="n">smoothing_kernel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">z_grid</span> <span class="o">=</span> <span class="n">gaussian</span><span class="p">(</span><span class="n">z_grid</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">smoothing_kernel</span><span class="p">)</span>
   
    <span class="k">def</span> <span class="nf">create_norm</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a normalization instance based on the data.</span>
<span class="sd">        If data has negative values, use TwoSlopeNorm with zero as the center.</span>
<span class="sd">        Otherwise, use standard normalization.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">matplotlib.colors</span> <span class="k">as</span> <span class="nn">mcolors</span>
        
        <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vmin</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">vmax</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Data has negative values, use TwoSlopeNorm</span>
            <span class="k">return</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">TwoSlopeNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vcenter</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Data has no negative values, use standard normalization</span>
            <span class="k">return</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>

    <span class="c1"># if mask is not None:</span>
    <span class="c1">#     z_grid=mask_raster(z_grid, mask )</span>
    
    <span class="c1"># Mask the interpolated values outside of AOI</span>
    <span class="k">if</span> <span class="n">aoi_shapefile</span><span class="p">:</span>
        <span class="n">transform</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">get_transform_from_gdf</span><span class="p">(</span><span class="n">aoi</span><span class="p">,</span> <span class="n">pixel_size</span><span class="p">)</span>
        <span class="n">shapes</span> <span class="o">=</span> <span class="n">aoi</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">values</span>
        <span class="c1">#transform = rasterio.transform.from_origin(min(gridx1.min(), gridx2.min()), max(gridy1.max(), gridy2.max()), abs(gridx1[1]-gridx1[0]), abs(gridy1[1]-gridy1[0]))</span>
        <span class="n">mask_aoi</span> <span class="o">=</span> <span class="n">geometry_mask</span><span class="p">(</span><span class="n">shapes</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span> <span class="n">out_shape</span><span class="o">=</span><span class="n">z_grid</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">all_touched</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">z_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_aoi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">z_grid</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">transform</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">get_transform_from_gdf</span><span class="p">(</span><span class="n">geodata</span><span class="p">,</span> <span class="n">pixel_size</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">z_grid</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="n">norm</span> <span class="o">=</span> <span class="n">create_norm</span><span class="p">(</span><span class="n">z_grid</span><span class="p">)</span>
        
    <span class="c1"># Interpolation Using Matern Variogram Model</span>
    <span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">grid_fig</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">z_grid</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;rainbow&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Interpolation: Krige-Method: </span><span class="si">{</span><span class="n">krig_method</span><span class="si">}</span><span class="s1"> kriging and Best Variogram Model: </span><span class="si">{</span><span class="n">successful_model</span><span class="si">}</span><span class="s1"> &#39;</span><span class="p">)</span>

    

    <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;driver&#39;</span><span class="p">:</span> <span class="s1">&#39;GTiff&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="s1">&#39;float32&#39;</span><span class="p">,</span>
        <span class="s1">&#39;nodata&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="n">z_grid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">z_grid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;crs&#39;</span><span class="p">:</span> <span class="n">geodata</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
        <span class="s1">&#39;transform&#39;</span><span class="p">:</span> <span class="n">transform</span>
    <span class="p">}</span>
    
    
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">geo_folder</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">geo_folder</span><span class="p">)</span>
    
    <span class="n">out_fileName_reg</span><span class="o">=</span><span class="n">out_fileName</span> <span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span> <span class="n">krig_method</span>
    <span class="n">geo_folder_reg</span><span class="o">=</span><span class="n">geo_folder</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="o">+</span> <span class="n">out_fileName_reg</span>
        
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">geo_folder_reg</span> <span class="o">+</span> <span class="s1">&#39;.tif&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">meta</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
        <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">z_grid</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">raster_data_detrended</span> <span class="o">=</span> <span class="n">detrend_2d</span><span class="p">(</span><span class="n">z_grid</span><span class="p">)</span>
    <span class="c1"># Detrended data</span>
    <span class="n">cmap_c</span> <span class="o">=</span> <span class="s1">&#39;coolwarm&#39;</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">raster_data_detrended</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;rainbow&#39;</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">create_norm</span><span class="p">(</span><span class="n">raster_data_detrended</span><span class="p">)</span>
        <span class="c1"># Detrended Interpolated Data</span>
    <span class="n">ax3</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">grid_fig</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">ax3</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">raster_data_detrended</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap_c</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax3</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Detrended Interpolated Data&quot;</span><span class="p">)</span>
        
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">plot_folder</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">plot_folder</span><span class="p">)</span>
    
    <span class="n">plot_folder</span><span class="o">=</span><span class="n">plot_folder</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="o">+</span> <span class="n">out_fileName_reg</span>
    
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plot_folder</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">))</span>
    
   
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    
    <span class="n">geo_folder_detrend</span><span class="o">=</span><span class="n">geo_folder</span><span class="o">+</span><span class="s2">&quot;/detrend&quot;</span>
        

        
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">geo_folder_detrend</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">geo_folder_detrend</span><span class="p">)</span>
        
        
    <span class="c1"># Apply the custom detrending function</span>
    <span class="k">if</span> <span class="n">detrend_data</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
        
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">geo_folder_detrend</span> <span class="o">+</span><span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">out_fileName_reg</span><span class="o">+</span> <span class="s1">&#39;_detrend.tif&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">meta</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
            <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">raster_data_detrended</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">z_grid</span></div>


<div class="viewcode-block" id="check_shapefile_columns">
<a class="viewcode-back" href="../../akhdefo_functions.html#akhdefo_functions.Akhdefo_utils.check_shapefile_columns">[docs]</a>
<span class="k">def</span> <span class="nf">check_shapefile_columns</span><span class="p">(</span><span class="n">geodata</span><span class="p">,</span> <span class="n">latlon</span><span class="p">):</span>
    <span class="n">required_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">latlon</span> <span class="k">else</span> <span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">required_columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">geodata</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Column &#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&#39; not found in the shapefile.&quot;</span><span class="p">)</span></div>




<div class="viewcode-block" id="akhdefo_download_planet">
<a class="viewcode-back" href="../../akhdefo_functions.html#akhdefo_functions.Akhdefo_utils.akhdefo_download_planet">[docs]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">akhdefo_download_planet</span><span class="p">(</span><span class="n">planet_api_key</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">AOI</span><span class="o">=</span><span class="s2">&quot;plinth.json&quot;</span><span class="p">,</span> <span class="n">start_date</span><span class="o">=</span> <span class="s2">&quot;May 1, 2016&quot;</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> 
                           <span class="n">item_type</span><span class="o">=</span><span class="s2">&quot;PSOrthoTile&quot;</span><span class="p">,</span> <span class="n">product_bundle</span><span class="o">=</span><span class="s2">&quot;analytic_sr_udm2&quot;</span><span class="p">,</span> <span class="n">clear_percent</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">cloud_filter</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">output_folder</span><span class="o">=</span><span class="s2">&quot;raw_data&quot;</span><span class="p">,</span> <span class="n">clip_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">download_data</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&#39;&#39;&#39; </span>
<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    Note: To use this function need to call await as below:</span>

<span class="sd">    await akhdefo_download_planet()</span>
<span class="sd">    </span>

<span class="sd">    planet_api_key: str = &quot;  &quot;</span>
<span class="sd">        input planet labs api </span>

<span class="sd">    AOI: str = &quot;plinth.json&quot;</span>
<span class="sd">        input area of interest in json file format</span>

<span class="sd">    start_date: str = &quot;May 1, 2016&quot;</span>
<span class="sd">        input start date as the following format &quot;Month Day, Year&quot;</span>

<span class="sd">    end_date: str = &quot;May 31, 2017&quot;</span>
<span class="sd">        input end date as the following format &quot;Month day, Year&quot;</span>


<span class="sd">    limit: int = 5</span>
<span class="sd">        input Maxumum number of images want to download; type None if you want to download images daily into the future but need to set the end_date empty as follow end_date=&quot;&quot;</span>

<span class="sd">    item_type: str = &quot;PSOrthoTile&quot;</span>
<span class="sd">        input item type to downoload please refere to planet labs website for further detalis: </span>
<span class="sd">        PSScene:	PlanetScope 3, 4, and 8 band scenes captured by the Dove satellite constellation</span>
<span class="sd">        REOrthoTile:	RapidEye OrthoTiles captured by the RapidEye satellite constellation</span>
<span class="sd">        REScene:	Unorthorectified strips captured by the RapidEye satellite constellation</span>
<span class="sd">        SkySatScene:	SkySat Scenes captured by the SkySat satellite constellation</span>
<span class="sd">        SkySatCollect:	Orthorectified scene composite of a SkySat collection</span>
<span class="sd">        SkySatVideo:	Full motion videos collected by a single camera from any of the active SkySats</span>
<span class="sd">        Landsat8L1G	Landsat8 Scenes: provided by USgs Landsat8 satellite</span>
<span class="sd">        Sentinel2L1C:	Copernicus Sentinel-2 Scenes provided by ESA Sentinel-2 satellite</span>

<span class="sd">    product_bundle: str = &quot;analytic_sr_udm2&quot;</span>
<span class="sd">        please refer to planetlabs website for further details and different options of product_bundle: default is analytic_sr_udm2</span>
<span class="sd">        (analytic,analytic_udm2, analytic_3b_udm2, analytic_5b , analytic_5b_udm2 , analytic_8b_udm2, visual, uncalibrated_dn, </span>
<span class="sd">        uncalibrated_dn_udm2, basic_analytic, basic_analytic_udm2, basic_analytic_8b_udm2, basic_uncalibrated_dn,</span>
<span class="sd">        basic_uncalibrated_dn_udm2, analytic_sr, analytic_sr_udm2, analytic_8b_sr_udm2, basic_analytic_nitf, </span>
<span class="sd">        basic_panchromatic, basic_panchromatic_dn, panchromatic, panchromatic_dn, panchromatic_dn_udm2,</span>
<span class="sd">        pansharpened, pansharpened_udm2 , basic_l1a_dn)</span>

<span class="sd">    clear_percent: int = 90</span>
<span class="sd">        Quality of the scene, if you need to download best images keep this value min 90. although, it will end up with less image acquistion </span>

<span class="sd">    cloud_filter: float = 0.1</span>
<span class="sd">        cloud percentage</span>

<span class="sd">    output_folder: str = &quot;raw_data&quot;</span>
<span class="sd">        output directory to save the orders</span>

<span class="sd">    clip_flag: bool</span>
<span class="sd">        True to clip the downloads to Area of interest json file format provided above</span>
<span class="sd">            </span>

<span class="sd">    download_data: bool </span>
<span class="sd">        True to download the data or False to preview the data</span>


<span class="sd">    &#39;&#39;&#39;</span>
    
    

    <span class="c1">#############</span>
    <span class="c1"># if your Planet API Key is not set as an environment variable, you can paste it below</span>

    <span class="n">planet_api_key</span><span class="o">=</span><span class="n">planet_api_key</span>
    <span class="k">if</span> <span class="n">planet_api_key</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
        <span class="n">API_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">planet_api_key</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">API_KEY</span> <span class="o">=</span> <span class="n">planet_api_key</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PL_API_KEY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">API_KEY</span>
        
        
    <span class="c1"># Setup the session</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>

    <span class="c1"># Authenticate</span>


    <span class="c1">#client = Auth.from_key(API_KEY)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">auth</span> <span class="o">=</span> <span class="p">(</span><span class="n">API_KEY</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="c1">#########</span>
    <span class="c1">#orders_url = &#39;https://api.planet.com/compute/ops/orders/v2&#39; </span>

    <span class="c1">############</span>
    <span class="c1"># response = requests.get(orders_url, auth=session.auth)</span>
    <span class="c1"># response</span>
    <span class="c1"># orders = response.json()[&#39;orders&#39;]</span>
    <span class="c1"># len(orders)</span>


    <span class="c1">############</span>



    <span class="c1"># We will also create a small helper function to print out JSON with proper indentation.</span>
    <span class="k">def</span> <span class="nf">indent</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

    <span class="c1">#Searching</span>
    <span class="c1">#We can search for items that are interesting by using the quick_search member function. Searches,</span>
    <span class="c1">#however, always require a proper request that includes a filter that selects the specific items to return as seach results.</span>
    
    <span class="k">if</span> <span class="n">AOI</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.shp&quot;</span><span class="p">):</span>
        
        <span class="n">shapefile_path</span> <span class="o">=</span> <span class="n">AOI</span>

    <span class="c1"># Read the shapefile using geopandas</span>
        <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">shapefile_path</span><span class="p">)</span>

    <span class="c1"># Convert to GeoJSON format</span>
        <span class="n">geojson_str</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span>
         <span class="c1"># Save the GeoJSON to a file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;output.geojson&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">geojson_file</span><span class="p">:</span>
            <span class="n">geojson_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">geojson_str</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;output.geojson&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;ISO-8859-1&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">geom</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">AOI</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">geom</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    
    <span class="n">base_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">AOI</span><span class="p">)</span>
    <span class="n">task_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">base_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1">#Shapefile AOI</span>

    <span class="c1">######</span>

    <span class="c1"># Define the filters we&#39;ll use to find our data</span>

    <span class="c1">#item_types = [ &quot;PSOrthoTile&quot;]</span>

    <span class="n">geom_filter</span> <span class="o">=</span> <span class="n">data_filter</span><span class="o">.</span><span class="n">geometry_filter</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
    <span class="n">clear_percent_filter</span> <span class="o">=</span> <span class="n">data_filter</span><span class="o">.</span><span class="n">range_filter</span><span class="p">(</span><span class="s1">&#39;clear_percent&#39;</span><span class="p">,</span> <span class="n">clear_percent</span><span class="p">)</span>
    <span class="n">date_string_start</span> <span class="o">=</span> <span class="n">start_date</span>  <span class="c1"># Example string representing a date in &quot;month, day, year&quot; format</span>
    <span class="n">format_string</span> <span class="o">=</span> <span class="s2">&quot;%B </span><span class="si">%d</span><span class="s2">, %Y&quot;</span>  <span class="c1"># Format of the input string</span>
    <span class="n">datetime_object_start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">date_string_start</span><span class="p">,</span> <span class="n">format_string</span><span class="p">)</span>

    
    <span class="k">if</span> <span class="n">end_date</span><span class="o">==</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">date_range_filter</span> <span class="o">=</span> <span class="n">data_filter</span><span class="o">.</span><span class="n">date_range_filter</span><span class="p">(</span><span class="s2">&quot;acquired&quot;</span><span class="p">,</span> <span class="n">gte</span><span class="o">=</span>  <span class="n">datetime_object_start</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">date_string_end</span> <span class="o">=</span> <span class="n">end_date</span>  <span class="c1"># Example string representing a date in &quot;month, day, year&quot; format</span>
        <span class="n">format_string</span> <span class="o">=</span> <span class="s2">&quot;%B </span><span class="si">%d</span><span class="s2">, %Y&quot;</span>  <span class="c1"># Format of the input string</span>
        <span class="n">datetime_object_end</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">date_string_end</span><span class="p">,</span> <span class="n">format_string</span><span class="p">)</span>

        <span class="n">date_range_filter</span> <span class="o">=</span> <span class="n">data_filter</span><span class="o">.</span><span class="n">date_range_filter</span><span class="p">(</span><span class="s2">&quot;acquired&quot;</span><span class="p">,</span>  <span class="n">gt</span><span class="o">=</span>  <span class="n">datetime_object_start</span><span class="p">,</span> <span class="n">lte</span><span class="o">=</span><span class="n">datetime_object_end</span><span class="p">)</span>

    <span class="c1">#Date Filter range</span>
    <span class="n">Date_Range_Filter2</span><span class="o">=</span><span class="p">{</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;DateRangeFilter&quot;</span><span class="p">,</span>
    <span class="s2">&quot;field_name&quot;</span><span class="p">:</span><span class="s2">&quot;acquired&quot;</span><span class="p">,</span>
    <span class="s2">&quot;config&quot;</span><span class="p">:{</span>
        <span class="s2">&quot;gt&quot;</span><span class="p">:</span><span class="s2">&quot;2019-12-31T00:00:00Z&quot;</span><span class="p">,</span>
        <span class="s2">&quot;lte&quot;</span><span class="p">:</span><span class="s2">&quot;2020-05-05T00:00:00Z&quot;</span>
    <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">cloud_cover_filter</span> <span class="o">=</span> <span class="n">data_filter</span><span class="o">.</span><span class="n">range_filter</span><span class="p">(</span><span class="s1">&#39;cloud_cover&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cloud_filter</span><span class="p">)</span>

    <span class="n">combined_filter</span> <span class="o">=</span> <span class="n">data_filter</span><span class="o">.</span><span class="n">and_filter</span><span class="p">([</span><span class="n">geom_filter</span><span class="p">,</span> <span class="n">clear_percent_filter</span><span class="p">,</span> <span class="n">date_range_filter</span><span class="p">,</span> <span class="n">cloud_cover_filter</span><span class="p">])</span>

    <span class="k">async</span> <span class="k">with</span> <span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
        <span class="n">cl</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>
        <span class="n">request</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cl</span><span class="o">.</span><span class="n">create_search</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;planet_client_demo&#39;</span><span class="p">,</span><span class="n">search_filter</span><span class="o">=</span><span class="n">combined_filter</span><span class="p">,</span> <span class="n">item_types</span><span class="o">=</span><span class="p">[</span><span class="n">item_type</span><span class="p">])</span>
        
    <span class="k">async</span> <span class="k">with</span> <span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
        <span class="n">cl</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>
        <span class="n">items</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">run_search</span><span class="p">(</span><span class="n">search_id</span><span class="o">=</span><span class="n">request</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>
        <span class="n">item_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">async</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">items</span><span class="p">]</span>
        
    <span class="c1">#####################################</span>
    
    <span class="n">item_ids</span><span class="o">=</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">item_list</span><span class="p">]</span>

    <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[1m Number of Items to Download: </span><span class="se">\033</span><span class="s2">[1m&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">item_ids</span><span class="p">),</span>  <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span><span class="s2">&quot; </span><span class="se">\033</span><span class="s2">[1m Set download_data=True to download the results...</span><span class="se">\033</span><span class="s2">[1m&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">item_list</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;item_type&#39;</span><span class="p">])</span>


    

    <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[1m Number of Items to Download: </span><span class="se">\033</span><span class="s2">[1m&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">item_ids</span><span class="p">),</span>  <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span><span class="s2">&quot; </span><span class="se">\033</span><span class="s2">[1m Strat Downloading...</span><span class="se">\033</span><span class="s2">[1m&quot;</span><span class="p">)</span>

    


    <span class="c1">#########################</span>

    <span class="c1">################</span>
    <span class="c1"># define the clip tool</span>
    <span class="n">clip</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;clip&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;aoi&quot;</span><span class="p">:</span> <span class="n">geom</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">single_product</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
        <span class="s2">&quot;item_ids&quot;</span><span class="p">:</span> <span class="n">item_ids</span><span class="p">,</span>
        <span class="s2">&quot;item_type&quot;</span><span class="p">:</span> <span class="s2">&quot;PSScene&quot;</span><span class="p">,</span>
        <span class="s2">&quot;product_bundle&quot;</span><span class="p">:</span> <span class="s2">&quot;analytic_sr_udm2&quot;</span>
        <span class="p">}</span>
    <span class="p">]</span>
    <span class="n">same_src_products</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
        <span class="s2">&quot;item_ids&quot;</span><span class="p">:</span><span class="n">item_ids</span><span class="p">,</span>
        <span class="s2">&quot;item_type&quot;</span><span class="p">:</span> <span class="n">item_type</span><span class="p">,</span>
        <span class="s2">&quot;product_bundle&quot;</span><span class="p">:</span> <span class="n">product_bundle</span>
        <span class="p">}</span>
    <span class="p">]</span>
    <span class="n">multi_src_products</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
        <span class="s2">&quot;item_ids&quot;</span><span class="p">:</span> <span class="n">item_ids</span><span class="p">,</span>
        <span class="s2">&quot;item_type&quot;</span><span class="p">:</span> <span class="s2">&quot;PSScene&quot;</span><span class="p">,</span>
        <span class="s2">&quot;product_bundle&quot;</span><span class="p">:</span> <span class="s2">&quot;analytic_udm2&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
        <span class="s2">&quot;item_ids&quot;</span><span class="p">:</span> <span class="n">item_ids</span><span class="p">,</span>
        <span class="s2">&quot;item_type&quot;</span><span class="p">:</span> <span class="s2">&quot;PSOrthoTile&quot;</span><span class="p">,</span>
        <span class="s2">&quot;product_bundle&quot;</span><span class="p">:</span> <span class="s2">&quot;analytic_sr_udm2&quot;</span>
        <span class="p">},</span>
        
    <span class="p">]</span>
    <span class="c1"># create an order request with the clipping tool</span>
    <span class="k">if</span> <span class="n">clip_flag</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
        <span class="n">request_clip</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;just clip&quot;</span><span class="p">,</span>
    <span class="s2">&quot;products&quot;</span><span class="p">:</span> <span class="n">same_src_products</span><span class="p">,</span>
    <span class="s2">&quot;delivery&quot;</span><span class="p">:</span> <span class="p">{</span>  
        <span class="s2">&quot;archive_type&quot;</span><span class="p">:</span> <span class="s2">&quot;zip&quot;</span><span class="p">,</span>
        <span class="s2">&quot;archive_filename&quot;</span><span class="p">:</span> <span class="s2">&quot;{{name}}_{{order_id}}.zip&quot;</span>
    <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">else</span><span class="p">:</span>
            
        <span class="n">request_clip</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">task_name</span><span class="p">,</span>
        <span class="s2">&quot;products&quot;</span><span class="p">:</span> <span class="n">same_src_products</span><span class="p">,</span>
        <span class="s2">&quot;tools&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">clip</span><span class="p">],</span> <span class="s2">&quot;delivery&quot;</span><span class="p">:</span> <span class="p">{</span>  
            <span class="s2">&quot;archive_type&quot;</span><span class="p">:</span> <span class="s2">&quot;zip&quot;</span><span class="p">,</span>
            <span class="s2">&quot;archive_filename&quot;</span><span class="p">:</span> <span class="s2">&quot;{{name}}_{{order_id}}.zip&quot;</span>
        <span class="p">}</span>
        <span class="p">}</span>

    <span class="n">output_folder</span><span class="o">=</span><span class="n">output_folder</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">task_name</span>
    <span class="kn">from</span> <span class="nn">planet</span> <span class="kn">import</span> <span class="n">Auth</span><span class="p">,</span> <span class="n">reporting</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">poll_and_download</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
            <span class="n">cl</span> <span class="o">=</span> <span class="n">OrdersClient</span><span class="p">(</span><span class="n">sess</span><span class="p">)</span>

            <span class="c1"># Use &quot;reporting&quot; to manage polling for order status</span>
            <span class="k">with</span> <span class="n">reporting</span><span class="o">.</span><span class="n">StateBar</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s1">&#39;creating&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">bar</span><span class="p">:</span>
                <span class="c1"># Grab the order ID</span>
                <span class="n">bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s1">&#39;created&#39;</span><span class="p">,</span> <span class="n">order_id</span><span class="o">=</span><span class="n">order</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>

                <span class="c1"># poll...poll...poll...</span>
                
                <span class="k">try</span><span class="p">:</span>

                    <span class="k">await</span> <span class="n">cl</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">order</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">callback</span><span class="o">=</span><span class="n">bar</span><span class="o">.</span><span class="n">update_state</span><span class="p">,</span> <span class="n">max_attempts</span><span class="o">=</span><span class="mi">2000</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">try</span><span class="p">:</span>

                <span class="c1"># if we get here that means the order completed. Yay! Download the files.</span>
                    <span class="n">filenames</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cl</span><span class="o">.</span><span class="n">download_order</span><span class="p">(</span> <span class="n">order_id</span><span class="o">=</span><span class="n">order</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">directory</span><span class="o">=</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="n">progress_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>

    <span class="k">async</span> <span class="k">with</span> <span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>

        <span class="n">max_attempts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">item_ids</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Check for bad items...&quot;</span><span class="p">)</span>
        <span class="n">errors_list</span><span class="o">=</span> <span class="p">[]</span>
        <span class="n">cl</span> <span class="o">=</span> <span class="n">OrdersClient</span><span class="p">(</span><span class="n">sess</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_attempts</span><span class="p">):</span>

            <span class="k">try</span><span class="p">:</span>
                
                <span class="c1"># Setup the session</span>
                <span class="c1"># session = requests.Session()</span>
                <span class="c1"># # # set content type to json</span>
                <span class="c1"># headers = {&#39;content-type&#39;: &#39;application/json&#39;}</span>
                <span class="c1"># orders_url = &#39;https://api.planet.com/compute/ops/orders/v2&#39;</span>
                <span class="c1"># response = requests.post(orders_url, data=json.dumps(request_clip), auth=session.auth, headers=headers)</span>
                <span class="c1"># print(response)</span>
                <span class="c1"># order = response.json()[&#39;id&#39;]</span>

                <span class="n">order</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cl</span><span class="o">.</span><span class="n">create_order</span><span class="p">(</span><span class="n">request_clip</span><span class="p">)</span>

                <span class="c1">#download =  await poll_and_download(order)</span>
            <span class="k">except</span> <span class="n">planet</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">APIError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="n">errors_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="c1"># Remove the items from the list that are present in the assets_in_errors list</span>
                

                <span class="c1">#print (&quot;new_list&quot;, len(errors_list_dict), print(errors_list_dict))</span>
            
                <span class="k">pass</span>
        
            <span class="c1"># Extract the assets from the error messages</span>
            
            <span class="nb">print</span><span class="p">(</span><span class="n">errors_list</span><span class="p">)</span>
            
            <span class="c1"># Convert the JSON string to a Python object</span>
            <span class="c1">#error_dicts = [json.loads(s) for s in errors_list]</span>

            
            <span class="c1"># Convert the JSON strings to Python dictionaries</span>
            <span class="n">dictionaries</span> <span class="o">=</span> <span class="p">[</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_string</span><span class="p">)</span> <span class="k">for</span> <span class="n">json_string</span> <span class="ow">in</span> <span class="n">errors_list</span><span class="p">]</span>

            <span class="c1"># Function to recursively extract all values from a dictionary</span>
            <span class="k">def</span> <span class="nf">extract_values</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">yield from</span> <span class="n">extract_values</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">yield from</span> <span class="n">extract_values</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">obj</span>

            <span class="c1"># Extract all values from the dictionaries</span>
            <span class="n">all_values</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">dictionary</span> <span class="ow">in</span> <span class="n">dictionaries</span><span class="p">:</span>
                <span class="n">all_values</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">extract_values</span><span class="p">(</span><span class="n">dictionary</span><span class="p">)))</span>

            <span class="c1"># Check if any keyword is in any of the values</span>
            <span class="n">bad_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">keyword</span> <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">item_ids</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">keyword</span> <span class="ow">in</span> <span class="n">value</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">all_values</span><span class="p">)]</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Matches found:&#39;</span><span class="p">,</span> <span class="n">bad_ids</span><span class="p">)</span>

                <span class="c1"># # Initialize an empty list to store the IDs</span>
                <span class="c1"># bad_ids = []</span>

                <span class="c1"># # Go through each error message in each dictionary</span>
                <span class="c1"># for error_dict in error_dicts:</span>
                <span class="c1">#     for detail in error_dict[&quot;field&quot;][&quot;Details&quot;]:</span>
                <span class="c1">#         message = detail[&quot;message&quot;]</span>
                <span class="c1">#         # Extract the ID from the message</span>
                <span class="c1">#         id = message.split(&#39;Bundle type/&#39;)[1].split(&#39;/&#39;)[0]</span>
                <span class="c1">#         # Add the ID to the list</span>
                <span class="c1">#         bad_ids.append(id)</span>
                

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;bad items has been removed from the item list to avoid api error: </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">bad_ids</span><span class="p">)</span>
            <span class="n">item_ids_updated</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">item_ids</span> <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bad_ids</span><span class="p">]</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Below is list of final items to be downloaded </span><span class="se">\n</span><span class="s2"> &quot;</span> <span class="s2">&quot;Number of Items: &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">item_ids_updated</span><span class="p">),</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>  <span class="n">item_ids_updated</span><span class="p">)</span>


            <span class="n">same_src_products</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
            <span class="s2">&quot;item_ids&quot;</span><span class="p">:</span><span class="n">item_ids_updated</span><span class="p">,</span>
            <span class="s2">&quot;item_type&quot;</span><span class="p">:</span> <span class="n">item_type</span><span class="p">,</span>
            <span class="s2">&quot;product_bundle&quot;</span><span class="p">:</span> <span class="n">product_bundle</span>
            <span class="p">}</span>
                <span class="p">]</span>

            
            <span class="k">if</span> <span class="n">clip_flag</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
                <span class="n">request_clip</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;just clip&quot;</span><span class="p">,</span>
            <span class="s2">&quot;products&quot;</span><span class="p">:</span> <span class="n">same_src_products</span><span class="p">,</span>
            <span class="s2">&quot;delivery&quot;</span><span class="p">:</span> <span class="p">{</span>  
                <span class="s2">&quot;archive_type&quot;</span><span class="p">:</span> <span class="s2">&quot;zip&quot;</span><span class="p">,</span>
                <span class="s2">&quot;archive_filename&quot;</span><span class="p">:</span> <span class="s2">&quot;{{name}}_{{order_id}}.zip&quot;</span>
            <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">else</span><span class="p">:</span>
                    
                <span class="n">request_clip</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">task_name</span><span class="p">,</span>
                <span class="s2">&quot;products&quot;</span><span class="p">:</span> <span class="n">same_src_products</span><span class="p">,</span>
                <span class="s2">&quot;tools&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">clip</span><span class="p">],</span> <span class="s2">&quot;delivery&quot;</span><span class="p">:</span> <span class="p">{</span>  
                    <span class="s2">&quot;archive_type&quot;</span><span class="p">:</span> <span class="s2">&quot;zip&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;archive_filename&quot;</span><span class="p">:</span> <span class="s2">&quot;{{name}}_{{order_id}}.zip&quot;</span>
                <span class="p">}</span>
                <span class="p">}</span>


                
        <span class="n">order</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cl</span><span class="o">.</span><span class="n">create_order</span><span class="p">(</span><span class="n">request_clip</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">download_data</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
            <span class="n">download</span> <span class="o">=</span>  <span class="k">await</span> <span class="n">poll_and_download</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
            
            
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloading Data is Completed :D&quot;</span><span class="p">)</span>
    <span class="c1">#task1=asyncio.current_task(await download_planet())</span>
       

        <span class="k">def</span> <span class="nf">search_and_move_zip_files</span><span class="p">(</span><span class="n">source_folder</span><span class="p">,</span> <span class="n">destination_folder</span><span class="p">):</span>
            <span class="c1"># Iterate through all files and directories within the source folder</span>
            <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">source_folder</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                    <span class="c1"># Check if the file is a zip file</span>
                    <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.zip&#39;</span><span class="p">):</span>
                        <span class="c1"># Get the full path of the zip file</span>
                        <span class="n">zip_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
                        
                        <span class="c1"># Move the zip file to the destination folder</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">zip_file_path</span><span class="p">,</span> <span class="n">destination_folder</span><span class="p">)</span>

    
        

        <span class="c1"># Specify the directory path</span>
        <span class="n">directory_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;zip_folders&quot;</span><span class="p">)</span>

        <span class="c1"># Create the directory</span>
        <span class="n">directory_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Specify the source folder to search for zip files</span>
        <span class="n">source_folder</span> <span class="o">=</span> <span class="n">output_folder</span>

        <span class="c1"># Specify the destination folder to move the zip files</span>
        <span class="n">destination_folder</span> <span class="o">=</span> <span class="n">directory_path</span>

        <span class="c1"># Call the function to search and move zip files</span>
        <span class="n">search_and_move_zip_files</span><span class="p">(</span><span class="n">source_folder</span><span class="p">,</span> <span class="n">destination_folder</span><span class="p">)</span></div>



<div class="viewcode-block" id="akhdefo_orthorectify">
<a class="viewcode-back" href="../../akhdefo_functions.html#akhdefo_functions.Akhdefo_utils.akhdefo_orthorectify">[docs]</a>
<span class="k">def</span> <span class="nf">akhdefo_orthorectify</span><span class="p">(</span><span class="n">input_Dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dem_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ortho_usingRpc</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">file_ex</span><span class="o">=</span><span class="s2">&quot;.tif&quot;</span><span class="p">):</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; </span>
<span class="sd">    Parameteres:</span>
<span class="sd">    ============</span>
<span class="sd">    input_Dir: str</span>
<span class="sd">        input unortho image directory path</span>
<span class="sd">    </span>
<span class="sd">    dem_path: str </span>
<span class="sd">        input path to DEM file</span>
<span class="sd">    </span>
<span class="sd">    output_path: str</span>
<span class="sd">        input path to output directory</span>
<span class="sd">    </span>
<span class="sd">    ortho_usingRpc: bool</span>
<span class="sd">        Use of RPC file for raw none-georectified satallite images</span>
<span class="sd">     </span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    

    <span class="c1"># Define the paths to your image, DEM, and output</span>
    <span class="c1">#input_Dir = glob.glob(input_Dir +&quot;/&quot;+ &quot;*.tif&quot;)</span>

    

    <span class="k">def</span> <span class="nf">get_file_paths</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
        <span class="n">file_paths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">file_ex</span><span class="p">):</span>
                    <span class="n">file_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">file</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">file_paths</span>

    <span class="c1"># replace &#39;your_directory_path&#39; with the path to the directory you want to iterate through</span>
    <span class="n">input_Dir</span> <span class="o">=</span> <span class="n">get_file_paths</span><span class="p">(</span><span class="n">input_Dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_Dir</span><span class="p">)):</span>
        <span class="n">image_path</span><span class="o">=</span><span class="n">input_Dir</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">image_path</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">n</span><span class="p">)</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">image_path</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
        
        <span class="n">output_path1</span> <span class="o">=</span> <span class="n">output_path</span> <span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="o">+</span> <span class="n">file_name</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>

        <span class="c1"># Open the DEM</span>
        <span class="n">dem_ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">dem_path</span><span class="p">)</span>

        <span class="c1"># Get the coordinate system of the DEM</span>
        <span class="n">dem_srs</span> <span class="o">=</span> <span class="n">osr</span><span class="o">.</span><span class="n">SpatialReference</span><span class="p">()</span>
        <span class="n">dem_srs</span><span class="o">.</span><span class="n">ImportFromWkt</span><span class="p">(</span><span class="n">dem_ds</span><span class="o">.</span><span class="n">GetProjectionRef</span><span class="p">())</span>

        <span class="c1"># Define the gdalwarp options</span>
        <span class="n">warp_options</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">WarpOptions</span><span class="p">(</span>
            <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;GTiff&#39;</span><span class="p">,</span>
            <span class="n">rpc</span><span class="o">=</span><span class="n">ortho_usingRpc</span><span class="p">,</span>
            <span class="n">outputType</span><span class="o">=</span><span class="n">gdal</span><span class="o">.</span><span class="n">GDT_UInt16</span><span class="p">,</span>
            <span class="n">multithread</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">creationOptions</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;COMPRESS=DEFLATE&#39;</span><span class="p">,</span> <span class="s1">&#39;TILED=YES&#39;</span><span class="p">],</span>
            <span class="n">dstSRS</span><span class="o">=</span><span class="n">dem_srs</span><span class="o">.</span><span class="n">ExportToProj4</span><span class="p">(),</span>
            <span class="n">srcNodata</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">dstNodata</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">resampleAlg</span><span class="o">=</span><span class="s1">&#39;cubic&#39;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Open the source image</span>
        <span class="n">src_ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">image_path</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>

        <span class="c1"># Perform the orthorectification</span>
        <span class="n">dst_ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Warp</span><span class="p">(</span><span class="n">output_path1</span><span class="p">,</span> <span class="n">src_ds</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">warp_options</span><span class="p">,</span> <span class="n">cutlineDSName</span><span class="o">=</span><span class="n">dem_path</span><span class="p">)</span>

    <span class="c1">#Clean up</span>
    <span class="n">src_ds</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">dem_ds</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">dst_ds</span> <span class="o">=</span> <span class="kc">None</span></div>




<span class="kn">import</span> <span class="nn">asf_search</span> <span class="k">as</span> <span class="nn">asf</span>
<span class="kn">import</span> <span class="nn">hyp3_sdk</span> <span class="k">as</span> <span class="nn">sdk</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<div class="viewcode-block" id="download_RTC">
<a class="viewcode-back" href="../../akhdefo_functions.html#akhdefo_functions.Akhdefo_utils.download_RTC">[docs]</a>
<span class="k">def</span> <span class="nf">download_RTC</span><span class="p">(</span><span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">prompt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">asf_datapool_results_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="n">job_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;rtc-test&#39;</span><span class="p">,</span> <span class="n">dem_matching</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">include_dem</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                 <span class="n">include_inc_map</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">include_rgb</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                 <span class="n">include_scattering_area</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">scale</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;amplitude&#39;</span><span class="p">,</span>
                 <span class="n">resolution</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">speckle_filter</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">radiometry</span><span class="o">=</span><span class="s1">&#39;gamma0&#39;</span><span class="p">,</span> <span class="n">dem_name</span><span class="o">=</span><span class="s1">&#39;copernicus&#39;</span><span class="p">,</span>
                   <span class="n">download</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span><span class="kc">None</span> <span class="p">,</span> <span class="n">path_number</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">frame_number</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">RTC</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">autorift</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span><span class="kc">False</span> <span class="p">,</span> <span class="n">insar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_neighbors</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initiates the download of Synthetic Aperture Radar (SAR) products from ASF&#39;s HyP3 platform.</span>

<span class="sd">    This function facilitates the submission and download of SAR processing jobs, including Radiometric Terrain </span>
<span class="sd">    Correction (RTC), AutoRIFT, and InSAR products. It filters and selects granules based on the provided ASF datapool </span>
<span class="sd">    results file and other specified parameters.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    username (str): </span>
<span class="sd">        ASF HyP3 username. Required unless prompt=True.</span>
<span class="sd">    </span>
<span class="sd">    password (str):</span>
<span class="sd">        ASF HyP3 password. Required unless prompt=True.</span>
<span class="sd">    </span>
<span class="sd">    prompt (bool):</span>
<span class="sd">        If True, use interactive prompts for login instead of username/password.</span>
<span class="sd">    </span>
<span class="sd">    asf_datapool_results_file (str): </span>
<span class="sd">        Path to ASF datapool results CSV file.</span>
<span class="sd">    </span>
<span class="sd">    save_dir (str):</span>
<span class="sd">        Directory where downloaded files will be saved.</span>
<span class="sd">    </span>
<span class="sd">    job_name (str, optional): </span>
<span class="sd">        Name for the job. Defaults to &#39;rtc-test&#39;.</span>
<span class="sd">    </span>
<span class="sd">    dem_matching (bool, optional):</span>
<span class="sd">        If True, perform DEM matching for RTC jobs. Defaults to True.</span>
<span class="sd">    </span>
<span class="sd">    include_dem (bool, optional):</span>
<span class="sd">        If True, include Digital Elevation Model in RTC jobs. Defaults to True.</span>
<span class="sd">    </span>
<span class="sd">    include_inc_map (bool, optional):</span>
<span class="sd">        If True, include incidence angle map in RTC jobs. Defaults to True.</span>
<span class="sd">    </span>
<span class="sd">    include_rgb (bool, optional):</span>
<span class="sd">        If True, include RGB decomposition in RTC jobs. Defaults to False.</span>
<span class="sd">    </span>
<span class="sd">    include_scattering_area (bool, optional): </span>
<span class="sd">        If True, include scattering area in RTC jobs. Defaults to False.</span>
<span class="sd">    </span>
<span class="sd">    scale (str, optional):</span>
<span class="sd">        Scale for the image in RTC jobs. Defaults to &#39;amplitude&#39;.</span>
<span class="sd">    </span>
<span class="sd">    resolution (int, optional): </span>
<span class="sd">        Desired resolution in meters for RTC jobs. Defaults to 10.</span>
<span class="sd">    </span>
<span class="sd">    speckle_filter (bool, optional):</span>
<span class="sd">        Apply Enhanced Lee speckle filter in RTC jobs. Defaults to True.</span>
<span class="sd">    </span>
<span class="sd">    radiometry (str): </span>
<span class="sd">        Radiometry normalization (either &#39;sigma0&#39; or &#39;gamma0&#39;) for RTC jobs.</span>
<span class="sd">    </span>
<span class="sd">    dem_name (str): </span>
<span class="sd">        DEM to use for RTC jobs. &#39;copernicus&#39; or &#39;legacy&#39;.</span>
<span class="sd">    </span>
<span class="sd">    download (bool): </span>
<span class="sd">        If True, submit jobs and download data. Defaults to False.</span>
<span class="sd">    </span>
<span class="sd">    limit (int, optional): </span>
<span class="sd">        Limit the number of images to download.</span>
<span class="sd">    </span>
<span class="sd">    path_number (int, optional):</span>
<span class="sd">        Filter granules by path number.</span>
<span class="sd">    </span>
<span class="sd">    frame_number (int, optional): </span>
<span class="sd">        Filter granules by frame number.</span>
<span class="sd">    </span>
<span class="sd">    RTC (bool): </span>
<span class="sd">        If True, process RTC jobs.</span>
<span class="sd">    </span>
<span class="sd">    autorift (bool): </span>
<span class="sd">        If True, process AutoRIFT jobs.</span>
<span class="sd">    </span>
<span class="sd">    insar (bool):</span>
<span class="sd">        If True, process InSAR jobs.</span>
<span class="sd">    </span>
<span class="sd">    max_neighbors (int):</span>
<span class="sd">        Max number of neighbors for InSAR job pairing.</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">        sdk.Batch: A Batch object containing the submitted jobs.</span>

<span class="sd">    Raises:</span>
<span class="sd">    -------</span>
<span class="sd">        ValueError: If required arguments are not provided.</span>
<span class="sd">    </span>
<span class="sd">    Notes:</span>
<span class="sd">    -------</span>
<span class="sd">        - This function requires prior installation of the HyP3 SDK and relevant dependencies.</span>
<span class="sd">        - The ASF datapool results file should be in CSV format with specific columns for filtering.</span>
<span class="sd">        - Downloaded files will be saved in the specified directory with additional suffixes based on the job type.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">prompt</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">asf_datapool_results_file</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">save_dir</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;asf_datapool_results_file, and save_dir are required.&quot;</span><span class="p">)</span>

        <span class="n">hyp3</span> <span class="o">=</span> <span class="n">sdk</span><span class="o">.</span><span class="n">HyP3</span><span class="p">(</span><span class="n">prompt</span><span class="o">=</span><span class="n">prompt</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
            
        <span class="c1"># Check if required parameters are provided</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">username</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">password</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">asf_datapool_results_file</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">save_dir</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Username, password, asf_datapool_results_file, and save_dir are required.&quot;</span><span class="p">)</span>

        <span class="c1"># Establish connection</span>
        <span class="n">hyp3</span> <span class="o">=</span> <span class="n">sdk</span><span class="o">.</span><span class="n">HyP3</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>

    <span class="c1"># Read ASF datapool results file</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">asf_datapool_results_file</span><span class="p">)</span>
    <span class="n">col_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Path Number&#39;</span><span class="p">,</span> <span class="s2">&quot;Frame Number&quot;</span><span class="p">]</span>
    <span class="n">unique_values</span> <span class="o">=</span> <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">col_list</span><span class="p">}</span>
    <span class="nb">print</span> <span class="p">(</span><span class="n">unique_values</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">path_number</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Path Number&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">path_number</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">frame_number</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Frame Number&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">frame_number</span><span class="p">]</span>
          
    <span class="n">granule_names</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Granule Name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    
    
    <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">granule_names</span><span class="o">=</span><span class="n">granule_names</span><span class="p">[:</span><span class="n">limit</span><span class="p">]</span>
        
    

    <span class="c1"># Select first two granules</span>
    <span class="n">granules_to_download</span> <span class="o">=</span> <span class="n">granule_names</span>
    

    
    <span class="c1">######</span>
    <span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
    <span class="kn">from</span> <span class="nn">tqdm.auto</span> <span class="kn">import</span> <span class="n">tqdm</span>
    <span class="k">def</span> <span class="nf">get_nearest_neighbors</span><span class="p">(</span><span class="n">granule</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_neighbors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">asf</span><span class="o">.</span><span class="n">ASFSearchResults</span><span class="p">:</span>
        <span class="n">granule</span> <span class="o">=</span> <span class="n">asf</span><span class="o">.</span><span class="n">granule_search</span><span class="p">(</span><span class="n">granule</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="nb">reversed</span><span class="p">([</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">granule</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span> <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;temporalBaseline&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">asf</span><span class="o">.</span><span class="n">ASFSearchResults</span><span class="p">(</span><span class="n">stack</span><span class="p">)[:</span><span class="n">max_neighbors</span><span class="p">]</span>
    
    <span class="c1">#######</span>
    
    <span class="k">if</span> <span class="n">download</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloading granules: </span><span class="si">{</span><span class="n">granules_to_download</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Submit jobs for each granule</span>
        <span class="k">if</span> <span class="n">RTC</span><span class="p">:</span>
            
            <span class="c1"># Initialize job batch</span>
            <span class="n">rtc_jobs</span> <span class="o">=</span> <span class="n">sdk</span><span class="o">.</span><span class="n">Batch</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">granule</span> <span class="ow">in</span> <span class="n">granules_to_download</span><span class="p">:</span>
                <span class="n">rtc_jobs</span> <span class="o">+=</span> <span class="n">hyp3</span><span class="o">.</span><span class="n">submit_rtc_job</span><span class="p">(</span><span class="n">granule</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">job_name</span><span class="p">,</span> <span class="n">dem_matching</span><span class="o">=</span><span class="n">dem_matching</span><span class="p">,</span> 
                                                <span class="n">include_dem</span><span class="o">=</span><span class="n">include_dem</span><span class="p">,</span> <span class="n">include_inc_map</span><span class="o">=</span><span class="n">include_inc_map</span><span class="p">,</span>
                                                <span class="n">include_rgb</span><span class="o">=</span><span class="n">include_rgb</span><span class="p">,</span> 
                                                <span class="n">include_scattering_area</span><span class="o">=</span><span class="n">include_scattering_area</span><span class="p">,</span>
                                                <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span> 
                                                <span class="n">speckle_filter</span><span class="o">=</span><span class="n">speckle_filter</span><span class="p">,</span> <span class="n">radiometry</span><span class="o">=</span><span class="n">radiometry</span><span class="p">,</span> <span class="n">dem_name</span><span class="o">=</span><span class="n">dem_name</span><span class="p">)</span>
        
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Submitted jobs: </span><span class="si">{</span><span class="n">rtc_jobs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Monitor job progress and wait until completion</span>
            <span class="n">rtc_jobs</span> <span class="o">=</span> <span class="n">hyp3</span><span class="o">.</span><span class="n">watch</span><span class="p">(</span><span class="n">rtc_jobs</span><span class="p">)</span>

            <span class="c1"># Download completed jobs to the specified location</span>
            <span class="n">rtc_jobs</span><span class="o">.</span><span class="n">download_files</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">save_dir</span><span class="o">+</span><span class="s2">&quot;_rtc&quot;</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">autorift</span><span class="p">:</span>
            <span class="n">autorift_jobs</span> <span class="o">=</span> <span class="n">sdk</span><span class="o">.</span><span class="n">Batch</span><span class="p">()</span>
            <span class="k">def</span> <span class="nf">create_pairs</span><span class="p">(</span><span class="n">lst</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">[(</span><span class="n">lst</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lst</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
            
            <span class="n">autorift_pairs</span> <span class="o">=</span> <span class="n">create_pairs</span><span class="p">(</span><span class="n">granules_to_download</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">reference</span><span class="p">,</span> <span class="n">secondary</span> <span class="ow">in</span> <span class="n">autorift_pairs</span><span class="p">:</span>
                <span class="n">autorift_jobs</span> <span class="o">+=</span> <span class="n">hyp3</span><span class="o">.</span><span class="n">submit_autorift_job</span><span class="p">(</span><span class="n">reference</span><span class="p">,</span> <span class="n">secondary</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">job_name</span><span class="o">+</span><span class="s2">&quot;_autorift&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">autorift_jobs</span><span class="p">)</span>
                <span class="c1"># Monitor job progress and wait until completion</span>
            <span class="n">autorift_jobs</span> <span class="o">=</span> <span class="n">hyp3</span><span class="o">.</span><span class="n">watch</span><span class="p">(</span><span class="n">autorift_jobs</span><span class="p">)</span>

            <span class="c1"># Download completed jobs to the specified location</span>
            <span class="n">autorift_jobs</span><span class="o">.</span><span class="n">download_files</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">save_dir</span><span class="o">+</span><span class="s2">&quot;_autorift&quot;</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                
        <span class="k">if</span> <span class="n">insar</span><span class="p">:</span>
            <span class="n">insar_jobs</span> <span class="o">=</span> <span class="n">sdk</span><span class="o">.</span><span class="n">Batch</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">reference</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">granules_to_download</span><span class="p">):</span>
                <span class="n">neighbors</span> <span class="o">=</span> <span class="n">get_nearest_neighbors</span><span class="p">(</span><span class="n">reference</span><span class="p">,</span> <span class="n">max_neighbors</span><span class="o">=</span><span class="n">max_neighbors</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">secondary</span> <span class="ow">in</span> <span class="n">neighbors</span><span class="p">:</span>
                    <span class="n">insar_jobs</span> <span class="o">+=</span> <span class="n">hyp3</span><span class="o">.</span><span class="n">submit_insar_job</span><span class="p">(</span><span class="n">reference</span><span class="p">,</span> <span class="n">secondary</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;sceneName&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;insar-example&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">insar_jobs</span><span class="p">)</span>
            <span class="n">insar_jobs</span> <span class="o">=</span> <span class="n">hyp3</span><span class="o">.</span><span class="n">watch</span><span class="p">(</span><span class="n">insar_jobs</span><span class="p">)</span>

            <span class="c1"># Download completed jobs to the specified location</span>
            <span class="n">insar_jobs</span><span class="o">.</span><span class="n">download_files</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">save_dir</span><span class="o">+</span><span class="s2">&quot;_insar&quot;</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        

        <span class="c1"># # Monitor job progress and wait until completion</span>
        <span class="c1"># rtc_jobs = hyp3.watch(rtc_jobs)</span>

        <span class="c1"># # Download completed jobs to the specified location</span>
        <span class="c1"># rtc_jobs.download_files(location=save_dir, create=True)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;set value download= </span><span class="si">{</span><span class="n">download</span><span class="si">}</span><span class="s2"> to True to submit the jobs and download RTC data&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;List of granules: </span><span class="si">{</span><span class="n">granules_to_download</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

    
    
   


<span class="kn">import</span> <span class="nn">rasterio</span>
<span class="kn">from</span> <span class="nn">rasterio.warp</span> <span class="kn">import</span> <span class="n">calculate_default_transform</span><span class="p">,</span> <span class="n">reproject</span><span class="p">,</span> <span class="n">Resampling</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">from</span> <span class="nn">rasterio.mask</span> <span class="kn">import</span> <span class="n">mask</span>
<span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">exposure</span>

<div class="viewcode-block" id="reproject_raster_to_match_shapefile">
<a class="viewcode-back" href="../../akhdefo_functions.html#akhdefo_functions.Akhdefo_utils.reproject_raster_to_match_shapefile">[docs]</a>
<span class="k">def</span> <span class="nf">reproject_raster_to_match_shapefile</span><span class="p">(</span><span class="n">src_path</span><span class="p">,</span> <span class="n">dst_path</span><span class="p">,</span> <span class="n">dst_crs</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reproject a raster to match the coordinate reference system (CRS) of a shapefile.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    ------------</span>
<span class="sd">    - src_path (str): Path to the source raster file that needs to be reprojected.</span>
<span class="sd">    - dst_path (str): Path to save the reprojected raster.</span>
<span class="sd">    - dst_crs (CRS or str): Target coordinate reference system.</span>

<span class="sd">    Returns:</span>
<span class="sd">    ---------</span>
<span class="sd">    None. The reprojected raster is written to dst_path.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">src_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">transform</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">calculate_default_transform</span><span class="p">(</span>
            <span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="n">dst_crs</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="o">*</span><span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s1">&#39;crs&#39;</span><span class="p">:</span> <span class="n">dst_crs</span><span class="p">,</span>
            <span class="s1">&#39;transform&#39;</span><span class="p">:</span> <span class="n">transform</span><span class="p">,</span>
            <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="n">width</span><span class="p">,</span>
            <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">height</span>
        <span class="p">})</span>

        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dst_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">reproject</span><span class="p">(</span>
                    <span class="n">source</span><span class="o">=</span><span class="n">rasterio</span><span class="o">.</span><span class="n">band</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span>
                    <span class="n">destination</span><span class="o">=</span><span class="n">rasterio</span><span class="o">.</span><span class="n">band</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span>
                    <span class="n">src_transform</span><span class="o">=</span><span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span>
                    <span class="n">src_crs</span><span class="o">=</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
                    <span class="n">dst_transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span>
                    <span class="n">dst_crs</span><span class="o">=</span><span class="n">dst_crs</span><span class="p">,</span>
                    <span class="n">resampling</span><span class="o">=</span><span class="n">Resampling</span><span class="o">.</span><span class="n">nearest</span><span class="p">)</span></div>


<div class="viewcode-block" id="create_vegetation_mask">
<a class="viewcode-back" href="../../akhdefo_functions.html#akhdefo_functions.Akhdefo_utils.create_vegetation_mask">[docs]</a>
<span class="k">def</span> <span class="nf">create_vegetation_mask</span><span class="p">(</span><span class="n">red_band_path</span><span class="p">,</span> <span class="n">nir_band_path</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">shapefile_path</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">save_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot_path</span><span class="o">=</span><span class="s2">&quot;plot.png&quot;</span><span class="p">):</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a binary vegetation mask based on the NDVI (Normalized Difference Vegetation Index) calculation.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    ------------</span>
<span class="sd">    red_band_path (str): </span>
<span class="sd">        Path to the raster file containing the red band.</span>
<span class="sd">    </span>
<span class="sd">    nir_band_path (str): </span>
<span class="sd">        Path to the raster file containing the near-infrared (NIR) band.</span>
<span class="sd">    </span>
<span class="sd">    output_path (str): </span>
<span class="sd">        Path to save the generated vegetation mask raster.</span>
<span class="sd">    </span>
<span class="sd">    shapefile_path (str): </span>
<span class="sd">        Path to the shapefile that defines the area of interest (AOI).</span>
<span class="sd">    </span>
<span class="sd">    threshold (float, optional):</span>
<span class="sd">        NDVI threshold for determining vegetation. Pixels with NDVI less than this threshold are considered vegetation. Default is 0.3.</span>
<span class="sd">    </span>
<span class="sd">    save_plot (bool, optional):</span>
<span class="sd">        Whether to save a plot of the vegetation mask. Default is False.</span>
<span class="sd">    </span>
<span class="sd">    plot_path (str, optional): </span>
<span class="sd">        Path to save the plot if save_plot is True. Default is &quot;plot.png&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">    ----------</span>
<span class="sd">    None. The vegetation mask is written to output_path, and optionally a plot is saved.</span>

<span class="sd">    Note:</span>
<span class="sd">    The function assumes that the shapefile contains only one geometry.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Read the AOI from the shapefile</span>
    <span class="n">aoi_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">shapefile_path</span><span class="p">)</span>
    <span class="n">geometry</span> <span class="o">=</span> <span class="n">aoi_gdf</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Assuming only one geometry in the shapefile</span>

    <span class="n">target_crs</span> <span class="o">=</span> <span class="n">aoi_gdf</span><span class="o">.</span><span class="n">crs</span>

    <span class="c1"># Reproject the rasters to match the CRS of the shapefile</span>
    <span class="n">reprojected_red_band_path</span> <span class="o">=</span> <span class="s2">&quot;reprojected_red.tif&quot;</span>
    <span class="n">reprojected_nir_band_path</span> <span class="o">=</span> <span class="s2">&quot;reprojected_nir.tif&quot;</span>

    <span class="n">reproject_raster_to_match_shapefile</span><span class="p">(</span><span class="n">red_band_path</span><span class="p">,</span> <span class="n">reprojected_red_band_path</span><span class="p">,</span> <span class="n">target_crs</span><span class="p">)</span>
    <span class="n">reproject_raster_to_match_shapefile</span><span class="p">(</span><span class="n">nir_band_path</span><span class="p">,</span> <span class="n">reprojected_nir_band_path</span><span class="p">,</span> <span class="n">target_crs</span><span class="p">)</span>

    <span class="c1"># Open and crop the reprojected red band using the AOI</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">reprojected_red_band_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">red_src</span><span class="p">:</span>
        <span class="n">red_crop</span><span class="p">,</span> <span class="n">red_transform</span> <span class="o">=</span> <span class="n">mask</span><span class="p">(</span><span class="n">red_src</span><span class="p">,</span> <span class="p">[</span><span class="n">geometry</span><span class="p">],</span> <span class="n">crop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Open and crop the reprojected near-infrared band using the AOI</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">reprojected_nir_band_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">nir_src</span><span class="p">:</span>
        <span class="n">nir_crop</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">mask</span><span class="p">(</span><span class="n">nir_src</span><span class="p">,</span> <span class="p">[</span><span class="n">geometry</span><span class="p">],</span> <span class="n">crop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Calculate NDVI</span>
    <span class="c1"># Using a small value (1e-8) in the denominator to prevent division by zero</span>
    <span class="n">ndvi</span> <span class="o">=</span> <span class="p">(</span><span class="n">nir_crop</span> <span class="o">-</span> <span class="n">red_crop</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">nir_crop</span> <span class="o">+</span> <span class="n">red_crop</span> <span class="p">)</span>

   <span class="c1"># Use the rescale_intensity function from skimage&#39;s exposure module</span>
    <span class="c1">#ndvi = exposure.rescale_intensity(ndvi, out_range=(-1, 1))</span>


    <span class="c1"># Create a binary vegetation mask</span>
    <span class="n">vegetation_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">ndvi</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">)</span>
    
    

    <span class="c1"># Prepare metadata for the output raster</span>
    <span class="n">meta</span> <span class="o">=</span> <span class="n">red_src</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
        <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">red_crop</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">red_crop</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
        <span class="s2">&quot;transform&quot;</span><span class="p">:</span> <span class="n">red_transform</span>
    <span class="p">})</span>

    <span class="c1"># Save the vegetation mask raster</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">meta</span><span class="p">)</span> <span class="k">as</span> <span class="n">dest</span><span class="p">:</span>
        <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">vegetation_mask</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">save_plot</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">vegetation_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_path</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Vegetation mask created and saved to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

    
    
    
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">skimage.metrics</span> <span class="kn">import</span> <span class="n">structural_similarity</span> <span class="k">as</span> <span class="n">ssim</span>
<span class="c1"># import required libraries</span>
<span class="c1"># from vidgear.gears import CamGear</span>
<span class="c1"># from vidgear.gears import StreamGear</span>
<span class="kn">import</span> <span class="nn">queue</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="c1"># Function to measure displacement using Dense Optical Flow</span>
<div class="viewcode-block" id="measure_displacement_from_camera">
<a class="viewcode-back" href="../../akhdefo_functions.html#akhdefo_functions.Akhdefo_utils.measure_displacement_from_camera">[docs]</a>
<span class="k">def</span> <span class="nf">measure_displacement_from_camera</span><span class="p">(</span><span class="n">hls_url</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">save_output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">output_filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ssim_threshold</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> 
                                     <span class="n">pyr_scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">winsize</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span><span class="n">iterations</span><span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">poly_n</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">poly_sigma</span><span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="mi">1</span> <span class="p">,</span> <span class="n">show_video</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">streamer_option</span><span class="o">=</span><span class="s1">&#39;mag&#39;</span><span class="p">):</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Test data URLs; hls_url = &quot;https://chiefcam.com/resources/video/events/september-2021-rockfall/september-2021-rockfall-1080p.mp4&quot; or &quot;https://chiefcam.com/video/hls/live/1080p/index.m3u8&quot;</span>
<span class="sd">    </span>
<span class="sd">    Measure the displacement from the camera feed using Dense Optical Flow.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    ------------</span>
<span class="sd">    </span>
<span class="sd">    hls_url: str</span>
<span class="sd">        The URL of the HLS video stream. or type 0 to process video from live pc webcam or add path to your video</span>
<span class="sd">    </span>
<span class="sd">    alpha: float, optional</span>
<span class="sd">        The weight of the image to update the background model, default is 0.1.</span>
<span class="sd">        </span>
<span class="sd">    save_output : bool, optional</span>
<span class="sd">        Flag to save the output, default is False.</span>
<span class="sd">    output_filename : str, optional</span>
<span class="sd">        The filename for saving the output video, required if save_output is True.</span>
<span class="sd">    ssim_threshold: float , default 0.4</span>
<span class="sd">        if interetesed to identify rockfalls recommended value is 0.5 or less.</span>
<span class="sd">        </span>
<span class="sd">    pyr_scale: float</span>
<span class="sd">        parameter, specifying the image scale (&lt;1) to build pyramids for each image; pyr_scale=0.5 means a classical pyramid, where each next layer is twice smaller than the previous one.</span>
<span class="sd">    levels: int</span>
<span class="sd">        number of pyramid layers including the initial image; levels=1 means that no extra layers are created and only the original images are used.</span>
<span class="sd">    winsize: int</span>
<span class="sd">        averaging window size; larger values increase the algorithm robustness to image noise and give more chances for fast motion detection, but yield more blurred motion field.</span>
<span class="sd">    iterations: int</span>
<span class="sd">        number of iterations the algorithm does at each pyramid level.</span>
<span class="sd">    poly_n: int</span>
<span class="sd">        size of the pixel neighborhood used to find polynomial expansion in each pixel; </span>
<span class="sd">        larger values mean that the image will be approximated with smoother surfaces, </span>
<span class="sd">        yielding more robust algorithm and more blurred motion field, typically poly_n =5 or 7.</span>
<span class="sd">    poly_sigma: float</span>
<span class="sd">        standard deviation of the Gaussian that is used to smooth derivatives used as a basis for the polynomial expansion; </span>
<span class="sd">        for poly_n=5, you can set poly_sigma=1.1, for poly_n=7, a good value would be poly_sigma=1.5.</span>
<span class="sd">    flags: 0 or 1</span>
<span class="sd">        operation flags that can be a combination of the following:</span>
<span class="sd">        0 OPTFLOW_USE_INITIAL_FLOW uses the input flow as an initial flow approximation.</span>
<span class="sd">        1 OPTFLOW_FARNEBACK_GAUSSIAN uses the Gaussian winsize×winsize filter instead of a box filter of the same size for optical flow estimation; </span>
<span class="sd">        usually, this option gives z more accurate flow than with a box filter, at the cost of lower speed; </span>
<span class="sd">        normally, winsize for a Gaussian window should be set to a larger value to achieve the same level of robustness.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------- </span>
<span class="sd">        Video output with motion vectors and magnitude.</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">import</span> <span class="nn">datetime</span>
    <span class="kn">import</span> <span class="nn">warnings</span>

        <span class="c1"># Suppress the Matplotlib GUI warning</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Starting a Matplotlib GUI outside of the main thread will likely fail&quot;</span><span class="p">)</span>


    <span class="n">cap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="n">hls_url</span><span class="p">)</span>
    <span class="c1"># open any valid video stream(from web-camera attached at index `0`)</span>
    <span class="c1"># stream1= CamGear(source=hls_url).start()</span>
    <span class="c1"># stream2= CamGear(source=hls_url).start()</span>
    <span class="c1"># frame_rate = int(cap.get(5))</span>
   
    <span class="c1"># # enable livestreaming and retrieve framerate from CamGear Stream and</span>
    <span class="c1"># # pass it as `-input_framerate` parameter for controlled framerate #stream1.framerate</span>
    <span class="c1"># stream_params1 = {&quot;-input_framerate&quot;: frame_rate , &quot;-livestream&quot;: True}</span>
    <span class="c1"># stream_params2 = {&quot;-input_framerate&quot;: frame_rate, &quot;-livestream&quot;: True}</span>

    <span class="c1"># # describe a suitable manifest-file location/name</span>
    <span class="c1"># streamer1 = StreamGear(output= output_filename[:-4] +&quot;.m3u8&quot;, format = &quot;hls&quot;, **stream_params1)</span>
    <span class="c1"># streamer_mag = StreamGear(output=output_filename[:-4] +&quot;_mag.m3u8&quot;, format = &quot;hls&quot;, **stream_params2)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cap</span><span class="o">.</span><span class="n">isOpened</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: Couldn&#39;t open camera.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    
    <span class="k">global</span> <span class="n">frame_width</span><span class="p">,</span> <span class="n">frame_height</span>
    
    <span class="n">frame_width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">frame_height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
    
    <span class="c1"># Check if saving output is enabled</span>
    <span class="k">if</span> <span class="n">save_output</span><span class="p">:</span>
        <span class="c1"># Get the frames&#39; width, height, and frame rate</span>
        <span class="n">frame_width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
        <span class="n">frame_height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
        <span class="n">frame_rate</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
        
        <span class="c1"># Define the codec and create a VideoWriter object</span>
        <span class="n">fourcc</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoWriter_fourcc</span><span class="p">(</span><span class="o">*</span><span class="s1">&#39;XVID&#39;</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoWriter</span><span class="p">(</span><span class="n">output_filename</span><span class="p">,</span> <span class="n">fourcc</span><span class="p">,</span> <span class="n">frame_rate</span><span class="p">,</span> <span class="p">(</span><span class="n">frame_width</span> <span class="o">+</span> <span class="n">frame_width</span><span class="o">//</span><span class="mi">10</span><span class="p">,</span> <span class="n">frame_height</span><span class="p">))</span>
        <span class="n">out1</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoWriter</span><span class="p">(</span><span class="n">output_filename</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;_1.avi&quot;</span><span class="p">,</span> <span class="n">fourcc</span><span class="p">,</span> <span class="n">frame_rate</span><span class="p">,</span> <span class="p">(</span><span class="n">frame_width</span> <span class="o">+</span><span class="n">frame_width</span><span class="o">//</span><span class="mi">10</span><span class="p">,</span> <span class="n">frame_height</span><span class="p">))</span>
    
    <span class="n">ret</span><span class="p">,</span> <span class="n">prev_frame</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="c1"># Set the new dimensions for resizing</span>
    <span class="n">new_width</span> <span class="o">=</span> <span class="mi">640</span>
    <span class="n">new_height</span> <span class="o">=</span> <span class="mi">480</span>
    <span class="c1"># Resize the frame to the new dimensions</span>
    <span class="c1">#prev_frame = cv2.resize(prev_frame, (new_width, new_height))</span>
    <span class="n">prev_frame</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">prev_frame</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
    
    <span class="n">total_displacement</span> <span class="o">=</span> <span class="mf">0.0</span>
    
    <span class="c1"># Initialize the background model as the first frame</span>
    <span class="n">background_model</span> <span class="o">=</span> <span class="n">prev_frame</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    
    <span class="c1"># x_displacement = []</span>
    <span class="c1"># y_displacement = []</span>
    
    <span class="n">frame_count</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="n">prev_displacement</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># Initialize lists to store frame datetimes and displacements</span>
    <span class="n">frame_datetimes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">min_displacements</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">max_displacements</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">mean_displacement</span><span class="o">=</span><span class="p">[]</span>

    
    
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">ret</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="c1"># Resize the frame to the new dimensions</span>
        <span class="c1">#frame = cv2.resize(frame, (new_width, new_height))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ret</span><span class="p">:</span>
            <span class="k">break</span>
        
        <span class="n">frame_gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
        
        <span class="n">similarity_index</span><span class="p">,</span> <span class="n">ssim_map</span> <span class="o">=</span> <span class="n">ssim</span><span class="p">(</span><span class="n">prev_frame</span><span class="p">,</span> <span class="n">frame_gray</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="c1"># Calculate dense optical flow</span>
        <span class="n">flow</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">calcOpticalFlowFarneback</span><span class="p">(</span><span class="n">prev_frame</span><span class="p">,</span> <span class="n">frame_gray</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">pyr_scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">winsize</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span><span class="n">iterations</span><span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">poly_n</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">poly_sigma</span><span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># Calculate displacement magnitude</span>
        <span class="c1">#displacement = np.sqrt(flow[..., 0]**2 + flow[..., 1]**2)</span>
        
        <span class="c1"># Adjust ksize and sigmaX based on the level of noise in your image</span>
        <span class="c1">#displacement = cv2.GaussianBlur(displacement, (5, 5), 0)</span>
        
        
        
        <span class="c1">##########</span>
        
       
        
        <span class="n">prev_frame</span> <span class="o">=</span> <span class="n">frame_gray</span>
        
        <span class="n">frame_count</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c1"># Create an HSV image for visualizing the flow</span>
        <span class="n">hsv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="n">hsv</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span>
        
        <span class="c1"># Calculate angle and magnitude for flow visualization</span>
        <span class="c1">#angle = np.arctan2(flow[..., 1], flow[..., 0])</span>
        <span class="c1">#magnitude = cv2.normalize(displacement, None, 0, 255, cv2.NORM_MINMAX)</span>
        <span class="c1">#magnitude=displacement</span>
        
        <span class="c1">#magnitude, angle = cv2.cartToPolar(cv2.medianBlur(flow[..., 0], 3), cv2.medianBlur(flow[..., 1], 3))</span>
        <span class="n">magnitude</span><span class="p">,</span> <span class="n">angle</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cartToPolar</span><span class="p">(</span><span class="n">flow</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">flow</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        
        <span class="c1"># Calculate x and y displacement components</span>
        <span class="c1"># x_disp = np.max(flow[..., 0])</span>
        <span class="c1"># y_disp = np.max(flow[..., 1])</span>
        
        <span class="c1"># x_disp_min = np.min(flow[..., 0])</span>
        <span class="c1"># y_disp_min = np.min(flow[..., 1])</span>
        
        
        <span class="c1"># Get the current datetime</span>
        <span class="n">current_datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="c1"># Define the size and coordinates of the window in the middle of the frame</span>
        <span class="n">window_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>  <span class="c1"># Adjust the size as needed</span>
        <span class="n">frame_height</span><span class="p">,</span> <span class="n">frame_width</span> <span class="o">=</span> <span class="n">magnitude</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">window_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">frame_width</span> <span class="o">-</span> <span class="n">window_size</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">//</span> <span class="mi">3</span>
        <span class="n">window_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">frame_height</span> <span class="o">-</span> <span class="n">window_size</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">//</span> <span class="mi">3</span>

        <span class="c1"># Extract the window from the image</span>
        <span class="n">window</span> <span class="o">=</span> <span class="n">magnitude</span><span class="p">[</span><span class="n">window_y</span><span class="p">:</span><span class="n">window_y</span><span class="o">+</span><span class="n">window_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">window_x</span><span class="p">:</span><span class="n">window_x</span><span class="o">+</span><span class="n">window_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        
        <span class="c1"># Calculate the mean pixel value of the window</span>
        <span class="n">mean_pixel_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>
        <span class="n">disp_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>
        <span class="n">disp_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>
        <span class="c1"># Append the datetime and displacements to the respective lists</span>
        <span class="n">frame_datetimes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_datetime</span><span class="p">)</span>
        <span class="n">min_displacements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">disp_min</span><span class="p">)</span>
        <span class="n">max_displacements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">disp_max</span><span class="p">)</span>
        <span class="n">mean_displacement</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_pixel_value</span><span class="p">)</span>

    
        <span class="c1"># Sum up the displacement in the entire frame</span>
        <span class="n">total_displacement</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">magnitude</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ssim_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
           
            <span class="n">magnitude</span><span class="p">[</span><span class="n">ssim_map</span> <span class="o">&gt;</span> <span class="n">ssim_threshold</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
            <span class="n">angle</span><span class="p">[</span><span class="n">ssim_map</span> <span class="o">&gt;</span> <span class="n">ssim_threshold</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
            <span class="c1"># else:</span>
                
            <span class="c1">#     magnitude[ssim_map &lt; ssim_threshold]=0</span>
            <span class="c1">#     angle[ssim_map &lt; ssim_threshold]=0</span>
        
        <span class="c1"># disp_min=np.min(magnitude)</span>
        <span class="c1"># disp_max=np.max(magnitude)</span>
        <span class="c1"># Set hue according to the direction of motion</span>
        <span class="n">hsv</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">angle</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        
        <span class="c1"># Set value (brightness) according to the magnitude of motion</span>
        <span class="n">hsv</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">magnitude</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">NORM_MINMAX</span><span class="p">)</span>
        
        <span class="c1"># Convert HSV to BGR for display</span>
        <span class="n">flow_vis</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">hsv</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_HSV2BGR</span><span class="p">)</span>
        
        <span class="c1"># Apply Gaussian blur to reduce noise</span>
        <span class="n">flow_vis</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">GaussianBlur</span><span class="p">(</span><span class="n">flow_vis</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">alpha</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Update the background model using running average</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">accumulateWeighted</span><span class="p">(</span><span class="n">frame_gray</span><span class="p">,</span> <span class="n">background_model</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
            <span class="n">background_mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">convertScaleAbs</span><span class="p">(</span><span class="n">background_model</span><span class="p">)</span>
            
            <span class="c1"># Invert the background mask to create a foreground mask</span>
            <span class="n">foreground_mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">absdiff</span><span class="p">(</span><span class="n">frame_gray</span><span class="p">,</span> <span class="n">background_mask</span><span class="p">)</span>
            
            <span class="c1"># Threshold the foreground mask to create a binary mask</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">binary_mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">threshold</span><span class="p">(</span><span class="n">foreground_mask</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">THRESH_BINARY</span><span class="p">)</span>
            
            <span class="c1"># Use the binary_mask to refine the flow visualization</span>
            <span class="c1">#</span>
            
            <span class="n">flow_vis</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">flow_vis</span><span class="p">,</span> <span class="n">flow_vis</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">binary_mask</span><span class="p">)</span>
        
        <span class="c1"># Display x and y displacement as text on the frame</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">flow_vis</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Displacement-VEL MIN , MAX: </span><span class="si">{</span><span class="n">disp_min</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">disp_max</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_SIMPLEX</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="c1">#cv2.putText(flow_vis, f&#39;Y Displacement MIN , MAX: {y_disp_min:.2f} , {y_disp:.2f}&#39;, (10, 70), cv2.FONT_HERSHEY_SIMPLEX, 1, (0, 0, 255), 2)</span>
        
        <span class="c1"># Display x and y displacement as text on the frame</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Displacement-VEL MIN , MAX: </span><span class="si">{</span><span class="n">disp_min</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">disp_max</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_SIMPLEX</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="c1">#cv2.putText(frame, f&#39;Y Displacement MIN , MAX: {y_disp_min:.2f} , {y_disp:.2f}&#39;, (10, 70), cv2.FONT_HERSHEY_SIMPLEX, 1, (0, 0, 255), 2)</span>
        
        <span class="c1"># Normalize the magnitudes to the range [0, 1]</span>
        <span class="n">normalized_magnitudes</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">magnitude</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">norm_type</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">NORM_MINMAX</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">CV_32F</span><span class="p">)</span>

        <span class="c1"># Convert normalized magnitudes to colors using a colormap</span>
        <span class="n">colormap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;hot&#39;</span><span class="p">)</span>  <span class="c1"># You can use other colormaps like &#39;viridis&#39;, &#39;plasma&#39;, etc.</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">(</span><span class="n">colormap</span><span class="p">(</span><span class="n">normalized_magnitudes</span><span class="p">)[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="c1">########################################################################3#</span>
        
        <span class="c1"># Function to update the plot with data from the queue</span>
        <span class="c1"># def update_plot(ax, fig):</span>
        <span class="c1">#     while True:</span>
        <span class="c1">#         fig.subplots_adjust(bottom=0.5, top=0.99, left=0.01, right=0.3)</span>
        <span class="c1">#         # Use the same colormap and normalization range as the image</span>
        <span class="c1">#         norm = plt.Normalize(vmin=magnitude.min(), vmax=magnitude.max())</span>
        <span class="c1">#         cb = plt.colorbar(plt.cm.ScalarMappable(norm=norm, cmap=plt.get_cmap(&#39;hot&#39;)), cax=ax)</span>
        <span class="c1">#         plt.draw()</span>
        <span class="c1">#         plt_img = np.frombuffer(fig.canvas.tostring_rgb(), dtype=np.uint8)</span>
        <span class="c1">#         plt_img = plt_img.reshape(fig.canvas.get_width_height()[::-1] + (3,))</span>
        <span class="c1">#         plt_img = cv2.cvtColor(plt_img, cv2.COLOR_RGB2BGR)</span>

        <span class="c1">#         # Resize the colorbar to match the image height</span>
        <span class="c1">#         colorbar = cv2.resize(plt_img, (magnitude.shape[1]//10, magnitude.shape[0]))</span>
        <span class="c1">#         plt.pause(0.1)</span>
        <span class="c1"># Create a colorbar using matplotlib</span>
       
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
       
       
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="c1"># Use the same colormap and normalization range as the image</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">magnitude</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">magnitude</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;hot&#39;</span><span class="p">)),</span> <span class="n">cax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="c1"># Add label and tick marks to the colorbar</span>
        <span class="c1">#cb.set_label(&#39;Displacement&#39;, labelpad=-32, y=0.5, rotation=-90)</span>
        <span class="n">ticks</span> <span class="o">=</span> <span class="p">[</span><span class="n">magnitude</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">magnitude</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">magnitude</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span> <span class="n">magnitude</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">/</span><span class="mi">6</span><span class="p">,</span> <span class="n">magnitude</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>
        <span class="n">cb</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

        <span class="c1"># Convert plt figure to numpy array and then to a cv2 image</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="n">plt_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">tostring_rgb</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">plt_img</span> <span class="o">=</span> <span class="n">plt_img</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">get_width_height</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">3</span><span class="p">,))</span>
        <span class="n">plt_img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">plt_img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_RGB2BGR</span><span class="p">)</span>

        <span class="c1"># Resize the colorbar to match the image height</span>
        <span class="n">colorbar</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">plt_img</span><span class="p">,</span> <span class="p">(</span><span class="n">frame_width</span><span class="o">//</span><span class="mi">10</span><span class="p">,</span> <span class="n">frame_height</span><span class="p">))</span>

        <span class="c1">##########################</span>
        
        
        <span class="c1">#######################</span>
        <span class="kn">import</span> <span class="nn">matplotlib</span>
        


        <span class="c1">#Convert frame datetimes to matplotlib-compatible format</span>
        <span class="n">datetimes</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">dates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">frame_datetimes</span><span class="p">)</span>

       <span class="c1"># Create a figure and two subplots for min and max displacements</span>
        <span class="n">fig2</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

        <span class="c1"># Plot minimum displacement with a blue line</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">datetimes</span><span class="p">,</span> <span class="n">min_displacements</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Min Displacement&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>

        <span class="c1"># Plot maximum displacement with a red line</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">datetimes</span><span class="p">,</span> <span class="n">max_displacements</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Max Displacement&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">)</span>
        
        <span class="c1"># Plot maximum displacement with a red line</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">datetimes</span><span class="p">,</span> <span class="n">mean_displacement</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Mean Displacement&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">)</span>

        <span class="c1"># Set labels for both y-axes</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Displacement&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">)</span>

        <span class="c1"># Add a title</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Minimum and Maximum Displacement Over Time in Pixel Unit&#39;</span><span class="p">)</span>

        <span class="c1"># Add a legend in the top right corner</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>

        <span class="c1"># Format the x-axis as datetime</span>
        <span class="c1"># Format the x-axis as datetime</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">dates</span><span class="o">.</span><span class="n">DateFormatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">:%m:%y-%H:%M:%S&#39;</span><span class="p">))</span>

        <span class="c1"># Rotate the x-axis labels for better readability</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>

        <span class="c1"># Add grid lines</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>


       
        <span class="c1"># Adjust the plot layout</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">h_pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">w_pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

        <span class="c1"># Save the plot as an image</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;plot.png&#39;</span><span class="p">)</span>

        <span class="c1">#plt.close()</span>

        <span class="c1"># Open and show the plot using OpenCV</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s1">&#39;plot.png&#39;</span><span class="p">)</span>
        <span class="c1"># cv2.imshow(&#39;Plot&#39;, image)</span>
        <span class="c1"># cv2.waitKey(0)</span>
        <span class="c1"># cv2.destroyAllWindows()</span>

        <span class="c1"># Show the plot</span>
        <span class="c1">#plt.tight_layout()</span>
        <span class="c1">#plt.show()</span>
        <span class="c1">#Convert plt figure to numpy array and then to a cv2 image</span>
        <span class="c1"># fig2.canvas.draw()</span>
        <span class="c1"># plt_img2 = np.frombuffer(fig2.canvas.tostring_rgb(), dtype=np.uint8)</span>
        <span class="c1"># plt_img2 = plt_img2.reshape(fig2.canvas.get_width_height()[::-1] + (3,))</span>
        <span class="c1"># plt_img2= cv2.cvtColor(plt_img2, cv2.COLOR_RGB2BGR)</span>
        <span class="c1">#  # Resize the colorbar to match the image height</span>
        <span class="n">minmax_plot</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="n">frame_width</span><span class="p">,</span> <span class="n">frame_height</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c1">#####################################</span>
        <span class="c1"># Display motion vectors as arrows</span>
        <span class="n">step</span> <span class="o">=</span> <span class="mi">20</span>  <span class="c1"># Arrow spacing</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">step</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">step</span><span class="p">):</span>
                <span class="n">fx</span><span class="p">,</span> <span class="n">fy</span> <span class="o">=</span> <span class="n">flow</span><span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span>
                <span class="c1"># Calculate the magnitude of the flow vector</span>
                <span class="n">flow_magnitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">fx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">fy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

                <span class="c1"># Calculate the end point of the arrow based on flow magnitude</span>
                <span class="n">end_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">fx</span><span class="p">)</span>
                <span class="n">end_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="n">fy</span><span class="p">)</span>

                <span class="c1"># Scale the line length based on the flow magnitude</span>
                <span class="n">scaled_end_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">fx</span> <span class="o">*</span> <span class="n">flow_magnitude</span><span class="p">)</span>
                <span class="n">scaled_end_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="n">fy</span> <span class="o">*</span> <span class="n">flow_magnitude</span><span class="p">)</span>
                
                <span class="n">color</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">colors</span><span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">]))</span>

                <span class="c1"># Draw the arrowed line</span>
                <span class="n">cv2</span><span class="o">.</span><span class="n">arrowedLine</span><span class="p">(</span><span class="n">flow_vis</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="p">(</span><span class="n">scaled_end_x</span><span class="p">,</span> <span class="n">scaled_end_y</span><span class="p">),</span> <span class="n">color</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                
        <span class="c1"># Display motion vectors as arrows</span>
        <span class="n">step</span> <span class="o">=</span> <span class="mi">20</span>  <span class="c1"># Arrow spacing</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">step</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">step</span><span class="p">):</span>
                <span class="n">fx</span><span class="p">,</span> <span class="n">fy</span> <span class="o">=</span> <span class="n">flow</span><span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span>
                <span class="c1"># Calculate the magnitude of the flow vector</span>
                <span class="n">flow_magnitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">fx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">fy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

                <span class="c1"># Calculate the end point of the arrow based on flow magnitude</span>
                <span class="n">end_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">fx</span><span class="p">)</span> 
                <span class="n">end_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="n">fy</span><span class="p">)</span>

                <span class="c1"># Scale the line length based on the flow magnitude</span>
                <span class="n">scaled_end_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">fx</span> <span class="o">*</span> <span class="n">flow_magnitude</span><span class="p">)</span>
                <span class="n">scaled_end_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="n">fy</span> <span class="o">*</span> <span class="n">flow_magnitude</span><span class="p">)</span>
                <span class="n">color</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">colors</span><span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">]))</span>
                <span class="c1"># Draw the arrowed line</span>
                <span class="n">cv2</span><span class="o">.</span><span class="n">arrowedLine</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="p">(</span><span class="n">scaled_end_x</span><span class="p">,</span> <span class="n">scaled_end_y</span><span class="p">),</span> <span class="n">color</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="n">magnitude</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">magnitude</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">NORM_MINMAX</span><span class="p">)</span>
                
        <span class="n">colored_magnitude</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">applyColorMap</span><span class="p">(</span><span class="n">flow_vis</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLORMAP_HOT</span><span class="p">)</span>
        
        

        
        <span class="c1"># Combine the image with the colorbar</span>
        <span class="n">combined_frame</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">frame</span><span class="p">,</span> <span class="n">colorbar</span><span class="p">))</span>
        <span class="n">combined_frame</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">combined_frame</span><span class="p">,</span> <span class="n">colored_magnitude</span><span class="p">))</span>
        <span class="n">combined_mag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">colored_magnitude</span><span class="p">,</span> <span class="n">colorbar</span><span class="p">))</span>
        <span class="n">combined_mag1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">combined_mag</span><span class="p">,</span> <span class="n">minmax_plot</span><span class="p">))</span>
        
        <span class="c1"># Draw the window on the frame</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">combined_frame</span><span class="p">,</span> <span class="p">(</span><span class="n">window_x</span><span class="p">,</span> <span class="n">window_y</span><span class="p">),</span> <span class="p">(</span><span class="n">window_x</span><span class="o">+</span><span class="n">window_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">window_y</span><span class="o">+</span><span class="n">window_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="mi">5</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">LINE_AA</span><span class="p">)</span>
        <span class="c1"># Draw the window on the frame</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">combined_mag1</span><span class="p">,</span> <span class="p">(</span><span class="n">window_x</span><span class="p">,</span> <span class="n">window_y</span><span class="p">),</span> <span class="p">(</span><span class="n">window_x</span><span class="o">+</span><span class="n">window_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">window_y</span><span class="o">+</span><span class="n">window_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="mi">5</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">LINE_AA</span><span class="p">)</span>
               
        <span class="c1">#combined_frame = np.hstack((combined_frame, colorbar))</span>
        
        <span class="c1"># send frame to streamer</span>
        <span class="c1"># if streamer_option==&#39;mag&#39;:</span>
        <span class="c1">#     streamer_mag.stream(combined_mag)</span>
        <span class="c1"># else:</span>
        <span class="c1">#     # send frame to streamer</span>
        <span class="c1">#     streamer1.stream(combined_frame)</span>
        
        <span class="c1"># Display frames and motion information</span>
        <span class="k">if</span> <span class="n">show_video</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;Frames&#39;</span><span class="p">,</span> <span class="n">combined_frame</span><span class="p">)</span>
            <span class="n">vid</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;Optical Flow&#39;</span><span class="p">,</span> <span class="n">combined_mag1</span><span class="p">)</span>
        
        
       
        
        <span class="c1"># Check if saving output is enabled</span>
        <span class="k">if</span> <span class="n">save_output</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">combined_mag1</span><span class="p">)</span>
            <span class="n">out1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">combined_frame</span><span class="p">)</span>
            
        
        <span class="k">if</span> <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">):</span>
            <span class="k">break</span>
    
        
        <span class="k">yield</span> <span class="p">[</span><span class="n">minmax_plot</span> <span class="p">,</span> <span class="n">combined_frame</span><span class="p">]</span>
         
        <span class="c1"># Release the VideoWriter object if it was created</span>
        <span class="k">if</span> <span class="n">save_output</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        
        <span class="c1"># # Apply the mask to both x_displacement and y_displacement</span>
        <span class="c1"># masked_x_displacement = [x_disp * binary_mask[frame_index // 2] for frame_index, x_disp in enumerate(x_displacement)]</span>
        <span class="c1"># masked_y_displacement = [y_disp * binary_mask[frame_index // 2] for frame_index, y_disp in enumerate(y_displacement)]</span>
    <span class="n">cap</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>
    
    <span class="c1"># safely close video stream</span>
    <span class="c1"># stream1.stop()</span>
    <span class="c1"># stream2.stop()</span>

    <span class="c1"># safely close streamer</span>
    <span class="c1"># streamer1.terminate()</span>
    <span class="c1"># streamer_mag.terminate()</span>
    
    
    <span class="k">del</span> <span class="n">fig</span>
    <span class="k">del</span> <span class="n">fig2</span></div>

     
<span class="c1">############################################</span>

<span class="c1">############################## The below program works to save the processing video into video file#############</span>

<span class="c1"># Function to measure displacement using Dense Optical Flow</span>
<div class="viewcode-block" id="measure_displacement_from_camera_toFile">
<a class="viewcode-back" href="../../akhdefo_functions.html#akhdefo_functions.Akhdefo_utils.measure_displacement_from_camera_toFile">[docs]</a>
<span class="k">def</span> <span class="nf">measure_displacement_from_camera_toFile</span><span class="p">(</span><span class="n">hls_url</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">save_output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">output_filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ssim_threshold</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> 
                                     <span class="n">pyr_scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">winsize</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span><span class="n">iterations</span><span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">poly_n</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">poly_sigma</span><span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="mi">1</span> <span class="p">,</span> <span class="n">show_video</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Test data URLs; hls_url = &quot;https://chiefcam.com/resources/video/events/september-2021-rockfall/september-2021-rockfall-1080p.mp4&quot; or &quot;https://chiefcam.com/video/hls/live/1080p/index.m3u8&quot;</span>
<span class="sd">    </span>
<span class="sd">    Measure the displacement from the camera feed using Dense Optical Flow.</span>


<span class="sd">    Parameters:</span>
<span class="sd">    ------------</span>
<span class="sd">    </span>
<span class="sd">    hls_url: str</span>
<span class="sd">        The URL of the HLS video stream. or type 0 to process video from live pc webcam or add path to your video</span>
<span class="sd">    </span>
<span class="sd">    alpha: float, optional</span>
<span class="sd">        The weight of the image to update the background model, default is 0.1.</span>
<span class="sd">        </span>
<span class="sd">    save_output : bool, optional</span>
<span class="sd">        Flag to save the output, default is False.</span>
<span class="sd">    output_filename : str, optional</span>
<span class="sd">        The filename for saving the output video, required if save_output is True.</span>
<span class="sd">    ssim_threshold: float , default 0.4</span>
<span class="sd">        if interetesed to identify rockfalls recommended value is 0.5 or less.</span>
<span class="sd">        </span>
<span class="sd">    pyr_scale: float</span>
<span class="sd">        parameter, specifying the image scale (&lt;1) to build pyramids for each image; pyr_scale=0.5 means a classical pyramid, where each next layer is twice smaller than the previous one.</span>
<span class="sd">    levels: int</span>
<span class="sd">        number of pyramid layers including the initial image; levels=1 means that no extra layers are created and only the original images are used.</span>
<span class="sd">    winsize: int</span>
<span class="sd">        averaging window size; larger values increase the algorithm robustness to image noise and give more chances for fast motion detection, but yield more blurred motion field.</span>
<span class="sd">    iterations: int</span>
<span class="sd">        number of iterations the algorithm does at each pyramid level.</span>
<span class="sd">    poly_n: int</span>
<span class="sd">        size of the pixel neighborhood used to find polynomial expansion in each pixel; </span>
<span class="sd">        larger values mean that the image will be approximated with smoother surfaces, </span>
<span class="sd">        yielding more robust algorithm and more blurred motion field, typically poly_n =5 or 7.</span>
<span class="sd">    poly_sigma: float</span>
<span class="sd">        standard deviation of the Gaussian that is used to smooth derivatives used as a basis for the polynomial expansion; </span>
<span class="sd">        for poly_n=5, you can set poly_sigma=1.1, for poly_n=7, a good value would be poly_sigma=1.5.</span>
<span class="sd">    flags: 0 or 1</span>
<span class="sd">        operation flags that can be a combination of the following:</span>
<span class="sd">        0 OPTFLOW_USE_INITIAL_FLOW uses the input flow as an initial flow approximation.</span>
<span class="sd">        1 OPTFLOW_FARNEBACK_GAUSSIAN uses the Gaussian winsize×winsize filter instead of a box filter of the same size for optical flow estimation; </span>
<span class="sd">        usually, this option gives z more accurate flow than with a box filter, at the cost of lower speed; </span>
<span class="sd">        normally, winsize for a Gaussian window should be set to a larger value to achieve the same level of robustness.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    ---------- </span>
<span class="sd">        Video output with motion vectors and magnitude.</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">import</span> <span class="nn">matplotlib</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;Agg&#39;</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">cv2</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
    <span class="kn">import</span> <span class="nn">subprocess</span>
    <span class="kn">from</span> <span class="nn">skimage.metrics</span> <span class="kn">import</span> <span class="n">structural_similarity</span> <span class="k">as</span> <span class="n">ssim</span>
    <span class="c1"># import required libraries</span>
    <span class="c1"># from vidgear.gears import CamGear</span>
    <span class="c1"># from vidgear.gears import StreamGear</span>
    <span class="kn">import</span> <span class="nn">queue</span>
    <span class="kn">import</span> <span class="nn">time</span>
    <span class="c1"># Set the new dimensions for resizing</span>
    <span class="n">new_width</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">new_height</span> <span class="o">=</span> <span class="mi">600</span>
    
    <span class="n">cap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="n">hls_url</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cap</span><span class="o">.</span><span class="n">isOpened</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: Couldn&#39;t open camera.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    
    <span class="c1"># Check if saving output is enabled</span>
    <span class="k">if</span> <span class="n">save_output</span><span class="p">:</span>
        <span class="c1"># Get the frames&#39; width, height, and frame rate</span>
        <span class="n">frame_width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
        <span class="n">frame_height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
        <span class="n">frame_rate</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
        
        <span class="c1"># Define the codec and create a VideoWriter object</span>
        <span class="n">fourcc</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoWriter_fourcc</span><span class="p">(</span><span class="o">*</span><span class="s1">&#39;XVID&#39;</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoWriter</span><span class="p">(</span><span class="n">output_filename</span><span class="p">,</span> <span class="n">fourcc</span><span class="p">,</span> <span class="n">frame_rate</span><span class="p">,</span> <span class="p">(</span><span class="n">frame_width</span> <span class="o">+</span> <span class="n">frame_width</span><span class="o">//</span><span class="mi">10</span><span class="p">,</span> <span class="n">frame_height</span><span class="p">))</span>
        <span class="n">out1</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoWriter</span><span class="p">(</span><span class="n">output_filename</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;_1.mp4&quot;</span><span class="p">,</span> <span class="n">fourcc</span><span class="p">,</span> <span class="n">frame_rate</span><span class="p">,</span> <span class="p">(</span><span class="n">frame_width</span> <span class="o">+</span><span class="n">frame_width</span><span class="o">//</span><span class="mi">10</span><span class="p">,</span> <span class="n">frame_height</span><span class="p">))</span>
    
    <span class="n">ret</span><span class="p">,</span> <span class="n">prev_frame</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    
    <span class="c1"># Resize the frame to the new dimensions</span>
    <span class="c1">#prev_frame = cv2.resize(prev_frame, (new_width, new_height))</span>
    <span class="n">prev_frame</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">prev_frame</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
    
    <span class="n">total_displacement</span> <span class="o">=</span> <span class="mf">0.0</span>
    
    <span class="c1"># Initialize the background model as the first frame</span>
    <span class="n">background_model</span> <span class="o">=</span> <span class="n">prev_frame</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    
    <span class="n">x_displacement</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">y_displacement</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="n">frame_count</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="n">prev_displacement</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">ret</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="c1"># Resize the frame to the new dimensions</span>
        <span class="c1">#frame = cv2.resize(frame, (new_width, new_height))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ret</span><span class="p">:</span>
            <span class="k">break</span>
        
        <span class="n">frame_gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
        
        <span class="n">similarity_index</span><span class="p">,</span> <span class="n">ssim_map</span> <span class="o">=</span> <span class="n">ssim</span><span class="p">(</span><span class="n">prev_frame</span><span class="p">,</span> <span class="n">frame_gray</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="c1"># Calculate dense optical flow</span>
        <span class="n">flow</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">calcOpticalFlowFarneback</span><span class="p">(</span><span class="n">prev_frame</span><span class="p">,</span> <span class="n">frame_gray</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">pyr_scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">winsize</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span><span class="n">iterations</span><span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">poly_n</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">poly_sigma</span><span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># Calculate displacement magnitude</span>
        <span class="n">displacement</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">flow</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">flow</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="c1"># Adjust ksize and sigmaX based on the level of noise in your image</span>
        <span class="c1">#displacement = cv2.GaussianBlur(displacement, (5, 5), 0)</span>
        
        
        
        <span class="c1">##########</span>
        
       
        
        <span class="n">prev_frame</span> <span class="o">=</span> <span class="n">frame_gray</span>
        
        <span class="n">frame_count</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c1"># Create an HSV image for visualizing the flow</span>
        <span class="n">hsv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="n">hsv</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span>
        
        <span class="c1"># Calculate angle and magnitude for flow visualization</span>
        <span class="c1">#angle = np.arctan2(flow[..., 1], flow[..., 0])</span>
        <span class="c1">#magnitude = cv2.normalize(displacement, None, 0, 255, cv2.NORM_MINMAX)</span>
        <span class="c1">#magnitude=displacement</span>
        
        <span class="c1">#magnitude, angle = cv2.cartToPolar(cv2.medianBlur(flow[..., 0], 3), cv2.medianBlur(flow[..., 1], 3))</span>
        <span class="n">magnitude</span><span class="p">,</span> <span class="n">angle</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cartToPolar</span><span class="p">(</span><span class="n">flow</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">flow</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        
        <span class="c1"># Calculate x and y displacement components</span>
        <span class="n">x_disp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">flow</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">y_disp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">flow</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        
        <span class="n">x_disp_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">flow</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">y_disp_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">flow</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        
        <span class="n">disp_min</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">magnitude</span><span class="p">)</span>
        <span class="n">disp_max</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">magnitude</span><span class="p">)</span>
        
        <span class="c1"># Append the displacement components to the lists</span>
        <span class="n">x_displacement</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_disp</span><span class="p">)</span>
        <span class="n">y_displacement</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_disp</span><span class="p">)</span>
        
        <span class="c1"># Sum up the displacement in the entire frame</span>
        <span class="n">total_displacement</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">displacement</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ssim_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
           
            <span class="n">magnitude</span><span class="p">[</span><span class="n">ssim_map</span> <span class="o">&gt;</span> <span class="n">ssim_threshold</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
            <span class="n">angle</span><span class="p">[</span><span class="n">ssim_map</span> <span class="o">&gt;</span> <span class="n">ssim_threshold</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
            <span class="c1"># else:</span>
                
            <span class="c1">#     magnitude[ssim_map &lt; ssim_threshold]=0</span>
            <span class="c1">#     angle[ssim_map &lt; ssim_threshold]=0</span>
        
        
        <span class="c1"># Set hue according to the direction of motion</span>
        <span class="n">hsv</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">angle</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        
        <span class="c1"># Set value (brightness) according to the magnitude of motion</span>
        <span class="n">hsv</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">magnitude</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">NORM_MINMAX</span><span class="p">)</span>
        
        <span class="c1"># Convert HSV to BGR for display</span>
        <span class="n">flow_vis</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">hsv</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_HSV2BGR</span><span class="p">)</span>
        
        <span class="c1"># Apply Gaussian blur to reduce noise</span>
        <span class="n">flow_vis</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">GaussianBlur</span><span class="p">(</span><span class="n">flow_vis</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">alpha</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Update the background model using running average</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">accumulateWeighted</span><span class="p">(</span><span class="n">frame_gray</span><span class="p">,</span> <span class="n">background_model</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
            <span class="n">background_mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">convertScaleAbs</span><span class="p">(</span><span class="n">background_model</span><span class="p">)</span>
            
            <span class="c1"># Invert the background mask to create a foreground mask</span>
            <span class="n">foreground_mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">absdiff</span><span class="p">(</span><span class="n">frame_gray</span><span class="p">,</span> <span class="n">background_mask</span><span class="p">)</span>
            
            <span class="c1"># Threshold the foreground mask to create a binary mask</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">binary_mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">threshold</span><span class="p">(</span><span class="n">foreground_mask</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">THRESH_BINARY</span><span class="p">)</span>
            
            <span class="c1"># Use the binary_mask to refine the flow visualization</span>
            <span class="c1">#</span>
            
            <span class="n">flow_vis</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">flow_vis</span><span class="p">,</span> <span class="n">flow_vis</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">binary_mask</span><span class="p">)</span>
        
        <span class="c1"># Display x and y displacement as text on the frame</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">flow_vis</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Displacement-VEL MIN , MAX: </span><span class="si">{</span><span class="n">disp_min</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">disp_max</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_SIMPLEX</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="c1">#cv2.putText(flow_vis, f&#39;Y Displacement MIN , MAX: {y_disp_min:.2f} , {y_disp:.2f}&#39;, (10, 70), cv2.FONT_HERSHEY_SIMPLEX, 1, (0, 0, 255), 2)</span>
        
        <span class="c1"># Display x and y displacement as text on the frame</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Displacement-VEL MIN , MAX: </span><span class="si">{</span><span class="n">disp_min</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">disp_max</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_SIMPLEX</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="c1">#cv2.putText(frame, f&#39;Y Displacement MIN , MAX: {y_disp_min:.2f} , {y_disp:.2f}&#39;, (10, 70), cv2.FONT_HERSHEY_SIMPLEX, 1, (0, 0, 255), 2)</span>
        
        <span class="c1"># Normalize the magnitudes to the range [0, 1]</span>
        <span class="n">normalized_magnitudes</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">magnitude</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">norm_type</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">NORM_MINMAX</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">CV_32F</span><span class="p">)</span>

        <span class="c1"># Convert normalized magnitudes to colors using a colormap</span>
        <span class="n">colormap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;hot&#39;</span><span class="p">)</span>  <span class="c1"># You can use other colormaps like &#39;viridis&#39;, &#39;plasma&#39;, etc.</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">(</span><span class="n">colormap</span><span class="p">(</span><span class="n">normalized_magnitudes</span><span class="p">)[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="c1">########################################################################3#</span>
        <span class="c1"># Create a colorbar using matplotlib</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="c1"># Use the same colormap and normalization range as the image</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">magnitude</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">magnitude</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;hot&#39;</span><span class="p">)),</span> <span class="n">cax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="c1"># Add label and tick marks to the colorbar</span>
        <span class="c1">#cb.set_label(&#39;Displacement&#39;, labelpad=-32, y=0.5, rotation=-90)</span>
        <span class="c1">#ticks = [magnitude.min(), magnitude.max()/2, magnitude.max()/4, magnitude.max()/6, magnitude.max()]</span>
        <span class="c1">#cb.set_ticks(ticks)</span>
        <span class="c1">#plt.axis(&#39;off&#39;)</span>

        <span class="c1"># Convert plt figure to numpy array and then to a cv2 image</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="n">plt_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">tostring_rgb</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">plt_img</span> <span class="o">=</span> <span class="n">plt_img</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">get_width_height</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">3</span><span class="p">,))</span>
        <span class="n">plt_img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">plt_img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_RGB2BGR</span><span class="p">)</span>

        <span class="c1"># Resize the colorbar to match the image height</span>
        <span class="n">colorbar</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">plt_img</span><span class="p">,</span> <span class="p">(</span><span class="n">magnitude</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="mi">10</span><span class="p">,</span> <span class="n">magnitude</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        
        
        <span class="c1">#####################################</span>
        <span class="c1"># Display motion vectors as arrows</span>
        <span class="n">step</span> <span class="o">=</span> <span class="mi">20</span>  <span class="c1"># Arrow spacing</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">step</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">step</span><span class="p">):</span>
                <span class="n">fx</span><span class="p">,</span> <span class="n">fy</span> <span class="o">=</span> <span class="n">flow</span><span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span>
                <span class="c1"># Calculate the magnitude of the flow vector</span>
                <span class="n">flow_magnitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">fx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">fy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

                <span class="c1"># Calculate the end point of the arrow based on flow magnitude</span>
                <span class="n">end_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">fx</span><span class="p">)</span>
                <span class="n">end_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="n">fy</span><span class="p">)</span>

                <span class="c1"># Scale the line length based on the flow magnitude</span>
                <span class="n">scaled_end_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">fx</span> <span class="o">*</span> <span class="n">flow_magnitude</span><span class="p">)</span>
                <span class="n">scaled_end_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="n">fy</span> <span class="o">*</span> <span class="n">flow_magnitude</span><span class="p">)</span>
                
                <span class="n">color</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">colors</span><span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">]))</span>

                <span class="c1"># Draw the arrowed line</span>
                <span class="n">cv2</span><span class="o">.</span><span class="n">arrowedLine</span><span class="p">(</span><span class="n">flow_vis</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="p">(</span><span class="n">scaled_end_x</span><span class="p">,</span> <span class="n">scaled_end_y</span><span class="p">),</span> <span class="n">color</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                
        <span class="c1"># Display motion vectors as arrows</span>
        <span class="n">step</span> <span class="o">=</span> <span class="mi">20</span>  <span class="c1"># Arrow spacing</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">step</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">step</span><span class="p">):</span>
                <span class="n">fx</span><span class="p">,</span> <span class="n">fy</span> <span class="o">=</span> <span class="n">flow</span><span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span>
                <span class="c1"># Calculate the magnitude of the flow vector</span>
                <span class="n">flow_magnitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">fx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">fy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

                <span class="c1"># Calculate the end point of the arrow based on flow magnitude</span>
                <span class="n">end_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">fx</span><span class="p">)</span> 
                <span class="n">end_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="n">fy</span><span class="p">)</span>

                <span class="c1"># Scale the line length based on the flow magnitude</span>
                <span class="n">scaled_end_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">fx</span> <span class="o">*</span> <span class="n">flow_magnitude</span><span class="p">)</span>
                <span class="n">scaled_end_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="n">fy</span> <span class="o">*</span> <span class="n">flow_magnitude</span><span class="p">)</span>
                <span class="n">color</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">colors</span><span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">]))</span>
                <span class="c1"># Draw the arrowed line</span>
                <span class="n">cv2</span><span class="o">.</span><span class="n">arrowedLine</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="p">(</span><span class="n">scaled_end_x</span><span class="p">,</span> <span class="n">scaled_end_y</span><span class="p">),</span> <span class="n">color</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="n">magnitude</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">displacement</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">NORM_MINMAX</span><span class="p">)</span>
        <span class="c1"># Convert the float data to uint8</span>
        <span class="n">gray_image</span> <span class="o">=</span> <span class="n">magnitude</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>
        
        <span class="n">colored_magnitude</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">applyColorMap</span><span class="p">(</span><span class="n">flow_vis</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLORMAP_HOT</span><span class="p">)</span>
        
        <span class="c1"># Combine the image with the colorbar</span>
        <span class="n">combined_mag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">colored_magnitude</span><span class="p">,</span> <span class="n">colorbar</span><span class="p">))</span>
        <span class="n">combined_frame</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">frame</span><span class="p">,</span> <span class="n">colorbar</span><span class="p">))</span>
        
        <span class="c1"># Display frames and motion information</span>
        <span class="k">if</span> <span class="n">show_video</span><span class="p">:</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;Frames&#39;</span><span class="p">,</span> <span class="n">combined_frame</span><span class="p">)</span>
            <span class="n">vid</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;Optical Flow&#39;</span><span class="p">,</span> <span class="n">combined_mag</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="c1"># Check if saving output is enabled</span>
        <span class="k">if</span> <span class="n">save_output</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">combined_mag</span><span class="p">)</span>
            <span class="n">out1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">combined_frame</span><span class="p">)</span>
            
        
        <span class="k">if</span> <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">):</span>
            <span class="k">break</span>
    
    
    
    <span class="c1"># Release the VideoWriter object if it was created</span>
    <span class="k">if</span> <span class="n">save_output</span><span class="p">:</span>
        <span class="n">out</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
    
    <span class="c1"># # Apply the mask to both x_displacement and y_displacement</span>
    <span class="c1"># masked_x_displacement = [x_disp * binary_mask[frame_index // 2] for frame_index, x_disp in enumerate(x_displacement)]</span>
    <span class="c1"># masked_y_displacement = [y_disp * binary_mask[frame_index // 2] for frame_index, y_disp in enumerate(y_displacement)]</span>
    <span class="n">cap</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">vid</span></div>



<span class="c1">##########################################</span>

<span class="kn">from</span> <span class="nn">osgeo</span> <span class="kn">import</span> <span class="n">gdal</span><span class="p">,</span> <span class="n">osr</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">box</span>

<div class="viewcode-block" id="calculate_new_geotransform">
<a class="viewcode-back" href="../../akhdefo_functions.html#akhdefo_functions.Akhdefo_utils.calculate_new_geotransform">[docs]</a>
<span class="k">def</span> <span class="nf">calculate_new_geotransform</span><span class="p">(</span><span class="n">overlap_box</span><span class="p">,</span> <span class="n">src_transform</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate a new geotransform matrix based on the overlap of image boundaries.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    ------------</span>
<span class="sd">    - overlap_box (shapely.geometry.Polygon): The overlapping bounding box of all valid images.</span>
<span class="sd">    - src_transform (tuple): The source geotransform matrix to be modified.</span>

<span class="sd">    Returns:</span>
<span class="sd">    ---------</span>
<span class="sd">    - tuple: A new geotransform matrix corresponding to the overlap_box.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">overlap_box</span><span class="o">.</span><span class="n">bounds</span>
    <span class="n">new_transform</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">src_transform</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">src_transform</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">src_transform</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">src_transform</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">new_transform</span></div>


<div class="viewcode-block" id="crop_to_overlap">
<a class="viewcode-back" href="../../akhdefo_functions.html#akhdefo_functions.Akhdefo_utils.crop_to_overlap">[docs]</a>
<span class="k">def</span> <span class="nf">crop_to_overlap</span><span class="p">(</span><span class="n">folder_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Crop all valid image files in the specified folder to the overlapping area.</span>

<span class="sd">    This function performs the following steps:</span>
<span class="sd">    1. Iterate through all files in the folder and identify valid image files.</span>
<span class="sd">    2. Calculate the overlapping bounding box of all valid images.</span>
<span class="sd">    3. Crop each valid image to the overlapping bounding box.</span>
<span class="sd">    4. Overwrite the original image files with the cropped images.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    ------------</span>
<span class="sd">    - folder_path (str): The path to the folder containing the image files to be cropped.</span>

<span class="sd">    Notes:</span>
<span class="sd">    -------</span>
<span class="sd">    - Supports &#39;.tif&#39;, &#39;.jpg&#39;, &#39;.png&#39;, and &#39;.bmp&#39; file formats.</span>
<span class="sd">    - Requires GDAL, OSR, and Shapely libraries.</span>
<span class="sd">    - The folder should contain images that share the same spatial reference system (projection).</span>

<span class="sd">    Exceptions are handled for permission errors and unexpected errors during the file overwriting process.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">image_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">))</span>
    <span class="n">valid_extensions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;.png&#39;</span><span class="p">,</span> <span class="s1">&#39;.bmp&#39;</span><span class="p">]</span>
    <span class="n">image_path_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">overlap_box</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">image_files</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">valid_extensions</span><span class="p">:</span>
            <span class="n">image_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">image_path</span><span class="p">,</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GA_ReadOnly</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dataset</span><span class="p">:</span>
                <span class="n">geo_transform</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">GetGeoTransform</span><span class="p">()</span>
                <span class="n">minx</span> <span class="o">=</span> <span class="n">geo_transform</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">maxy</span> <span class="o">=</span> <span class="n">geo_transform</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">maxx</span> <span class="o">=</span> <span class="n">minx</span> <span class="o">+</span> <span class="n">geo_transform</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">dataset</span><span class="o">.</span><span class="n">RasterXSize</span>
                <span class="n">miny</span> <span class="o">=</span> <span class="n">maxy</span> <span class="o">+</span> <span class="n">geo_transform</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">*</span> <span class="n">dataset</span><span class="o">.</span><span class="n">RasterYSize</span>
                <span class="n">image_box</span> <span class="o">=</span> <span class="n">box</span><span class="p">(</span><span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">overlap_box</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">overlap_box</span> <span class="o">=</span> <span class="n">image_box</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">overlap_box</span> <span class="o">=</span> <span class="n">overlap_box</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">image_box</span><span class="p">)</span>

                <span class="n">image_path_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Close the file</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">image_path_list</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No valid image files found.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">for</span> <span class="n">image_path</span> <span class="ow">in</span> <span class="n">image_path_list</span><span class="p">:</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">image_path</span><span class="p">,</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GA_ReadOnly</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dataset</span><span class="p">:</span>
            <span class="n">geo_transform</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">GetGeoTransform</span><span class="p">()</span>
            <span class="n">projection</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">GetProjection</span><span class="p">()</span>
            <span class="n">src_srs</span> <span class="o">=</span> <span class="n">osr</span><span class="o">.</span><span class="n">SpatialReference</span><span class="p">()</span>
            <span class="n">src_srs</span><span class="o">.</span><span class="n">ImportFromWkt</span><span class="p">(</span><span class="n">projection</span><span class="p">)</span>

            <span class="n">new_transform</span> <span class="o">=</span> <span class="n">calculate_new_geotransform</span><span class="p">(</span><span class="n">overlap_box</span><span class="p">,</span> <span class="n">geo_transform</span><span class="p">)</span>
            <span class="n">x_offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">new_transform</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">geo_transform</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">geo_transform</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">y_offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">new_transform</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">geo_transform</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">/</span> <span class="n">geo_transform</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
            <span class="n">x_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">overlap_box</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">overlap_box</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">geo_transform</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">y_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">overlap_box</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">overlap_box</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="o">-</span><span class="n">geo_transform</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>

            <span class="n">band</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Adjust this if your dataset has more bands</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">band</span><span class="o">.</span><span class="n">ReadAsArray</span><span class="p">(</span><span class="n">x_offset</span><span class="p">,</span> <span class="n">y_offset</span><span class="p">,</span> <span class="n">x_size</span><span class="p">,</span> <span class="n">y_size</span><span class="p">)</span>

            <span class="n">temp_output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;temp_</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attempting to create temporary file: </span><span class="si">{</span><span class="n">temp_output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">driver</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GetDriverByName</span><span class="p">(</span><span class="s1">&#39;GTiff&#39;</span><span class="p">)</span>
            <span class="n">out_dataset</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">temp_output_path</span><span class="p">,</span> <span class="n">x_size</span><span class="p">,</span> <span class="n">y_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">band</span><span class="o">.</span><span class="n">DataType</span><span class="p">)</span>
            <span class="n">out_dataset</span><span class="o">.</span><span class="n">SetGeoTransform</span><span class="p">(</span><span class="n">new_transform</span><span class="p">)</span>
            <span class="n">out_dataset</span><span class="o">.</span><span class="n">SetProjection</span><span class="p">(</span><span class="n">src_srs</span><span class="o">.</span><span class="n">ExportToWkt</span><span class="p">())</span>

            <span class="n">out_band</span> <span class="o">=</span> <span class="n">out_dataset</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">out_band</span><span class="o">.</span><span class="n">WriteArray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

            <span class="n">out_band</span><span class="o">.</span><span class="n">FlushCache</span><span class="p">()</span>
            <span class="n">out_dataset</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Close the file</span>

            <span class="n">dataset</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Ensure the dataset is closed and released</span>
            <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Checking existence of temporary file: </span><span class="si">{</span><span class="n">temp_output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># Adjust the sleep time if needed</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">temp_output_path</span><span class="p">):</span>  <span class="c1"># Check if temporary file exists</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Temporary file </span><span class="si">{</span><span class="n">temp_output_path</span><span class="si">}</span><span class="s2"> found.&quot;</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">image_path</span><span class="p">,</span> <span class="mo">0o777</span><span class="p">)</span>  <span class="c1"># Change the permission to read/write for all</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">temp_output_path</span><span class="p">,</span> <span class="n">image_path</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File overwritten at </span><span class="si">{</span><span class="n">image_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Temporary file </span><span class="si">{</span><span class="n">temp_output_path</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">PermissionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Permission error while overwriting </span><span class="si">{</span><span class="n">image_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error while overwriting </span><span class="si">{</span><span class="n">image_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<span class="c1"># # Test the function with your paths</span>
<span class="c1"># input_folder = &#39;geo/flowx&#39;</span>
<span class="c1"># crop_to_overlap(input_folder)</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">Point</span>

<div class="viewcode-block" id="crop_point_shapefile_with_aoi">
<a class="viewcode-back" href="../../akhdefo_functions.html#akhdefo_functions.Akhdefo_utils.crop_point_shapefile_with_aoi">[docs]</a>
<span class="k">def</span> <span class="nf">crop_point_shapefile_with_aoi</span><span class="p">(</span><span class="n">point_shapefile</span><span class="p">,</span> <span class="n">aoi_shapefile</span><span class="p">,</span> <span class="n">output_folder</span><span class="p">):</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Crop a point shapefile with an Area of Interest (AOI) polygon shapefile.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    ------------</span>
<span class="sd">    - point_shapefile (str): Path to the input point shapefile.</span>
<span class="sd">    - aoi_shapefile (str): Path to the AOI polygon shapefile for cropping.</span>
<span class="sd">    - output_folder (str): Path to the folder where the cropped shapefile will be saved.</span>

<span class="sd">    Returns:</span>
<span class="sd">    ---------</span>
<span class="sd">    None</span>

<span class="sd">    This function reads a point shapefile and an AOI polygon shapefile, and performs a spatial</span>
<span class="sd">    intersection to crop the points within the specified AOI. The resulting GeoDataFrame is then</span>
<span class="sd">    saved as a new shapefile in the specified output folder. If no points are within the AOI, no</span>
<span class="sd">    file is created, and a message is printed.</span>

<span class="sd">    Example:</span>
<span class="sd">    ```</span>
<span class="sd">    import akhdefo_functions,</span>
<span class="sd">    from akhdefo_functions import crop_point_shapefile_with_aoi</span>
<span class="sd">    ```</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    ```</span>
<span class="sd">    point_file = &quot;path_to_points.shp&quot;</span>
<span class="sd">    aoi_file = &quot;path_to_aoi.shp&quot;</span>
<span class="sd">    output_folder = &quot;output_folder&quot;</span>
<span class="sd">    ```</span>
<span class="sd">    ```</span>
<span class="sd">    crop_point_shapefile_with_aoi(point_file, aoi_file, output_folder)</span>
<span class="sd">    ```</span>

<span class="sd">    Note:</span>
<span class="sd">    - Requires the GeoPandas library.</span>
<span class="sd">    - The AOI polygon is dissolved into a single geometry for intersection.</span>
<span class="sd">    - Both input GeoDataFrames must have the same Coordinate Reference System (CRS).</span>
<span class="sd">    - The resulting shapefile is saved in the output folder with &quot;_clipped&quot; appended to the filename.</span>
<span class="sd">    - If no points are within the AOI, no file is created, and a message is printed.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    
    <span class="c1"># Read point shapefile</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">point_shapefile</span><span class="p">)</span>
   

    <span class="c1"># Read AOI polygon shapefile</span>
    <span class="n">aoi</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">aoi_shapefile</span><span class="p">)</span>

    <span class="c1"># Dissolve the AOI polygon to a single geometry without specifying &#39;by&#39;</span>
    <span class="n">dissolved_aoi</span> <span class="o">=</span> <span class="n">aoi</span><span class="o">.</span><span class="n">dissolve</span><span class="p">()</span>
    
     <span class="c1"># Ensure both GeoDataFrames have the same CRS</span>
    <span class="n">dissolved_aoi</span> <span class="o">=</span> <span class="n">dissolved_aoi</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">points</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

    <span class="c1"># Use geopandas.overlay to clip points by AOI polygon</span>
    <span class="n">points_in_aoi</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">overlay</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">dissolved_aoi</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;intersection&#39;</span><span class="p">)</span>

    <span class="c1"># Check if the resulting GeoDataFrame is empty</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">points_in_aoi</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="c1"># Create the output folder if it doesn&#39;t exist</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Construct the output shapefile path</span>
        <span class="n">output_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">point_shapefile</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.shp&quot;</span><span class="p">,</span> <span class="s2">&quot;_clipped.shp&quot;</span><span class="p">)</span>
        <span class="n">output_shapefile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">)</span>

        <span class="c1"># Save the clipped points to the output shapefile</span>
        <span class="n">points_in_aoi</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">output_shapefile</span><span class="p">)</span>

       
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The resulting GeoDataFrame is empty. No file will be written.&quot;</span><span class="p">)</span></div>

        

<span class="c1">####################</span>


    

<span class="c1">#################</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
  <span id="sidebar-top"></span>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  
    
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/akhdefo_logo.svg" alt="Logo"/>
            </a></p>
  
<h3>Navigation</h3>
<ul>
  <li><a href="../../index.html">Overview</a>
    <ul>
      <li><a href="../index.html">Module code</a>
        
          
          </ul>
      </li>
    </ul>
  </li>
</ul>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script><div id="ethical-ad-placement"></div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  
    <div class="footer" role="contentinfo">
    &#169; Copyright 2024, Mahmud Mustafa Muhammad.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    </div>
  <script src="../../_static/version_warning_offset.js"></script>

  </body>
</html>